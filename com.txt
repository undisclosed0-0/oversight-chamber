
/* === State and codes === */
const TIER_CODES = {
  Admin: "A-231-GATE",
  MasterAdmin: "M-Q8/-CROWN"
};
const HIDDEN_CODE = "X-719-BOX";

let hiddenPath = false;
let superSequence = [];


/* === On load: hide panels === */
window.addEventListener('DOMContentLoaded', () => {
  hidePanel('adminForm'); 
  hidePanel('colorPanel');
  hidePanel('superCodePanel');
  hidePanel('mysteryBoxChamber');
  hidePanel('puzzleBoxPanel');
  hidePanel('superFormPanel');
});

/* === Helpers === */
function showPanel(id){ const el = document.getElementById(id); if (el) el.style.display = 'block'; }
function hidePanel(id){ const el = document.getElementById(id); if (el) el.style.display = 'none'; }

/* === Verify → show ritual === */
document.getElementById('verifyTierBtn').addEventListener('click', () => {
  if (!adminGateUnlocked) {
    alert('Tap access required. Complete the tap unlock first.');
    return;
  }

  const tier = document.getElementById('adminTier').value;
  const code = document.getElementById('adminCode').value.trim();
  if (!code) { alert('Enter clearance code.'); return; }

  // Reset panels
  hidePanel('colorPanel');
  hidePanel('superCodePanel');
  hidePanel('mysteryBoxChamber');
  hidePanel('puzzleBoxPanel');
  hidePanel('superFormPanel');

  // Exclusive code checks
  if (tier === "Admin" && code === TIER_CODES.Admin) {
    hiddenPath = false;
    superSequence = [];
    showPanel('colorPanel');
    generatePanel();
  } else if (tier === "MasterAdmin" && code === TIER_CODES.MasterAdmin) {
    hiddenPath = false;
    superSequence = [];
    showPanel('colorPanel');
    generatePanel();
  } else if (code === HIDDEN_CODE) {
    hiddenPath = true;
    superSequence = [];
    showPanel('colorPanel');
    generatePanel();
  } else {
    alert('Invalid clearance code for selected tier.');
  }
});

/* === Ritual grid generator === */
function generatePanel(){
  const panel = document.getElementById("panelButtons");
  panel.innerHTML = "";

  const colors = [
    {name:"crimson", bg:"crimson"},
    {name:"violet", bg:"rebeccapurple"},
    {name:"emerald", bg:"seagreen"},
    {name:"amber", bg:"goldenrod"},
    {name:"azure", bg:"royalblue"},
    {name:"iron", bg:"dimgray"},
    {name:"gold", bg:"gold"},
    {name:"moss", bg:"darkolivegreen"},
    {name:"obsidian", bg:"black"}
  ];
  const glyphs = ["⟟","Ϟ","⟁","⧖","ᚠ","ζ","₣","⟊","⚚","♛","⧫"];
  const numbers = ["231","85/","V2ζ","₣2","77X","9Ø","31∆","8.98","27$","719"];

  colors.forEach(c => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "panel-btn";
    btn.dataset.color = c.name;
    btn.style.background = c.bg;
    btn.style.color = "#fff";

    const g1 = glyphs[Math.floor(Math.random()*glyphs.length)];
    const g2 = glyphs[Math.floor(Math.random()*glyphs.length)];
    const num = numbers[Math.floor(Math.random()*numbers.length)];

    btn.textContent = `${g1}${g2} ${num}`;
    btn.addEventListener("click", () => handleSuperClick(c.name));
    panel.appendChild(btn);
  });
}

/* === Required ritual sequence === */
const requiredSequence = [
  'crimson','violet','emerald',
  'amber','azure','iron',
  'gold','moss','obsidian'
];

function handleSuperClick(color){
  superSequence.push(color);
  shimmerPulse();

  if (superSequence.length === requiredSequence.length) {
    const correct = superSequence.join(',') === requiredSequence.join(',');
    superSequence = [];

    if (!correct) {
      alert("Incorrect sequence. Re-enter clearance and try again.");
      hidePanel('colorPanel');
      return;
    }

    hidePanel('colorPanel');
    if (hiddenPath) {
      showPanel('mysteryBoxChamber');
    } else {
      showPanel('superCodePanel');
    }
  }
}

/* === Mystery Box → Puzzle Box === */
document.getElementById('attemptPuzzleBtn').addEventListener('click', () => {
  hidePanel('mysteryBoxChamber');
  showPanel('puzzleBoxPanel');
});

/* === Puzzle Box unlock → Superform === */
let puzzleProgress = [];
const unlockSequence = ['A','C','E']; // your chosen combo

document.querySelectorAll('.cube-face button').forEach(btn => {
  btn.addEventListener('click', () => {
    puzzleProgress.push(btn.dataset.piece);
    if (puzzleProgress.join('') === unlockSequence.join('')) {
      alert("Box unlocked!");
      hidePanel('puzzleBoxPanel');
      showPanel('superFormPanel');
    }
  });
});


/* === Mobile shimmer feedback === */
let shimmerTimer;
function shimmerPulse(){
  const s = document.getElementById('tapShimmer');
  if (!s) return;
  s.classList.add('active');
  clearTimeout(shimmerTimer);
  shimmerTimer = setTimeout(() => s.classList.remove('active'), 260);
}

/* === Tap unlock logic === */
let adminTapSequence = [];
let adminTapResetTimer;

function resetAdminTap(){
  adminTapSequence = [];
  clearTimeout(adminTapResetTimer);
}

function checkAdminMobileUnlock(){
  const correct = ['tapTopLeft','tapTopRight'];
  if (adminTapSequence.join(',') === correct.join(',')) {
    adminGateUnlocked = true;
    showPanel('adminForm');
    shimmerPulse();
    resetAdminTap();
  } else {
    adminTapResetTimer = setTimeout(resetAdminTap, 8000);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const left = document.getElementById('tapTopLeft');
  const right = document.getElementById('tapTopRight');
  if (left) left.addEventListener('click', () => {
    adminTapSequence.push('tapTopLeft');
    shimmerPulse();
    checkAdminMobileUnlock();
  });
  if (right) right.addEventListener('click', () => {
    adminTapSequence.push('tapTopRight');
    shimmerPulse();
    checkAdminMobileUnlock();
  });
});
