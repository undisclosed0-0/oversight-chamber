<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Prestige Hybrid Storefront</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg1:#0f2027; --bg2:#203a43; --bg3:#2c5364;
      --ink:#eaf3ff; --muted:#a8bfd6;
      --blue:#88ccff; --blueDim:#69b9ff;
      --silver:#c0cbd6; --gold:#ffd87a;
      --panel: rgba(30,30,40,0.88);
      --glass: rgba(255,255,255,0.08);
      --radius:14px;
      --shadow:0 18px 40px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font-family:'Cinzel Decorative', serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
    }
    .wrap{ max-width:1160px; margin:0 auto; padding:18px }

    /* Header crest + fa√ßade */
    header.site {
      padding:22px 16px; text-align:center; position:relative;
      background: radial-gradient(640px 280px at 10% 0%, rgba(136,204,255,0.18), transparent);
      box-shadow: 0 0 30px rgba(136,204,255,0.15) inset;
    }
    .brand-title{
      font-size:2.6rem; margin:0;
      color:var(--ink);
      text-shadow: 0 0 20px var(--blue), 0 0 6px var(--blueDim);
    }
    .crest-mark{
      width:56px; height:56px; border-radius:50%; margin:0 auto 8px;
      background: conic-gradient(from 190deg, var(--blue), #aee3ff, var(--blueDim), var(--blue));
      box-shadow: 0 0 26px var(--blue);
    }

    /* Verse + token box + cart */
    .token-box{
      margin:16px auto; max-width:860px; padding:14px 16px;
      border:1px solid var(--blue); border-radius:12px;
      background: var(--glass); text-align:center;
      box-shadow: 0 0 24px rgba(136,204,255,0.25);
    }
    .verse{ font-style:italic; color:var(--ink); margin-bottom:10px }
    .counters{ display:flex; justify-content:center; gap:12px; flex-wrap:wrap; margin-top:8px }
    .counter{
      padding:8px 12px; border-radius:10px; border:1px solid var(--blue);
      background: var(--glass); box-shadow: 0 0 14px rgba(136,204,255,0.25);
    }
    .counter.gold{ border-color: var(--gold); box-shadow: 0 0 16px rgba(255,216,122,0.35); color: var(--gold) }
    .counter.silver{ border-color: var(--silver); box-shadow: 0 0 16px rgba(192,203,214,0.35); color: var(--silver) }
    .cart-btn{
      all:unset; display:inline-block; margin-top:10px; cursor:pointer;
      background:linear-gradient(180deg, #152535, #0f1b29);
      border:1px solid var(--blue); color:var(--ink);
      padding:8px 12px; border-radius:10px;
      box-shadow: 0 0 14px rgba(136,204,255,0.25);
    }

    /* Farce-style first windows row (live/manual submission look) */
    .windows{
      display:grid; grid-template-columns:repeat(4,1fr); gap:12px;
      margin-top:18px;
    }
    .window{
      min-height:150px; position:relative; overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border:1px solid #28435a; border-radius:12px; box-shadow: var(--shadow);
    }
    .window::after{
      content:""; position:absolute; left:0; right:0; bottom:0; height:3px;
      background:linear-gradient(90deg, var(--blue), #aee3ff, var(--blueDim));
      opacity:0.75;
    }
    .tile{
      position:absolute; inset:0; display:flex; align-items:center; gap:12px; padding:12px;
    }
    .tile-art{
      width:70px; height:70px; border-radius:12px;
      background:linear-gradient(135deg, #7a1bd1, #ff2d6b);
      box-shadow:0 10px 26px rgba(122,27,209,0.35);
    }
    .tile-meta{ display:flex; flex-direction:column; gap:6px }
    .tile-title{ font-weight:700 }
    .tile-sub{ color:var(--muted); font-size:13px }
    .badge{
      display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#04131f;
      background:linear-gradient(180deg, var(--blue), #bfe8ff); padding:4px 8px; border-radius:999px; font-weight:700;
    }

    /* Second windows row: chamber directory */
    .windows-dir{ margin-top:16px }
    .dir-card{ padding:12px; text-align:center; border:1px solid #28435a; border-radius:12px; background:var(--glass) }
    .dir-card h3{ margin:6px 0; text-shadow:0 0 8px var(--blue) }
    .dir-card p{ margin:0; color:var(--muted) }
    .dir-card .open{
      display:inline-block; margin-top:8px; padding:6px 10px; border-radius:10px;
      border:1px solid var(--blue); color:#04131f; background:linear-gradient(180deg, var(--blue), #bfe8ff);
      text-decoration:none; font-weight:700;
    }

    /* Chambers (dual panels: left info image/desc, right store) */
    .chamber{
      display:none; margin-top:18px; padding:18px;
      border:2px solid var(--blue); border-radius:var(--radius);
      background:var(--panel); box-shadow: 0 0 24px var(--blue);
    }
    .chamber.active{ display:block }
    .chamber-grid{
      display:grid; grid-template-columns: 1fr 1fr; gap:16px;
    }
    .info-panel, .store-panel{
      border:1px solid #2c4b64; border-radius:12px; background: var(--glass);
      padding:14px;
    }
    .info-img{
      width:100%; height:180px; border-radius:10px; margin-bottom:10px;
      background:linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border:1px solid #325875;
    }
    .store-panel h4{ margin:0 0 10px; text-shadow:0 0 8px var(--blue) }
    .product-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px }
    .product-card{ border:1px solid var(--blue); border-radius:10px; padding:12px; background:#333a; box-shadow:0 0 12px var(--blue) }
    .price{ opacity:.9; margin:6px 0 }
    .status{ font-style:italic; min-height:22px }
    .status.pending{ color:var(--silver); text-shadow:0 0 6px var(--silver) }
    .status.finalized{ color:var(--gold); text-shadow:0 0 6px var(--gold) }

    /* Payment rails (inside Commerce checkout) */
    .checkout{
      margin-top:12px; display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:10px;
    }
    .rail{ border:1px dashed rgba(136,204,255,0.35); border-radius:10px; padding:12px; background:rgba(46,52,70,0.6) }
    .rail strong{ display:block; margin-bottom:6px }

    /* Live feed + reflection + community ad (timers are hook-ready) */
    .lower{
      margin-top:20px; display:grid; grid-template-columns: 2fr 1fr; gap:14px;
    }
    .panel-lite{
      border:1px solid #2c4b64; border-radius:12px; background: var(--glass);
      padding:12px;
    }
    .feed{ display:grid; gap:8px }
    .feed-item{ padding:10px; border-radius:10px; border:1px solid #325875; background:linear-gradient(180deg, rgba(20,26,34,0.9), rgba(12,17,23,0.9)) }
    .ad{ min-height:80px; display:flex; align-items:center; justify-content:center; text-align:center }

    /* Animations */
    @keyframes frostFade{ from{ opacity:0; transform:scale(0.98) } to{ opacity:1; transform:scale(1) } }
    @keyframes voidGlow{
      0%{ box-shadow:0 0 22px rgba(255,216,122,0.24) }
      50%{ box-shadow:0 0 44px rgba(255,238,200,0.5) }
      100%{ box-shadow:0 0 22px rgba(255,216,122,0.24) }
    }
    .frost{ animation:frostFade .8s ease forwards }
    .void{ animation:voidGlow 8s ease-in-out infinite }

    /* Controls */
    .controls{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px }
    .btn{
      all:unset; display:inline-block; cursor:pointer;
      background:linear-gradient(180deg,#152535,#0f1b29); color:var(--ink);
      border:1px solid var(--blue); border-radius:10px; padding:8px 12px; font-weight:700;
      box-shadow:0 0 14px rgba(136,204,255,0.25);
    }

    /* Responsive */
    @media (max-width:960px){ .windows{grid-template-columns:repeat(2,1fr)} .chamber-grid{grid-template-columns:1fr} .lower{grid-template-columns:1fr} }
    @media (max-width:560px){ .windows{grid-template-columns:1fr} .brand-title{font-size:2.2rem} }
 
  .feed-item {
  background: linear-gradient(180deg, rgba(20,26,34,0.9), rgba(12,17,23,0.9));
  border: 1px solid #273242;
  border-radius: 10px;
  padding: 10px 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  animation: fadeSlide 0.6s ease;
}
@keyframes fadeSlide {
  from { opacity: 0; transform: translateY(-6px); }
  to   { opacity: 1; transform: translateY(0); }
}

  .billboard-row {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 16px;
  margin-top: 20px;
}

.billboard-article {
  background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
  border: 1px solid #28435a;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(136,204,255,0.15);
  padding: 14px;
  animation: fadeSlide 0.6s ease;
}

.billboard-image {
  width: 100%;
  height: 140px;
  border-radius: 10px;
  background: #444;
  margin-bottom: 10px;
}

.billboard-title {
  font-weight: 700;
  font-size: 1.1rem;
  margin-bottom: 4px;
}

.billboard-sub {
  font-size: 0.9rem;
  color: #a8bfd6;
  margin-bottom: 6px;
}

.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: bold;
  background: linear-gradient(180deg, #88ccff, #bfe8ff);
  color: #04131f;
}

@keyframes fadeSlide {
  from { opacity: 0; transform: translateY(-10px); }
  to   { opacity: 1; transform: translateY(0); }
}
.emblem-sigil {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-bottom: 8px;
  background: radial-gradient(circle at center, rgba(255,255,255,0.08), rgba(136,204,255,0.15));
  box-shadow: 0 0 12px rgba(136,204,255,0.25);
}

/* Unique shading per method */
.prestige-pay {
  background: linear-gradient(135deg, #ffd87a, #fff2c2);
}
.cod {
  background: linear-gradient(135deg, #88ccff, #d0ecff);
}
.money-order {
  background: linear-gradient(135deg, #c0cbd6, #e2e8f0);
}
.checkout-cart {
  background: linear-gradient(135deg, #aee3ff, #eaf6ff);
}

 .cart-list { display: grid; gap: 12px; margin-top: 12px }
.cart-item {
  padding: 12px;
  border-radius: 10px;
  background: linear-gradient(90deg, #2a2a2a 0%, #3a3a3a 50%, #2a2a2a 100%);
  background-size: 200% 100%;
  animation: shimmerSoft 3s infinite linear;
  color: #e0e0e0;
}

@keyframes shimmerSoft {
  0%   { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
.cart-item {
  border: 1px solid rgba(255,255,255,0.06);
}

.cart-item.finalized {
  background: linear-gradient(135deg, #4a3a1a, #6a4a2a);
  color: #ffd87a;
  border: 1px solid #d6b36a;
  box-shadow: 0 0 12px rgba(255,216,122,0.35);
}

.receipt-confirm {
  font-size: 1.2rem;
  font-weight: bold;
  text-align: center;
  background: linear-gradient(135deg, #4a3a1a, #6a4a2a);
  padding: 12px;
  border-radius: 10px;
  box-shadow: 0 0 18px rgba(255,216,122,0.3);
}inear-gradient(135deg, #ffd87a, #fff2c2);
  border-radius: 12px;
  box-shadow: 0 0 24px rgba(255,216,122,0.35);
}
.info-img.glow {
  background: radial-gradient(circle at center, rgba(255,216,122,0.15), transparent);
  box-shadow: 0 0 30px rgba(255,216,122,0.45);
  border: 2px solid #d6b36a;
  border-radius: 12px;
  padding: 16px;
  color: #ffd87a;
}
.cart-btn {
  position: relative;
  font-size: 1rem;
  padding: 8px 14px;
}

.cart-count {
  position: absolute;
  top: -6px;
  right: 160px;
  background: crimson;
  color: white;
  font-size: 0.8rem;
  font-weight: bold;
  border-radius: 50%;
  padding: 2px 6px;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}
.product-card {
  cursor: pointer;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

.product-card:active {
  transform: scale(0.96); /* slight shrink to simulate press */
  box-shadow: 0 0 6px rgba(0,0,0,0.4) inset; /* inner shadow for depth */
}
.product-card {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  background: #1a1a1a;
  border: 1px solid #444;
  border-radius: 12px;
  padding: 16px;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
  cursor: pointer;
}

.product-card:hover {
  transform: scale(1.02);
  box-shadow: 0 0 12px rgba(136,204,255,0.5);
}

.product-card:active {
  transform: scale(0.96);
  box-shadow: 0 0 6px rgba(0,0,0,0.4) inset;
}

.product-icon {
  height: 80px;
  width: 80px;
  margin: 0 auto 12px;
  background-size: cover;
  background-position: center;
  border-radius: 50%;
  box-shadow: 0 0 8px rgba(255,255,255,0.1);
}
.ring-crest { background-image: url('/assets/ring.png'); } /* example icon class */

.product-meta {
  text-align: center;
  margin-bottom: 8px;
}

.product-title {
  font-weight: bold;
  font-size: 1.1rem;
  margin-bottom: 4px;
}

.product-cost {
  color: #ccc;
  font-size: 0.95rem;
}

.product-status {
  font-size: 0.85rem;
  font-style: italic;
  color: #aaa;
}

.product-action {
  text-align: center;
  font-size: 0.9rem;
  color: #88ccff;
  margin-top: 8px;
}
.product-grid {
  display: flex;
  flex-direction: column;
  gap: 0; /* remove default spacing */
}

.product-card {
  padding: 16px;
  border-bottom: 1px solid rgba(255,255,255,0.08); /* subtle divider */
}

.product-card:last-child {
  border-bottom: none; /* no divider after last card */
}
.feed-item .badge {
  display:inline-block;
  background:#3b82f6; /* blue aura */
  color:#fff;
  font-size:0.75em;
  padding:2px 6px;
  border-radius:6px;
  margin-top:4px;
}
.floating-cart {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(20,26,34,0.85);
  border: 1px solid #28435a;
  border-radius: 12px;
  padding: 10px 16px;
  color: var(--ink);
  font-weight: bold;
  box-shadow: 0 0 18px rgba(136,204,255,0.25);
  z-index: 999;
  animation: frostFade 0.6s ease;
}
.ghost-btn {
  all: unset;
  margin-left: 12px;
  padding: 6px 10px;
  border-radius: 8px;
  background: linear-gradient(180deg, var(--blue), #bfe8ff);
  color: #04131f;
  font-weight: bold;
  cursor: pointer;
}
@keyframes frostFade {
  from { opacity: 0; transform: scale(0.98); }
  to   { opacity: 1; transform: scale(1); }
}
.frost {
  animation: frostFade 0.8s ease forwards;
}
.dir-controls {
  display: flex;
  justify-content: flex-end; /* push buttons to right edge */
  gap: 12px;
  margin-top: 12px;
}

.cer-btn {
  padding: 10px 20px;
  background: linear-gradient(180deg, #4b3f72, #6a5acd);
  color: #fff;
  font-family: 'Cinzel', serif;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(75, 63, 114, 0.3);
  cursor: pointer;
  transition: transform 0.2s ease;
}

.cer-btn:hover {
  transform: scale(1.05);
}

.logout-btn {
  background: linear-gradient(180deg, #a83232, #d94f4f); /* red aura */
  box-shadow: 0 4px 12px rgba(168, 50, 50, 0.4);
}
/* Match rectangular panel dimensions */
#loginPanel {
  background: rgba(30, 30, 30, 0.6);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  padding: 30px;
  width: 480px;       /* match other rectangular panels */
  min-height: 240px;  /* consistent vertical rhythm */
  margin: 40px auto;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
  text-align: center;
  animation: fadeSlide 0.6s ease-out;
}

/* Inputs stretch to panel width */
#loginPanel input {
  width: 90%;
  max-width: 420px;   /* keep inside panel frame */
  padding: 12px;
  margin: 12px 0;
  border: none;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  font-size: 15px;
  outline: none;
  transition: background 0.3s;
}

#loginPanel input:focus {
  background: rgba(255, 255, 255, 0.2);
  box-shadow: 0 0 8px #ffd700;
}

/* Buttons aligned and consistent */
#loginPanel button {
  margin: 10px;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg, #ffd700, #ff8c00);
  color: #222;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

#loginPanel button:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 12px #ffd700;
}
    
/* Container with depth */
.frost-container {
  position: relative;
  width: 100%;
  max-width: 540px;
  height: 300px;
  margin: 0 auto;
  background: radial-gradient(circle at 50% 30%, #0d1117 0%, #0a0d12 40%, #06080b 100%);
  border: 1px solid rgba(140,160,200,0.18);
  box-shadow: 0 10px 28px rgba(0,0,0,0.45), inset 0 1px 18px rgba(120,150,200,0.12);
  border-radius: 16px;
  overflow: hidden;
  perspective: 900px;
}

/* Frost overlay */
.frost-overlay {
  position: absolute;
  inset: 0;
  backdrop-filter: blur(14px) saturate(1.05);
  background: linear-gradient(180deg, rgba(255,255,255,0.12) 0%, rgba(180,210,255,0.07) 100%);
  border-radius: 16px;
  pointer-events: none;
  z-index: 3;
  animation: frostPulse 4.5s ease-in-out infinite;
}

@keyframes frostPulse {
  0%,100% { opacity: 0.9; }
  50%     { opacity: 0.75; }
}

/* 3D object wrapper */
.object-3d {
  position: absolute;
  inset: 0;
  transform-style: preserve-3d;
  z-index: 1;
}

/* Container perspective */
.frost-container {
  perspective: 1200px;
}

/* Ring stack: float, rotate, stretch */
.ring-stack {
  position: absolute;
  left: 50%;
  top: 52%;
  width: 240px;
  height: 240px;
  transform-style: preserve-3d;
  filter: drop-shadow(0 16px 22px rgba(0,0,0,0.45));
  animation:
    floatY 4.2s ease-in-out infinite,
    rotateAndStretch 14s linear infinite;
}

@keyframes floatY {
  0%,100% { transform: translate(-50%, -50%) translateY(0); }
  50%     { transform: translate(-50%, -50%) translateY(-10px); }
}

@keyframes rotateAndStretch {
  0%   { transform: translate(-50%, -50%) rotateY(0deg) scaleX(1.0); }
  25%  { transform: translate(-50%, -50%) rotateY(90deg) scaleX(1.18); }
  50%  { transform: translate(-50%, -50%) rotateY(180deg) scaleX(1.0); }
  75%  { transform: translate(-50%, -50%) rotateY(270deg) scaleX(1.18); }
  100% { transform: translate(-50%, -50%) rotateY(360deg) scaleX(1.0); }
}

/* SVG layers with depth */
.ring-layer {
  position: absolute;
  left: 0; top: 0;
  width: 100%; height: 100%;
  transform-style: preserve-3d;
}

.layer-front { transform: translateZ(36px) rotateX(2deg); }
.layer-mid   { transform: translateZ(18px) rotateX(1deg); }
.layer-back  { transform: translateZ(-18px) rotateX(-1deg); }

.ring-layer circle {
  stroke-width: 28;
  fill: none;
  filter: drop-shadow(0 0 6px rgba(0,0,0,0.3));
}

/* Inner rim */
.inner-rim {
  position: absolute;
  left: 50%;
  top: 50%;
  width: 160px;
  height: 160px;
  transform: translate(-50%, -50%);
  border-radius: 50%;
  box-shadow: inset 0 0 18px rgba(0,0,0,0.4);
  background: radial-gradient(circle, rgba(255,255,255,0.05), rgba(0,0,0,0.2));
  z-index: 0;
}

/* Facets */
.facets {
  position: absolute;
  inset: 0;
  transform-style: preserve-3d;
}

.facet {
  position: absolute;
  width: 36px; height: 36px;
  background: linear-gradient(135deg, rgba(255,255,255,0.6), rgba(180,225,255,0.15));
  border: 1px solid rgba(190,220,255,0.35);
  backdrop-filter: blur(1px);
  box-shadow: 0 3px 9px rgba(0,0,0,0.25);
  transform: translateZ(20px) rotateX(18deg) scaleX(1.4);
  opacity: 0.65;
  border-radius: 8px;
  animation: facetShimmer 3.6s ease-in-out infinite;
}

@keyframes facetShimmer {
  0%,100% { opacity: 0.55; }
  50%     { opacity: 0.85; }
}

/* Side facets */
.side-facets {
  position: absolute;
  inset: 0;
  transform-style: preserve-3d;
  z-index: 0;
}

.side {
  position: absolute;
  width: 14px;
  height: 140px;
  background: linear-gradient(90deg, rgba(180,220,255,0.2), rgba(255,255,255,0.05));
  border-radius: 6px;
  transform-origin: center;
  opacity: 0.5;
  backdrop-filter: blur(1px);
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
  transform: translate(-50%, 0) rotateY(90deg) scaleX(1.4);
}

.s1 { left: 50%; top: 0%; }
.s2 { left: 50%; top: 25%; }
.s3 { left: 50%; top: 50%; }
.s4 { left: 50%; top: 75%; }

/* Status */
.object-status {
  position: absolute;
  bottom: 12px;
  left: 12px;
  padding: 6px 10px;
  font-size: 14px;
  border-radius: 10px;
  z-index: 4;
  background: rgba(0,0,0,0.35);
  border: 1px solid rgba(120,140,180,0.25);
}

.object-status.pending {
  color: #cdd4e0;
  font-style: italic;
  text-shadow: 0 0 4px rgba(190,190,220,0.5);
}

.object-status.finalized {
  color: goldenrod;
  font-weight: bold;
  text-shadow: 0 0 6px rgba(255,215,0,0.6);
}

.frost-container.finalized .ring-stack {
  filter: drop-shadow(0 20px 26px rgba(0,0,0,0.5)) saturate(1.1);
}
.chamber-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
  padding: 12px;
}

@media (min-width: 600px) {
  .chamber-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 900px) {
  .chamber-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}
#imgVoid {
  width: 100%;
  max-width: 360px;
  margin: 0 auto;
  aspect-ratio: 3 / 2;
  position: relative;
  overflow: hidden;
  border-radius: 12px;
  background: linear-gradient(to bottom, #0a0f1c, #1c2738);
}
.store-card {
  padding: 12px;
  border-radius: 10px;
  background: #1e2a38;
  color: #fff;
  font-size: 0.95rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  transition: transform 0.2s ease;
}

.store-card:active {
  transform: scale(0.98);
}
.chamber-panel {
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}

.chamber-panel.active {
  display: block;
  opacity: 1;
}
.mobile-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #0f172a;
  display: flex;
  justify-content: space-around;
  padding: 8px 0;
  z-index: 1000;
}

/* Hide sticky nav on tablet/desktop */
@media (min-width: 768px) {
  .mobile-nav {
    display: none !important;
  }
}


.billboard-container {
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;       /* horizontal scroll on mobile */
  gap: 12px;
  scroll-snap-type: x mandatory; /* smooth snapping */
}

.billboard {
  flex: 0 0 auto;
  width: 240px;
  height: 140px;
  background: #1e2a38;
  border-radius: 8px;
  opacity: 0;
  transform: translateX(40px);
  animation: fadeSlide 0.8s ease forwards;
  scroll-snap-align: start;
}

@keyframes fadeSlide {
  from {
    opacity: 0;
    transform: translateX(40px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}
.billboard-container {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
}

.billboard {
  flex: 0 0 100%;        /* take full width of screen */
  height: 160px;
  background: #1e2a38;
  border-radius: 8px;
  scroll-snap-align: center;
}

/* On larger screens, show multiple side by side */
@media (min-width: 768px) {
  .billboard {
    flex: 0 0 240px;     /* fixed size per billboard */
    margin-right: 12px;
  }
}


  </style>
<!-- Paste this entire block into the Console -->
<!-- Unified Prestige: HTML hooks, CSS, and JS (paste once before </body>) -->
<style>
  /* Core UI */
  .prestige-slot-final { display:flex; flex-direction:column; gap:8px; align-items:center; padding:8px; box-sizing:border-box; min-width:220px; }
  .prestige-buzzer { width:56px; height:56px; border-radius:50%; border:none; cursor:pointer; background: radial-gradient(circle at 30% 30%, #ffd87a, #ffb84d 60%); box-shadow:0 8px 24px rgba(255,184,77,0.18); display:inline-flex; align-items:center; justify-content:center; font-weight:800; color:#04131f; font-size:20px; }
  .prestige-buzzer-label-final { color:#eaf3ff; font-weight:700; font-size:0.92rem; text-align:center; margin-top:6px; }
  .prestige-widget-final { width:100%; max-width:360px; padding:10px; border-radius:10px; background:linear-gradient(180deg,#071428,#0f2a3a); color:#eaf3ff; box-shadow:0 8px 24px rgba(0,0,0,0.35); display:flex; flex-direction:column; gap:8px; }
  .prestige-widget-final .input { width:100%; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:inherit; box-sizing:border-box; }
  .prestige-send { padding:8px 10px; border-radius:8px; background:linear-gradient(180deg,#ffd87a,#ffb84d); color:#04131f; font-weight:700; border:none; cursor:pointer; }
  .prestige-send.ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#88ccff; }
  .prestige-hidden { display:none !important; }
  .prestige-small { font-size:0.88rem; color:#a8bfd6; }

  /* Modal */
  .prestige-modal { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:10010; width:min(720px,92%); max-width:720px; background:#071428; color:#eaf3ff; border-radius:12px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,0.6); display:none; }
  .prestige-modal textarea { width:100%; height:160px; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:inherit; resize:vertical; box-sizing:border-box; }
  .prestige-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
  .prestige-btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
  .prestige-btn.primary { background:linear-gradient(180deg,#ffd87a,#ffb84d); color:#04131f; }
  .prestige-btn.ghost { background:transparent; color:#88ccff; border:1px solid rgba(136,204,255,0.12); }

  /* Positioning helper (keeps your manual inline --x/--y) */
  .prestige-buzzer.center-over-tap { display:inline-block; transform: translateX(var(--x, 0px)) translateY(var(--y, 0px)); transition: transform .12s ease; z-index:9999; will-change: transform; }
  
  /* Modal sizing: limit width and keep it centered like native modal */
.prestige-modal,
.prestige-modal.show,
.prestige-modal[style] {
  max-width: 720px !important;     /* adjust to desired modal width */
  width: calc(100% - 48px) !important;
  box-sizing: border-box !important;
  margin: 24px auto !important;
  padding: 18px !important;
}

/* Make injected controls visually consistent with common modal button styles */
.prestige-injected-controls .prestige-proceed,
.prestige-injected-controls .prestige-cancel {
  min-width: 88px;
  padding: 8px 14px;
  border-radius: 6px;
  border: 1px solid transparent;
  font-size: 14px;
  line-height: 1;
  cursor: pointer;
  transition: background-color .12s ease, color .12s ease, transform .06s ease;
}

/* Primary look for Proceed */
.prestige-injected-controls .prestige-proceed {
  background: var(--btn-primary-bg, #0b74de);
  color: var(--btn-primary-color, #fff);
  box-shadow: var(--btn-primary-shadow, 0 1px 0 rgba(0,0,0,0.05));
  border-color: rgba(0,0,0,0.06);
}

/* Secondary look for Cancel */
.prestige-injected-controls .prestige-cancel {
  background: var(--btn-secondary-bg, #fff);
  color: var(--btn-secondary-color, #111);
  border: 1px solid var(--btn-secondary-border, #d1d5db);
}

/* Hover/focus states */
.prestige-injected-controls .prestige-proceed:hover,
.prestige-injected-controls .prestige-proceed:focus { filter: brightness(.95); transform: translateY(-1px); }
.prestige-injected-controls .prestige-cancel:hover,
.prestige-injected-controls .prestige-cancel:focus { background: #f7f7f8; }

/* If the site uses a dark modal, invert injected controls automatically */
.prestige-modal.dark .prestige-injected-controls .prestige-proceed {
  background: var(--btn-primary-bg-dark, #2563eb);
  color: #fff;
}
.prestige-modal.dark .prestige-injected-controls .prestige-cancel {
  background: transparent;
  color: #e5e7eb;
  border-color: rgba(255,255,255,0.08);
}

/* Small responsive tweak */
@media (max-width:420px){
  .prestige-injected-controls .prestige-proceed,
  .prestige-injected-controls .prestige-cancel { flex: 1 1 auto; min-width: 0; }
  .prestige-injected-controls { flex-direction: column-reverse; gap: 8px; }
}

/* Frosted ledger style for purchase history */
#purchaseHistory {
  margin-top: 18px;
  padding: 12px;
  background: rgba(255,255,255,0.08);
  border-radius: 8px;
  backdrop-filter: blur(6px);
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}

#purchaseHistory h4 {
  font-weight: 700;
  margin-bottom: 10px;
  color: var(--accent, #ffd700); /* gold accent */
}

#purchaseHistory .prestige-sheet {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.95rem;
  color: #eee;
}

#purchaseHistory .prestige-sheet th {
  text-align: left;
  padding: 6px 10px;
  background: rgba(255,255,255,0.12);
  font-weight: 600;
  letter-spacing: 0.5px;
}

#purchaseHistory .prestige-sheet td {
  padding: 6px 10px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

#purchaseHistory .prestige-sheet tr:hover {
  background: rgba(255,255,255,0.06);
}

#purchaseHistory .glow-gold {
  color: #ffd700;
  font-weight: 600;
  text-shadow: 0 0 6px #ffd700;
}

#purchaseHistory .glow-silver {
  color: #c0c0c0;
  font-weight: 600;
  text-shadow: 0 0 6px #c0c0c0;
}

/* Modal: centered, inert by default, no margin that shifts it down */
/* Prestige modal visual theme and layout */
#prestigeModal {
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  z-index: 11000;
  width: min(720px, calc(100% - 48px));
  max-width: 640px;
  box-sizing: border-box;
  padding: 20px;
  background: linear-gradient(180deg,#071428 0%,#0f2a3a 100%);
  color: #eaf3ff;
  border-radius: 12px;
  box-shadow: 0 18px 60px rgba(2,8,18,0.7);
  max-height: 86vh;
  overflow: auto;
  visibility: hidden;
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease, visibility .18s;
}

/* Visible state */
#prestigeModal.open { visibility: visible; opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }

/* Header and crest */
#prestigeModal .prestige-modal-header { display:flex; gap:12px; align-items:center; margin-bottom:10px; }
#prestigeModal .prestige-crest { display:inline-flex; align-items:center; justify-content:center; }
#prestigeModal .prestige-modal-title { font-weight:800; color:#ffd87a; font-size:1rem; letter-spacing:0.6px; }

/* SMS preview */
#prestigeSmsText {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  color: #eaf3ff;
  padding: 14px;
  border-radius: 8px;
  font-family: var(--mono, monospace);
  font-size: 0.98rem;
  line-height: 1.45;
  max-height: calc(86vh - 260px);
  overflow-y: auto;
  word-break: break-word;
  caret-color: transparent;
}

/* Top action row (Copy/Send/Close) centered and visually separated */
#prestigeModal .prestige-actions { display:flex; gap:12px; justify-content:center; align-items:center; margin-top:14px; margin-bottom:28px; flex-wrap:wrap; }

/* Confirm row styling (if you use a separate confirm block) */
#prestigeModal .prestige-confirm,
#prestigeModal #prestigeConfirm { display:flex; gap:12px; justify-content:flex-end; margin-top:36px; }

/* Button styles */
.prestige-actions .prestige-btn { padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer; border:1px solid rgba(255,255,255,0.06); }
.prestige-actions .prestige-btn.primary { background: linear-gradient(180deg,#ffd87a,#ffb84d); color:#04131f; box-shadow: 0 6px 18px rgba(255,184,77,0.12); }
.prestige-actions .prestige-btn.ghost { background: transparent; color:#88ccff; border:1px solid rgba(136,204,255,0.12); }

/* Ensure contrast for small screens */
@media (max-width:420px) {
  #prestigeModal { width: calc(100% - 24px); padding:14px; }
  #prestigeModal .prestige-modal-title { font-size:0.95rem; }
  #prestigeModal .prestige-actions { gap:8px; }
}
/* CSS: target the modal-specific buzzer */
#prestigeBuzzerModal { /* styles here */ }
<style>
/* Panel base (keep your existing visual styles) */
#loginPanel {
  width: 480px;
  min-height: 240px;
  margin: 40px auto;
  padding: 30px;
  border-radius: 12px;
  text-align: center;
  background: rgba(30,30,30,0.6);
  backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 0 20px rgba(255,215,0,0.18);
  animation: fadeSlide 0.6s ease-out;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Body holds inputs and status */
#loginPanel .login-body {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 100%;
}

/* Inputs stretch to panel width */
#loginPanel input {
  width: 90%;
  max-width: 420px;
  padding: 12px;
  margin: 0;
  border: none;
  border-radius: 8px;
  background: rgba(255,255,255,0.08);
  color: #fff;
  font-size: 15px;
  outline: none;
  transition: background 0.2s, box-shadow 0.2s;
}
#loginPanel input:focus {
  background: rgba(255,255,255,0.14);
  box-shadow: 0 0 8px #ffd700;
}

/* Actions are pushed to the bottom of the panel */
#loginPanel .login-actions {
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: auto; /* key: pushes buttons down */
  padding-bottom: 6px;
}

/* Buttons style */
#loginPanel button {
  margin: 10px;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg,#ffd700,#ff8c00);
  color: #222;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.18s, box-shadow 0.18s;
}
#loginPanel button:hover { transform: translateY(-2px); box-shadow: 0 0 12px #ffd700; }

/* Status visuals */
#loginStatus.status.pending { color: #ffd; opacity: 0.95; }
#loginStatus.status.finalized { color: #ffd700; font-weight: 700; }

  
/* shimmer + verification visuals */
.shimmer-pulse { animation: shimmerPulse 900ms ease; }
@keyframes shimmerPulse { 0%{opacity:.9}50%{opacity:1;transform:translateY(-3px)}100%{opacity:.95} }
.finalized-glow { box-shadow: 0 0 12px rgba(212,175,55,0.25); }

/* header + cards */
.shimmer-header { font-weight:700; margin-bottom:8px; color:#fff; }
.shimmer-cards { display:flex; flex-direction:column; gap:8px; }
.prestige-card { display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:8px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
.card-pending .prestige-state { color:#9aa0a6; font-size:0.75rem; }
.card-finalized { border:1px solid rgba(212,175,55,0.15); }
.prestige-amount { font-weight:700; color:#fff; }
.prestige-cash { font-weight:700; color:#d4f1d4; }
.prestige-state { margin-top:6px; font-size:0.75rem; color:#cfcfcf; }

  /* Prestige button styles: visible, accessible, consistent */
.prestige-card-right { display:flex; gap:8px; align-items:center; justify-content:flex-end; }

.prestige-redeem,
.prestige-copy {
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  font-size:13px;
  font-weight:600;
  border-radius:6px;
  border:0;
  cursor:pointer;
  text-decoration:none;
  color:#fff;
  box-shadow:0 1px 0 rgba(0,0,0,0.25);
}



/* Small visual states */
.prestige-redeem:hover, .prestige-copy:hover { transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,0.12); }
.prestige-redeem:active, .prestige-copy:active { transform:translateY(0); box-shadow:0 2px 6px rgba(0,0,0,0.12); }
.prestige-redeem[disabled], .prestige-copy[disabled] { opacity:0.6; cursor:not-allowed; }

/* Optional: centralize ID/comments styles */
.prestige-id-panel { margin-top:12px; padding:10px; border-radius:8px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:#e6eef8; }
.prestige-id-panel .prestige-id-field { width:100%; box-sizing:border-box; }
.prestige-divider { height:1px; background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.06)); margin:12px 0; border-radius:2px; }

  
/* Tunables */
:root{
  --rail-size: 120px;        /* tile size */
  --rail-gap: 28px;          /* pathway width between tiles */
  --fluor-a: #7af0ff;        /* bright accent */
  --fluor-b: #9eff7a;        /* secondary accent */
  --fluor-c: #ffd87a;        /* warm accent */
  --pathway: rgba(6,12,18,0.72);
  --glow-alpha: 0.14;
}

/* Grid: left aligned 2x2 with pathways */
.checkout-rails-grid{
  display: grid;
  grid-template-columns: repeat(2, var(--rail-size));
  grid-auto-rows: var(--rail-size);
  gap: var(--rail-gap);
  justify-content: start;    /* far left alignment */
  align-content: start;
  padding: 12px 0 0 0;
  box-sizing: border-box;
}

/* Make checkout background show as pathway */
#checkoutPanel, #checkoutPanel .chamber-grid { background-color: var(--pathway); }

/* Tile base: square, softened corners, layered fluorescent gradient */
.checkout-rails-grid .rail{
  width: var(--rail-size);
  height: var(--rail-size);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  gap:8px;
  padding:12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.06);
  box-shadow:
    0 12px 36px rgba(2,6,23,0.55),
    inset 0 2px 8px rgba(255,255,255,0.03);
  overflow:hidden;
  transition: transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease;
  color: #04131f;
}

/* Distinct layered gradients per tile (fluorescent + soft vignette) */
.checkout-rails-grid .rail:nth-child(1){
  background:
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.02)),
    radial-gradient(60% 60% at 20% 20%, rgba(122,240,255,0.18), transparent 20%),
    linear-gradient(135deg, var(--fluor-a), #bff9ff 40%, rgba(255,255,255,0.06) 60%);
  border-color: rgba(122,240,255,0.28);
  box-shadow: 0 14px 40px rgba(10,30,40,0.6), 0 0 40px rgba(122,240,255,var(--glow-alpha));
}
.checkout-rails-grid .rail:nth-child(2){
  background:
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.02)),
    radial-gradient(60% 60% at 80% 20%, rgba(255,216,122,0.16), transparent 20%),
    linear-gradient(135deg, #ffd87a, #fff6d6 40%, rgba(255,255,255,0.04) 60%);
  border-color: rgba(255,216,122,0.28);
  box-shadow: 0 14px 40px rgba(20,18,10,0.6), 0 0 40px rgba(255,216,122,var(--glow-alpha));
}
.checkout-rails-grid .rail:nth-child(3){
  background:
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.02)),
    radial-gradient(60% 60% at 20% 80%, rgba(158,255,122,0.14), transparent 20%),
    linear-gradient(135deg, var(--fluor-b), #eaffc8 40%, rgba(255,255,255,0.04) 60%);
  border-color: rgba(158,255,122,0.28);
  box-shadow: 0 14px 40px rgba(10,20,10,0.6), 0 0 40px rgba(158,255,122,var(--glow-alpha));
}
.checkout-rails-grid .rail:nth-child(4){
  background:
    linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.02)),
    radial-gradient(60% 60% at 80% 80%, rgba(174,227,255,0.14), transparent 20%),
    linear-gradient(135deg, #aee3ff, #eaf9ff 40%, rgba(255,255,255,0.04) 60%);
  border-color: rgba(174,227,255,0.28);
  box-shadow: 0 14px 40px rgba(10,18,30,0.6), 0 0 40px rgba(174,227,255,var(--glow-alpha));
}
/* --- Position grid to far right inside checkout panel --- */
.checkout-rails-grid {
  justify-content: end;        /* push grid to the far right */
  margin-left: 0;
  margin-right: 0;
  padding: 12px 0 0 0;
}

/* Ensure the checkout right column is the target background (pathways remain visible) */
#checkoutPanel .chamber-grid { background-color: rgba(6,12,18,0.72); }

/* --- Tile visual: keep fluorescent gradient but add readable text panel --- */
.checkout-rails-grid .rail {
  width: var(--rail-size, 220px);
  height: var(--rail-size, 220px);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:12px;
  border-radius:10px;
  overflow:hidden;
  position:relative;
  color: #04131f; /* dark text for contrast on bright gradients */
  transition: transform .16s ease, box-shadow .16s ease;
}

/* Text panel inside tile to guarantee legibility over gradients */
.checkout-rails-grid .rail .text-wrap {
  width: 100%;
  background: rgba(255,255,255,0.86); /* near-opaque so text is readable */
  padding: 8px 10px;
  border-radius: 8px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
  color: #04131f;
  text-align:center;
}

/* Keep title and description compact and readable */
.checkout-rails-grid .rail strong {
  display:block;
  font-size:15px;
  line-height:1.05;
  margin:0 0 4px 0;
  font-weight:800;
}
.checkout-rails-grid .rail p {
  margin:0;
  font-size:13px;
  color: rgba(4,19,31,0.95);
  line-height:1.15;
  max-height: 3.6em; /* ~3 lines */
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Sigil: round, centered, high contrast */
.checkout-rails-grid .rail .emblem-sigil {
  width:64px; height:64px; border-radius:50%;
  background-size:cover; background-position:center;
  box-shadow: 0 8px 20px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.06);
  flex:0 0 auto;
}

/* Hover effect */
.checkout-rails-grid .rail:hover {
  transform: translateY(-6px);
  box-shadow: 0 26px 56px rgba(2,6,23,0.65), 0 0 40px rgba(255,255,255,0.04);
}

/* Preserve fluorescent layered gradients (example overrides) */
.checkout-rails-grid .rail:nth-child(1){ /* Prestige Pay */ }
.checkout-rails-grid .rail:nth-child(2){ /* COD */ }
.checkout-rails-grid .rail:nth-child(3){ /* Money Order */ }
.checkout-rails-grid .rail:nth-child(4){ /* Checkout Cart */ }

/* --- Buzzer label under bell: make it readable --- */
/* This is the element under the bell (the "Need help? Tap the buzzer" label). */
.prestige-buzzer-label-final {
  display:block;
  font-size:13px;
  color:#eaf3ff;
  background: rgba(2,8,18,0.6);
  padding:6px 10px;
  border-radius:8px;
  border:1px solid rgba(136,204,255,0.12);
  text-shadow: 0 1px 0 rgba(0,0,0,0.6);
  max-width: 220px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* If you want the label to sit to the right of the bell on narrow widths */
@media (max-width:720px) {
  .prestige-buzzer-wrap { display:flex; gap:8px; align-items:center; }
  .prestige-buzzer-label-final { white-space:normal; font-size:12px; }
}

/* Responsive: keep tiles scrollable on small screens */
@media (max-width:720px) {
  .checkout-rails-grid { display:flex; gap:14px; overflow-x:auto; padding:8px; justify-content:flex-end; }
  .checkout-rails-grid .rail { flex:0 0 var(--rail-size,160px); height:var(--rail-size,160px); }
}

/* Sigil: round, centered, high-contrast on fluorescent gradient */
.checkout-rails-grid .rail .emblem-sigil{
  width:64px; height:64px; border-radius:50%;
  background-size:cover; background-position:center; background-repeat:no-repeat;
  box-shadow: 0 8px 20px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.06);
  flex:0 0 auto;
}

/* Title/description: dark text for contrast */
:root { --rail-text-title: #ffffff; --rail-text-body: #cfd8e3; }

.checkout-rails-grid .rail strong { color: var(--rail-text-title); font-size:15px; margin:0; }
.checkout-rails-grid .rail p      { color: var(--rail-text-body);  font-size:13px; margin:0; }


/* Hover: lift + intensified glow */
.checkout-rails-grid .rail:hover{
  transform: translateY(-6px);
  box-shadow: 0 26px 56px rgba(2,6,23,0.65), 0 0 60px rgba(255,255,255,0.06);
}

/* Pathway spacing preserved */
.checkout-rails-grid{ gap: var(--rail-gap); }

/* Responsive: horizontal scroll of equal squares on narrow screens */
@media (max-width:720px){
  :root{ --rail-size:160px; --rail-gap:14px; }
  .checkout-rails-grid{ display:flex; gap:var(--rail-gap); overflow-x:auto; padding:8px; justify-content:flex-start; }
  .checkout-rails-grid .rail{ flex:0 0 var(--rail-size); height:var(--rail-size); }
}

/* --- Dark cast and readable text patch --- */
:root {
  --tile-cast-alpha: 0.48;   /* darkness of the cast behind tile content */
  --tile-text-bg: rgba(0,0,0,0.56); /* panel behind text */
  --tile-text-pad: 10px;
}

/* create a soft dark cast inside each tile (sits under content) */
.checkout-rails-grid .rail {
  position: relative; /* ensure pseudo sits under content */
  overflow: visible;
}

/* pseudo element provides the dark cast / vignette */
.checkout-rails-grid .rail::before {
  content: "";
  position: absolute;
  inset: 8px;                     /* inset so cast doesn't touch outer edge */
  border-radius: 8px;
  background: linear-gradient(180deg, rgba(0,0,0,var(--tile-cast-alpha)), rgba(0,0,0,0.18));
  pointer-events: none;
  z-index: 0;                     /* behind tile content */
  filter: blur(6px);              /* softens the cast */
  transition: opacity .18s ease;
}

/* ensure tile content sits above the cast */
.checkout-rails-grid .rail > * { position: relative; z-index: 1; }

/* add a semi-opaque text panel for guaranteed legibility */
.checkout-rails-grid .rail .text-wrap {
  background: var(--tile-text-bg);
  padding: var(--tile-text-pad);
  border-radius: 8px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.45);
  color: #fff;                     /* high contrast text */
  max-width: calc(100% - 24px);
  margin: 0 auto;
  backdrop-filter: blur(4px) saturate(1.05);
  line-height: 1.15;
}

/* tighten title/body contrast */
.checkout-rails-grid .rail .text-wrap strong { color: #fff; font-weight:800; display:block; margin-bottom:6px; }
.checkout-rails-grid .rail .text-wrap p { color: rgba(255,255,255,0.92); margin:0; font-size:13px; }

/* reduce cast on hover for a subtle lift effect */
.checkout-rails-grid .rail:hover::before { opacity: 0.85; transform: translateY(-2px); }

/* responsive: keep same behavior on small screens */
@media (max-width:720px) {
  .checkout-rails-grid .rail::before { inset: 6px; filter: blur(4px); }
  .checkout-rails-grid .rail .text-wrap { padding:8px; }
}


/* Make the archive shell behave like a modal sub-panel */
.prestige-archive-shell {
  position: relative;
  z-index: 1200;
  background: transparent;
  margin: 12px 0 0 0;
  box-sizing: border-box;
}

/* Controls column (Add/Clear/Copy) aligned inside modal */
.prestige-archive-shell .prestige-controls {
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:stretch;
  pointer-events:auto;
}

/* Ensure search sits above archive list and is full width inside modal */
.prestige-archive-shell #prestigeArchiveSearch {
  width: 100%;
  box-sizing: border-box;
}

/* Archive list should be scrollable but constrained to modal height */
.prestige-archive-shell #prestigeArchiveList {
  max-height: 28vh;
  overflow:auto;
  box-sizing: border-box;
}

/* Buttons: consistent sizing and not clipped */
.prestige-archive-shell button.prestige-btn {
  min-width: 110px;
  white-space: nowrap;
  cursor: pointer;
}

/* Small-screen adjustments: stack controls under textarea */
@media (max-width:720px) {
  .prestige-archive-shell > .prestige-archive { flex-direction: column; }
  .prestige-archive-shell .prestige-controls { flex-direction: row; gap:8px; justify-content:space-between; }
}

  
  /* Mobile-friendly archive list */
#prestigeArchiveList .archive-item { padding: 12px 10px; }
#prestigeArchiveList .archive-item .archive-apply,
#prestigeArchiveList .archive-item .archive-delete { min-width: 64px; padding:10px 12px; font-size:14px; }
#prestigeArchiveList .archive-item .archive-select { width:24px; height:24px; }

/* Responsive stacking */
@media (max-width:720px) {
  #prestigeArchiveList .archive-item { flex-direction:column; align-items:flex-start; gap:8px; }
  #prestigeArchiveList .archive-item > div:last-child { width:100%; display:flex; gap:8px; }
  .prestige-archive { flex-direction:column; gap:10px; }
  .prestige-archive-shell textarea#prestigePasteArea { min-height:96px; }
}

  
</style>
</head>
<body>
  
  <div class="wrap">

    <!-- Fa√ßade header -->
    <header class="site">
      <div class="crest-mark" aria-hidden="true"></div>
      <h1 class="brand-title"> PRESTIGE HYBRID STORE</h1>
    </header>

    <!-- Verse + token + cart -->
    <section class="token-box frost">
      <div class="verse" id="dailyVerse">‚ÄúLet all that you do be done in love.‚Äù ‚Äî 1 Corinthians 16:14</div>
      <div class="counters">
        <div class="counter gold"><strong>Purchased:ü™ô</strong> <span id="purchasedCount">0</span></div>
        <div class="counter silver"><strong>Symbolic:‚ô¶Ô∏è</strong> <span id="symbolicCount">0</span></div>
      </div>
      <button class="cart-btn" id="cartBtn" onclick="showChamber('checkoutPanel')">
    üõí Cart & Checkout 
    <span id="cartCount" class="cart-count">0</span></button>
    </section>

<section id="userDirectory" class="chamber frost">
  <h4>üë• User Directory</h4>
  <div class="user-grid"></div>
  <div id="purchaseHistory" class="purchase-history-panel"></div>
  <div class="dir-controls">
    <button id="retrieveBtn" class="cer-btn">Retrieve Account Information</button>
    <button id="logoutBtn" class="cer-btn logout-btn">Log Out</button>
  </div>
</section>



<section id="loginPanel" class="chamber frost">
  <h4>üîë User Login</h4>

  <div class="login-body controls">
    <input type="text" id="loginUser" placeholder="Enter Username" />

    <div id="accessCodeWrapper" style="display: none; width:100%; justify-content:center;">
      <input type="password" id="loginCode" placeholder="Enter Access Code" />
      <button id="toggleCodeBtn" type="button">üëÅ Reveal</button>
    </div>

    <button id="revealCodeBtn" type="button">Reveal Access Code Field</button>

    <!-- Status must sit above the actions so it always appears before the buttons -->
    <div id="loginStatus" class="status pending" aria-live="polite" role="status" style="margin-top:8px">Ready</div>
  </div>

  <div class="login-actions">
    <button id="loginBtn" type="button">Log In</button>
  </div>
</section>

    <!-- First windows row (Farce-style live/manual submission look) -->
    <section class="windows" aria-label="Live submissions">
      <article class="window">
        <div class="tile">
          <div class="tile-art" aria-hidden="true"></div>
          <div class="tile-meta">
            <div class="tile-title">Midnight Static</div>
            <div class="tile-sub">Nova & The Wires</div>
            <span class="badge">New</span>
          </div>
        </div>
      </article>
      <article class="window">
        <div class="tile">
          <div class="tile-art" style="background:linear-gradient(135deg,#ff2d6b,#ffd87a)"></div>
          <div class="tile-meta">
            <div class="tile-title">Glass Rituals</div>
            <div class="tile-sub">Vera K.</div>
            <span class="badge">Live</span>
          </div>
        </div>
      </article>
      <article class="window">
        <div class="tile">
          <div class="tile-art" style="background:linear-gradient(135deg,#00e5ff,#0077ff)"></div>
          <div class="tile-meta">
            <div class="tile-title">Concrete Lullaby</div>
            <div class="tile-sub">Brutalist Choir</div>
            <span class="badge">Trending</span>
          </div>
        </div>
      </article>
      <article class="window">
        <div class="tile">
          <div class="tile-art" style="background:linear-gradient(135deg,#9bff5e,#2ed573)"></div>
          <div class="tile-meta">
            <div class="tile-title">Green Room Echoes</div>
            <div class="tile-sub">Staff Ensemble</div>
            <span class="badge">Exclusive</span>
          </div>
        </div>
      </article>
    </section>
<section id="billboard" class="billboard-row">
  <!-- Articles will be injected here -->
</section>

    <!-- Second windows row: chamber directory -->
    <section class="windows windows-dir" aria-label="Chamber directory">
      <article class="dir-card">
        <h3>üèõ Commerce</h3>
        <p>Purchased items, token logic, payment rails.</p>
        <a class="open" href="#commerce">Open chamber</a>
      </article>
      <article class="dir-card">
        <h3>‚öîÔ∏è Gamified</h3>
        <p>Quest rewards, symbolic tokens.</p>
        <a class="open" href="#gamified">Open chamber</a>
      </article>
      <article class="dir-card">
        <h3>ü§ù Community</h3>
        <p>Pooled contributions, generosity artifacts.</p>
        <a class="open" href="#community">Open chamber</a>
      </article>
      <article class="dir-card">
        <h3>‚úùÔ∏è Faith</h3>
        <p>Spiritual-only, prayer submission.</p>
        <a class="open" href="#faith">Open chamber</a>
      </article>
    </section>

    <!-- Chambers -->
    <section id="commerce" class="chamber frost">
      
      <div class="chamber-grid">
        <div class="info-panel">
          <div id="imgVoid" class="info-img frost-container">
  <!-- Frost overlay: visible until unlocked -->
  <div class="frost-overlay"></div>

  <!-- 3D Crystal Ring -->
  <div class="object-3d" aria-label="Crystal Ring">
    <div class="inner-rim"></div>

    <div class="ring-stack">
      <!-- Layer 1 (front) -->
      <svg viewBox="0 0 200 200" class="ring-layer layer-front" aria-hidden="true">
        <defs>
          <linearGradient id="gradFront" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%"   stop-color="#bdf2ff"/>
            <stop offset="35%"  stop-color="#9fe3ff"/>
            <stop offset="65%"  stop-color="#c8f7ff"/>
            <stop offset="100%" stop-color="#8bd7ff"/>
          </linearGradient>
          <radialGradient id="shineFront" cx="30%" cy="30%" r="70%">
            <stop offset="0%"   stop-color="rgba(255,255,255,0.9)"/>
            <stop offset="60%"  stop-color="rgba(255,255,255,0.15)"/>
            <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
          </radialGradient>
        </defs>
        <!-- ring via stroke width -->
        <circle cx="100" cy="100" r="60" stroke="url(#gradFront)" stroke-width="28" fill="none" stroke-linecap="round"/>
        <!-- soft shine overlay -->
        <circle cx="100" cy="100" r="62" fill="url(#shineFront)"/>
      </svg>

      <!-- Layer 2 (mid) -->
      <svg viewBox="0 0 200 200" class="ring-layer layer-mid" aria-hidden="true">
        <defs>
          <linearGradient id="gradMid" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%"   stop-color="#a4e9ff"/>
            <stop offset="35%"  stop-color="#c6f7ff"/>
            <stop offset="65%"  stop-color="#90ddff"/>
            <stop offset="100%" stop-color="#d6fbff"/>
          </linearGradient>
        </defs>
        <circle cx="100" cy="100" r="60" stroke="url(#gradMid)" stroke-width="26" fill="none" stroke-linecap="round" opacity="0.7"/>
      </svg>

      <!-- Layer 3 (back) -->
      <svg viewBox="0 0 200 200" class="ring-layer layer-back" aria-hidden="true">
        <defs>
          <linearGradient id="gradBack" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%"   stop-color="#7ccfff"/>
            <stop offset="50%"  stop-color="#aee8ff"/>
            <stop offset="100%" stop-color="#6dc6ff"/>
          </linearGradient>
        </defs>
        <circle cx="100" cy="100" r="60" stroke="url(#gradBack)" stroke-width="24" fill="none" stroke-linecap="round" opacity="0.55"/>
      </svg>

      <!-- Facets: subtle crystalline segments -->
      <div class="facets">
        <span class="facet f1"></span>
        <span class="facet f2"></span>
        <span class="facet f3"></span>
        <span class="facet f4"></span>
        <span class="facet f5"></span>
      </div>
    </div>
  </div>
<div class="side-facets">
  <span class="side s1"></span>
  <span class="side s2"></span>
  <span class="side s3"></span>
  <span class="side s4"></span>
</div>

  <!-- Status -->
  <div class="object-status pending">Pending ~ Awaiting Prestige verification</div>
</div>

          <h4>üèõ Commerce Chamber</h4>
          <p>Pending credits shimmer silver until a Prestige member finalizes them to gold.</p>
          <p>Cart lists all available purchases, including token-related offerings.</p>
                  
        </div>
        <div class="chamber-grid">
        <div class="store-panel">
          <h4>Store</h4><div class="status pending">Pending verification</div><br>
          <div class="product-grid">
           <div class="product-card" onclick="addToCart('Crystal Ring', 20, 50, 'hybrid')">
  <div class="product-icon ring-crest"></div>
  <div class="product-meta">
    <div class="product-title">Crystal Ring</div>
    <div class="product-cost">üí∞ 20 purchased tokens</div>
    <div class="product-cost">‚ô¶Ô∏è 50 symbolic crystals</div>
    <div class="product-status pending">Pending Verification</div>
  </div>
  <div class="product-action">Click to add to cart</div>
</div>




              
            </div><br>
          
        <div class="chamber-grid">
            <div class="product-card" onclick="addToCart('Silver Necklace', 20)">
              <div class="product-title">Silver Necklace</div>
              <div class="price">üí∞ 30 purchased tokens</div><div class="status pending">Click to add to cart</div>
              
            </div>
            <div class="chamber-grid">
            <div class="product-card" onclick="addToCart('Braided Bracelet', 20)">
              <div class="product-title">Braided Bracelet</div>
              <div class="price">üí∞ 15 purchased tokens</div><div class="status pending">Click to add to cart</div>
              
            </div>
             <div class="chamber-grid"> 
           <div class="product-card" onclick="addToCart('Crest Charm', 20)">
              <div class="product-title">Crest Charm</div>
         <div class="price">üí∞ 10 purchased tokens</div>
              <div class="status pending">Click to add to cart</div>
              
            </div>
          </div>




</section>

    <section id="gamified" class="chamber frost">
  
      <div class="chamber-grid">
        <div class="info-panel">
          <div class="info-img" aria-hidden="true"></div>
          <h4>‚öîÔ∏è Gamified Chamber</h4>
          <p>Symbolic tokens are earned through quests and community actions (distinct from purchased tokens).</p>
        </div>
        <div class="store-panel">
          <h4>Rewards</h4>
          <div class="product-grid">
            <div class="product-card" onclick="addToCart('Quest Badge', 20, 5, 'hybrid')">
  <div class="product-icon Quest-Badge"></div>
  <div class="product-meta">
    <div class="product-title">Quest Badge</div>
    <div class="product-cost">üí∞ 20 purchased tokens</div>
    <div class="product-cost">‚ô¶Ô∏è 5 symbolic crystals</div>
     <div class="product-cost">üíµ $0.00 value</div>
    <div class="product-status pending">Pending Verification</div>
  </div>
  <div class="product-action">Click to add to cart</div>
</div>
            <div class="product-card">
              <div class="product-title">Mini‚Äëgame Medal</div>
              <div class="price">Cost: 8 symbolic tokens</div>
               <div class="price">Earns: 3 symbolic</div>
              <div class="status pending">Pending verification</div>
            </div>
            <div class="product-card">
              <div class="product-title">Challenge Scroll</div>
              <div class="price">Cost: 10 symbolic tokens</div>
              <div class="status pending">Pending verification</div>
            </div>
            <div class="product-card" data-task-id="habit-drink-water" data-type="habit" data-symbolic-reward="3" data-token-reward="1" data-habit-cooldown-ms="43200000">
  <div class="product-title">Drink Water</div>
  <div class="product-desc">Drink 8oz of water</div>
  <div class="price">Earns: 3 symbolic</div>
  <div class="status pending">Pending verification</div>
</div>


<div class="product-card" data-task-id="task-declutter" data-type="task" data-token-reward="8">
  <div class="product-title">Declutter Desk</div>
</div>

<div class="product-card" data-task-id="job-volunteer" data-type="job" data-token-reward="0">
  <div class="product-title">Volunteer Role</div>
</div>


          </div>
        </div>
      </div>
    </section>

    <section id="community" class="chamber frost">
     
      <div class="chamber-grid">
        <div class="info-panel">
          <div class="info-img" aria-hidden="true"></div>
          <h4>ü§ù Community Chamber</h4>
          <p>Pooled contributions and generosity artifacts are honored with symbolic tokens.</p>
          <ul style="margin:8px 0">
            <li>Volunteer hours (+6 symbolic)</li>
            <li>Smoke‚Äëfree challenge (+6 symbolic)</li>
            <li>Help a neighbor (+6 symbolic)</li>
            <li>Pooled contribution (+2 symbolic)</li>
          </ul>
        </div>
        <div class="store-panel">
          <h4>Artifacts</h4>
          <div class="product-grid">
            <div class="product-card">
              <div class="product-title">Community Crest</div>
              <div class="price">Cost: 6 symbolic tokens</div>
              <div class="status pending">Pending verification</div>
            </div>
            <div class="product-card">
              <div class="product-title">Generosity Ribbon</div>
              <div class="price">Cost: 7 symbolic tokens</div>
              <div class="status pending">Pending verification</div>
            </div>
          </div>
        </div>
      </div>
      
        <!-- keep these hidden so they don't affect layout --> <div id="prestigeHiddenProducts" style="display:none"> 
      <!-- Converted product-cards for each denomination -->
<div class="store-panel">
  <h4>Store</h4>
  <div class="status pending">Pending verification</div>
  <br>
  <div class="product-grid">

    <div class="product-card"
         data-serial="PRG-0.01-0001"
         data-product-id="PRG-0.01-0001"
         data-denomination="0.01"
         data-tokencount="0.01"
         data-cashvalue="0.00"
         data-title="0.01 PRESTIGE"
         onclick="addToCart('0.01 PRESTIGE', 0.01, 0, 'parsed')">
      <div class="product-icon ring-crest"></div>
      <div class="product-meta">
        <div class="product-title">0.01 PRESTIGE</div>
        <div class="product-cost">üí∞ 0.01 purchased tokens</div>
        <div class="product-cost">üíµ $0.00 value</div>
        <div class="product-status pending">Pending Verification</div>
      </div>
      <div class="product-action">Click to add to cart</div>
    </div>

    <div class="product-card"
         data-serial="PRG-0.10-0001"
         data-product-id="PRG-0.10-0001"
         data-denomination="0.10"
         data-tokencount="0.10"
         data-cashvalue="0.03"
         data-title="0.10 PRESTIGE"
         onclick="addToCart('0.10 PRESTIGE', 0.10, 0, 'parsed')">
      <div class="product-icon ring-crest"></div>
      <div class="product-meta">
        <div class="product-title">0.10 PRESTIGE</div>
        <div class="product-cost">üí∞ 0.10 purchased tokens</div>
        <div class="product-cost">üíµ $0.03 value</div>
        <div class="product-status pending">Pending Verification</div>
      </div>
      <div class="product-action">Click to add to cart</div>
    </div>

    <div class="product-card"
         data-serial="PRG-0.25-0001"
         data-product-id="PRG-0.25-0001"
         data-denomination="0.25"
         data-tokencount="0.25"
         data-cashvalue="0.06"
         data-title="0.25 PRESTIGE"
         onclick="addToCart('0.25 PRESTIGE', 0.25, 1, 'parsed')">
      <div class="product-icon ring-crest"></div>
      <div class="product-meta">
        <div class="product-title">0.25 PRESTIGE</div>
        <div class="product-cost">üí∞ 0.25 purchased tokens</div>
        <div class="product-cost">üíµ $0.06 value</div>
        <div class="product-status pending">Pending Verification</div>
      </div>
      <div class="product-action">Click to add to cart</div>
    </div>

    <div class="product-card"
         data-serial="PRG-1.00-0001"
         data-product-id="PRG-1.00-0001"
         data-denomination="1.00"
         data-tokencount="1.00"
         data-cashvalue="0.25"
         data-title="1.00 PRESTIGE"
         onclick="addToCart('1.00 PRESTIGE', 1, 3, 'parsed')">
      <div class="product-icon ring-crest"></div>
      <div class="product-meta">
        <div class="product-title">1.00 PRESTIGE</div>
        <div class="product-cost">üí∞ 1 purchased token</div>
        <div class="product-cost">üíµ $0.25 value</div>
        <div class="product-status pending">Pending Verification</div>
      </div>
      <div class="product-action">Click to add to cart</div>
    </div>

    <div class="product-card"
         data-serial="PRG-5.00-0001"
         data-product-id="PRG-5.00-0001"
         data-denomination="5.00"
         data-tokencount="5.00"
         data-cashvalue="1.25"
         data-title="5.00 PRESTIGE"
         onclick="addToCart('5.00 PRESTIGE', 5, 0, 'parsed')">
      <div class="product-icon ring-crest"></div>
      <div class="product-meta">
        <div class="product-title">5.00 PRESTIGE</div>
        <div class="product-cost">üí∞ 5 purchased tokens</div>
        <div class="product-cost">üíµ $1.25 value</div>
        <div class="product-status pending">Pending Verification</div>
      </div>
      <div class="product-action">Click to add to cart</div>
    </div>

    <div class="product-card"
         data-serial="PRG-10.00-0001"
         data-product-id="PRG-10.00-0001"
         data-denomination="10.00"
         data-tokencount="10.00"
         data-cashvalue="2.50"
         data-title="10.00 PRESTIGE"
         onclick="addToCart('10.00 PRESTIGE', 10, 25, 'parsed')">
      <div class="product-icon ring-crest"></div>
      <div class="product-meta">
        <div class="product-title">10.00 PRESTIGE</div>
        <div class="product-cost">üí∞ 10 purchased tokens</div>
        <div class="product-cost">üíµ $2.50 value</div>
        <div class="product-status pending">Pending Verification</div>
      </div>
      <div class="product-action">Click to add to cart</div>
    </div>

    <div class="product-card"
         data-serial="PRG-20.00-0001"
         data-product-id="PRG-20.00-0001"
         data-denomination="20.00"
         data-tokencount="20.00"
         data-cashvalue="5.00"
         data-title="20.00 PRESTIGE"
         onclick="addToCart('20.00 PRESTIGE', 20, 50, 'parsed')">
      <div class="product-icon ring-crest"></div>
      <div class="product-meta">
        <div class="product-title">20.00 PRESTIGE</div>
        <div class="product-cost">üí∞ 20 purchased tokens</div>
        <div class="product-cost">üíµ $5.00 value</div>
        <div class="product-status pending">Pending Verification</div>
      </div>
      <div class="product-action">Click to add to cart</div>
    </div>

    <div class="product-card"
         data-serial="PRG-50.00-0001"
         data-product-id="PRG-50.00-0001"
         data-denomination="50.00"
         data-tokencount="50.00"
         data-cashvalue="12.50"
         data-title="50.00 PRESTIGE"
         onclick="addToCart('50.00 PRESTIGE', 50, 0, 'parsed')">
      <div class="product-icon ring-crest"></div>
      <div class="product-meta">
        <div class="product-title">50.00 PRESTIGE</div>
        <div class="product-cost">üí∞ 50 purchased tokens</div>
        <div class="product-cost">üíµ $12.50 value</div>
        <div class="product-status pending">Pending Verification</div>
      </div>
      <div class="product-action">Click to add to cart</div>
    </div>

    <div class="product-card"
         data-serial="PRG-100.00-0001"
         data-product-id="PRG-100.00-0001"
         data-denomination="100.00"
         data-tokencount="100.00"
         data-cashvalue="25.00"
         data-title="100.00 PRESTIGE"
         onclick="addToCart('100.00 PRESTIGE', 100, 250, 'parsed')">
      <div class="product-icon ring-crest"></div>
      <div class="product-meta">
        <div class="product-title">100.00 PRESTIGE</div>
        <div class="product-cost">üí∞ 100 purchased tokens</div>
        <div class="product-cost">üíµ $25.00 value</div>
        <div class="product-status pending">Pending Verification</div>
      </div>
      <div class="product-action">Click to add to cart</div>
    </div>

  </div>
</div>
    </section>

    <section id="faith" class="chamber frost">
      
      <div class="chamber-grid">
        <div class="info-panel">
          <div class="info-img" aria-hidden="true"></div>
          <h4>‚úùÔ∏è Faith Chamber</h4>
          <p>Spiritual‚Äëonly; submit prayer requests‚Äîno tokens are used here.</p>
          <div class="verse">Be kind to one another tenderhearted ‚Äî Ephesians 4:32</div>
        </div>
        <div class="store-panel">
          <h4>Prayer submission</h4>
          <input type="text" id="prayerInput" placeholder="Type your prayer here‚Ä¶" />
          <div class="controls" style="margin-top:8px">
            <button class="btn" id="submitPrayer">Submit prayer</button>
          </div>
          <div id="prayerLog" class="feed" style="margin-top:12px"></div>
        </div>
      </div>
    </section>

      
      
          
<!-- Cart Chamber -->
<section id="checkoutPanel" class="chamber frost" >
  
  <div class="chamber-grid">
    
    <!-- LEFT: Receipt viewer -->
    <div class="info-panel">
      <div class="info-img void" id="receiptViewer" aria-hidden="true"></div>
      <h4>üßæ Receipt Viewer</h4>
      <p>Finalized purchases glow gold. Pending shimmer silver until ledger confirmation.</p>
      <div id="receiptTotal">Total: 0 ü™ô + 0 ‚ô¶ </div>
      </div>
    
   

    <!-- RIGHT: Cart list -->
    <div class="store-panel">
      <h4>Cart & Checkout</h4>
      <div id="cartList" class="cart-list"></div>
      <button class="btn ghost-btn" onclick="emptyCart()">Empty Cart</button>
<br><br>
      <button class="btn finalize-btn" onclick="finalizeCart()">Finalize Purchases</button>
      <br><br>
    <button id="handoffBtn" class="btn">Send to Ledger</button><br></div>
 <!-- Payment rails and ritual flow -->
         <div class="checkout">
  
            
  <!-- HTML hooks (keep these where you already placed them) -->
<div class="prestige-slot-final" data-for-cod="true" id="prestigeSlotFinal">
  <div class="prestige-buzzer-wrap">
    <button class="prestige-buzzer center-over-tap" id="prestigeBuzzer" aria-label="Hail Prestige" title="Hail Prestige" style="--x:76px; --y:-10px">üîî</button>
    <div class="prestige-buzzer-label-final">Need help? Tap the buzzer</div>
  </div>

  <div class="prestige-widget-final prestige-hidden" id="prestigeWidgetFinal">
    <div style="font-weight:800">Hail Prestige ‚Äî Prefilled</div>
    <div class="row" style="margin-top:6px">
      <input id="pfName" class="input" placeholder="Your name (optional)" />
    </div>
    <div class="row">
      <input id="pfPhone" class="input" placeholder="Phone (optional)" />
    </div>  <!-- ID info area (paste before comments panel) -->
<!-- Paste & Archive area for long ID/JSON blocks -->
<div class="prestige-archive-shell" style="margin-top:12px;">
  <label style="display:block;font-size:13px;color:#9fb0d6;margin-bottom:6px">Paste IDs or JSON (keeps archive)</label>
  <div class="prestige-archive" style="margin-top:12px;">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
    <strong style="font-size:13px;color:#e6eef8">Archive</strong>
    <input id="prestigeArchiveSearch" placeholder="Search archive" style="margin-left:8px;padding:6px;border-radius:6px;border:1px solid #21324a;background:#071028;color:#e6eef8;font-size:13px;flex:1" />
  </div>

  <!-- Saved count sits directly under the search -->
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
    <div style="font-size:12px;color:#9fb0d6">Saved items:</div>
    <div id="prestigeArchiveCount" style="font-size:12px;color:#e6eef8">0</div>
  </div>
<!-- Paste area + action buttons -->
  <div style="display:flex;gap:8px;align-items:flex-start;">
    <textarea id="prestigePasteArea" placeholder="Paste JSON or identifiers here..." style="flex:1;min-height:72px;max-height:36vh;padding:8px;border-radius:6px;border:1px solid #21324a;background:#071028;color:#e6eef8;resize:vertical;overflow:auto"></textarea>
  <div id="prestigeArchiveList" style="max-height:28vh;overflow:auto;border-radius:6px;padding:6px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01)"></div>
</div>
<div style="display:flex;flex-direction:column;gap:8px;">
      <button id="prestigeAddArchive" class="prestige-btn primary" style="padding:8px 10px;white-space:nowrap">Add to archive</button>
      <button id="prestigePasteClear" class="prestige-btn ghost" style="padding:8px 10px;white-space:nowrap">Clear</button>
      <button id="prestigePasteCopy" class="prestige-btn ghost" style="padding:8px 10px;white-space:nowrap">Copy</button>
    </div>
  </div>
  

    <div>
      <input id="pfIssue" class="input" placeholder="Short issue description (optional)" />
    </div>
    <div class="prestige-small">You will confirm creation of a one‚Äëtime Jitsi room; Prestige members may take 15‚Äì30 minutes to respond.</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="pfSendSms" class="send prestige-send">SMS</button>
      <button id="pfSendEmail" class="send prestige-send ghost">Email</button>
    </div>
  </div>
</div>

<!-- Hidden staff reply and modal/confirm (kept once in DOM) -->
           
<textarea id="prestigeHiddenStaffReply" style="display:none"></textarea>

<div class="prestige-modal" id="prestigeModal" aria-hidden="true">
  
    <button class="prestige-buzzer center-over-tap" id="prestigeBuzzerModal" aria-label="Hail Prestige" title="Hail Prestige" style="--x:296px; --y:-70px">üîî</button>

  <div class="prestige-modal-header">
  
  <div class="prestige-modal-title">PREFILLED SMS TEXT</div>
</div>

  <textarea id="prestigeSmsText" readonly></textarea>
  <div class="prestige-actions">
    <button id="copySms" class="prestige-btn ghost">Copy SMS</button>
    <button id="modalSendEmail" class="prestige-btn primary">Send Email</button>
    <button id="closeModal" class="prestige-btn ghost">Close</button>
  </div>
</div>

<div class="prestige-confirm" id="prestigeConfirm" style="display:none" aria-hidden="true">
  <div style="font-weight:800;margin-bottom:8px">Create one‚Äëtime Jitsi room?</div>
  <div class="prestige-small" style="margin-bottom:12px">This will create a one‚Äëtime Jitsi room and notify Prestige members by phone/email. Proceed?</div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button id="confirmCancel" class="prestige-btn ghost">Cancel</button>
    <button id="confirmProceed" class="prestige-btn primary">Proceed</button>
  </div>
</div>
   
   <!-- Floating rails panel (replace your existing .lower section) -->
<div class="text-wrap">
<!-- inside #checkoutPanel (place where you want the tiles to appear) -->
<div id="checkoutRails" class="checkout-rails-grid" aria-hidden="true">
  <div class="rail">
    
     <div class="emblem-sigil prestige-pay" aria-hidden="true"></div>
  
    <strong>Prestige Pay</strong>
    <p>Friendly flow. Finalization confirmed by ledger glow. Requires ceremonial desk approval.</p>
  </div>

  <div class="rail">
    
     <div class="emblem-sigil  cod" aria-hidden="true"></div>
  
    <strong>Cash on Delivery</strong>
    <p>Verified post-receipt. Status shimmer appears after member confirmation.</p>
  </div>

  <div class="rail">
    
     <div class="emblem-sigil money-order" aria-hidden="true"></div>
 
    <strong>Money Order</strong>
    <p>Accepted with pacing. Ledger updates once received and verified.</p>
  </div>

  <div class="rail">
    
     <div class="emblem-sigil chckout-cart" aria-hidden="true"></div>
  
    <strong>Checkout Cart</strong>
    <p>View all pending purchases. Shimmer silver until finalized by Prestige member.</p>
  </div>
</div>
  
  
 <!--<div class="emblem-sigil prestige-pay" aria-hidden="true">
  small inline SVG centered and sized by CSS 
  <svg viewBox="0 0 64 64" width="64" height="64" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
    <circle cx="32" cy="32" r="30" fill="#ffd87a"/>
    <path d="M20 36 L28 24 L44 40" stroke="#1b1b1b" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</div>-->

</section>
     
    
          
          
    <form id="loveform" style="display:none" method="POST" target="hidden_iframe" action="">
  <textarea id="loveform_items_list" name="items_list"></textarea>
  <textarea id="loveform_receipt_text" name="receipt_text"></textarea>
  <input type="hidden" id="loveform_items_json" name="items_json" value="" />
  <input type="hidden" id="loveform_username" name="username" value="" />
  <input type="hidden" id="loveform_email" name="email" value="" />
  <input type="hidden" id="loveform_accessCode" name="accessCode" value="" />
</form>

<iframe name="hidden_iframe" style="display:none" aria-hidden="true"></iframe>


      
      
      
    <!-- Live feed + reflection + community ad -->
    <section class="lower">
      <div class="panel-lite">
        <h4 style="margin:6px 0 10px">Live updates</h4>
        <div id="liveFeed" class="feed">
          <div class="feed-item">üõç Crystal Ring purchase requested (Commerce) ‚Äî pending shimmer</div>
          <div class="feed-item">‚öîÔ∏è Quest completed: Submit grades (+5 symbolic)</div>
          <div class="feed-item">‚úùÔ∏è Prayer submitted: ‚ÄúGuide me in patience.‚Äù</div>
        </div>
      </div>
      <div class="panel-lite">
        <h4 style="margin:6px 0 10px">Reflection</h4>
        <div id="reflectionBox" class="ad">What effort today felt honest and steady?</div>
        <h4 style="margin:14px 0 10px">Community ad</h4>
        <div id="communityAd" class="ad">Neighbors Helping Neighbors ‚Äî pledge board rotates every 6 hours.</div>
      </div>
    </section>

      
      
  
      
      
      
      
    <!-- Directory back controls -->
    <section class="controls" style="margin-top:16px">
      <a class="btn" href="#">Back to top</a>
      <button class="btn" onclick="showChamber('')">Reset chambers</button>
    </section>

      
    <!-- Cart button already in token-box -->



      
      
  </div>

 
      
<nav class="mobile-nav">
  <button onclick="showPanel('commerce')">Commerce</button>
  <button onclick="showPanel('gamified')">Gamified</button>
  <button onclick="showPanel('community')">Community</button>
  <button onclick="showPanel('faith')">Faith</button>
</nav>


<div id="userCard"></div>
<div id="ledger"></div>
<div id="purchaseHistory"></div>

           
           
           
           
           



  <script>
    // Static reveal via class toggling (.active). Anchors also work.
    function showChamber(id){
      const ids = ['commerce','gamified','community','faith','checkoutPanel'];
      ids.forEach(x => {
        const el = document.getElementById(x);
        if(!el) return;
        if (id === x) { el.classList.add('active'); location.hash = '#' + id; }
        else { el.classList.remove('active'); }
      });
      if (!id) { history.pushState('', document.title, window.location.pathname + window.location.search); }
    }

    // Verse rotation every 30s (placeholder-ready for live JSON)
    const verses = [
  "Let all that you do be done in love ~ 1 Corinthians 16:14",
  "Be kind to one another ~ tenderhearted ~ Ephesians 4:32",
  "Walk by faith not by sight ~ 2 Corinthians 5:7",
  "The Lord is my shepherd I shall not want ~ Psalm 23:1",
  "I can do all things through Christ who strengthens me ~ Philippians 4:13",
  "Trust in the Lord with all your heart ~ Proverbs 3:5",
  "Do not be anxious about anything ~ Philippians 4:6",
  "Love your neighbor as yourself ~ Matthew 22:39",
  "Rejoice always ~ pray without ceasing ~ 1 Thessalonians 5:16-17",
  "The joy of the Lord is your strength ~ Nehemiah 8:10",
  "Create in me a clean heart ~ Psalm 51:10",
  "Blessed are the peacemakers ~ Matthew 5:9",
  "Your word is a lamp to my feet ~ Psalm 119:105",
  "He has made everything beautiful in its time ~ Ecclesiastes 3:11",
  "Be still and know that I am God ~ Psalm 46:10",
  "Let your light shine before others ~ Matthew 5:16",
  "Cast all your cares on Him ~ 1 Peter 5:7",
  "The Lord is my strength and my shield ~ Psalm 28:7",
  "In everything give thanks ~ 1 Thessalonians 5:18",
  "The steadfast love of the Lord never ceases ~ Lamentations 3:22"
];
    let v = 0;
    setInterval(() => {
      v = (v + 1) % verses.length;
      const box = document.getElementById('dailyVerse');
      if (box) box.textContent = verses[v];
    }, 30000);

    // Reflection rotation every 45s
    const reflections = [
  "Where can you slow down and show care?",
  "Does this purchase align with your values right now?",
  "Would gifting this bring someone meaningful joy?",
  "What patience do you want to practice today?",
  "What effort today felt honest and steady? ~",
  "Who have you checked in on this week? ~",
  "Is there a small kindness you‚Äôve overlooked? ~",
  "What are you grateful for in this moment? ~",
  "What intention do you want to carry forward? ~",
  "Where did you feel most present today? ~",
  "What would generosity look like right now? ~",
  "Is there someone who needs your quiet support? ~",
  "What part of your day felt sacred? ~",
  "What are you resisting that might deserve grace? ~",
  "How can you honor your limits with kindness? ~",
  "What gesture could restore someone‚Äôs peace? ~",
  "Where did you notice beauty today? ~",
  "What truth are you ready to speak gently? ~",
  "What does integrity look like in this moment? ~",
  "How can you soften your pace without losing purpose? ~",
  "What would it mean to lead with compassion today? ~"
];

    setInterval(() => {
      const idx = Math.floor(Math.random() * reflections.length);
      const el = document.getElementById('reflectionBox');
      if (el) el.textContent = reflections[idx];
    }, 45000);

    // Community ad placeholder rotation every 6 hours
    const ads = [
  "Neighbors Helping Neighbors ~ pledge board updates at dusk.",
  "Community Crest Night ~ shared table, shared honor.",
  "Volunteer Circle ~ add your hour, lift someone‚Äôs week.",
  "Quiet Generosity ~ small acts, steady light.",
  "Token Harvest ~ every kindness counts toward the collective bloom.",
  "Prestige Pledge Hour ~ log your vow, light the chamber.",
  "Shared Lantern Walk ~ one step, one glow, one bond.",
  "Kindness Ledger ~ record your ripple, honor the wave.",
  "Crest Exchange ~ trade tokens for warmth and witness.",
  "Silent Sigil Drop ~ anonymous gifts, visible impact.",
  "Unity Scroll ~ sign your name, seal the moment.",
  "Generosity Pulse ~ chamber lights shift with each act.",
  "Echo Chamber ~ your kindness echoes through the grid.",
  "Prestige Pantry ~ contribute quietly, receive openly.",
  "Civic Bloom ~ every gesture grows the shared garden.",
  "Token Tribute ~ honor someone with symbolic light.",
  "Community Weave ~ threads of care form the tapestry.",
  "Midnight Offering ~ late pledges shimmer with extra grace.",
  "Shared Ember ~ one spark passed, many warmed.",
  "Crest Reflection ~ review your impact, renew your vow.",
  "Kindness Relay ~ pass the gesture, extend the glow.",
  "Prestige Beacon ~ top contributors light the chamber crest."
];

    setInterval(() => {
      const idx = Math.floor(Math.random() * ads.length);
      const el = document.getElementById('communityAd');
      if (el) el.textContent = ads[idx];
    }, 6 * 60 * 60 * 1000);

    // Prayer submission (front-end only; hook to Sheets JSON in production)
    document.getElementById('submitPrayer')?.addEventListener('click', () => {
      const input = document.getElementById('prayerInput');
      const log = document.getElementById('prayerLog');
      const text = (input?.value || '').trim();
      if (!text) return;
      const ts = new Date().toLocaleString();
      const item = document.createElement('div');
      item.className = 'feed-item';
      item.textContent = `üïä ${text} ‚Äî ${ts}`;
      log?.prepend(item);
      input.value = '';
      // In production: POST to Google Apps Script ‚Üí Sheet; live feed pulls JSON
    });

    // Token counters: JSON hooks (no local placeholders in prod)
    async function loadLedger(){
      // Replace with your Apps Script JSON endpoint(s)
      // Example: const url = 'https://script.google.com/macros/s/XXXX/exec';
      // const res = await fetch(url, {cache:'no-store'}); const data = await res.json();
      // document.getElementById('purchasedCount').textContent = data.purchased;
      // document.getElementById('symbolicCount').textContent = data.symbolic;
    }
    // Call on load (disabled until endpoints provided)
    // loadLedger();

    // Cart button ‚Üí opens Commerce chamber
    document.getElementById('cartBtn')?.addEventListener('click', () => showChamber('checkoutPanel'));

    // On anchor navigation, ensure class toggling matches :target
    window.addEventListener('hashchange', () => {
      const id = (location.hash || '').replace('#','');
      if (['commerce','gamified','community','faith','checkoutPanel'].includes(id)) showChamber(id);
    });

    // Initial hash activation if present
    (function initFromHash(){
      const id = (location.hash || '').replace('','');
      if (['commerce','gamified','community','faith','checkoutPanel'].includes(id)) showChamber(id);
    })();
    
    
   </script><script>

(function(){
  const feed = document.getElementById('liveFeed');
  const samples = [
    'üèõ Purchase finalized: Silver Necklace',
    '‚öîÔ∏è Quest completed: Birthday bonus (+5 symbolic)',
    'ü§ù Contribution added: Help a neighbor (+2 symbolic)',
    '‚úùÔ∏è Prayer submitted: ‚ÄúStrength for tomorrow.‚Äù'
  ];
  let s = 0;

  setInterval(()=>{
    const item = document.createElement('div');
    item.className = 'feed-item';

    // Generate timestamp
    const now = new Date();
    const ts = now.toLocaleString(); // e.g. "11/13/2025, 6:45:12 PM"

    item.innerHTML = `<span>${samples[s % samples.length]}</span><small>${ts}</small>`;
    feed.prepend(item); // keep feed tidy
    if(feed.children.length > 6) feed.lastElementChild.remove();

    // cycle sample index
    s++;
  }, 60000); // every 1 minute
})();
</script>

   
<script>
(function(){
  const billboard = document.getElementById('billboard');
  const entries = [
    {
      title: "Midnight Static",
      sub: "Nova & The Wires",
      badge: "NEW",
      image: "#1a1a1a"
    },
    {
      title: "Glass Rituals",
      sub: "V√©ra K.",
      badge: "LIVE",
      image: "#ff2d6b"
    },
    {
      title: "Concrete Lullaby",
      sub: "Brutalist Choir",
      badge: "TRENDING",
      image: "#0077ff"
    },
    {
      title: "Green Room Echoes",
      sub: "Staff Ensemble",
      badge: "EXCLUSIVE",
      image: "#2ed573"
    }
  ];
  let i = 0;

  setInterval(() => {
    const e = entries[i % entries.length];
    const article = document.createElement('article');
    article.className = 'billboard-article';
    article.innerHTML = `
      <div class="billboard-image" style="background:${e.image}"></div>
      <div class="billboard-title">${e.title}</div>
      <div class="billboard-sub">${e.sub}</div>
      <span class="badge">${e.badge}</span>
    `;
    billboard.prepend(article);
    if (billboard.children.length > 4) billboard.lastElementChild.remove();
    i++;
  }, 15000); // every 8 seconds
})();
</script>
<script>
function unlockItem(id, className, cost){
  const card = document.getElementById(id);
  if (!card) return;

  card.classList.remove('locked');
  card.classList.add('unlocked');

  const veil = card.querySelector('.frost-veil');
  if (veil) veil.style.display = 'none';

  const status = card.querySelector('.object-status');
  if (status){
    status.textContent = 'Unlocked ~ Awaiting member finalization';
    status.classList.remove('pending');
    status.classList.add('finalized');
  }

  card.setAttribute('onclick', `displayInViewer('${className}', '${card.querySelector('.object-title').textContent}')`);
}
function displayInViewer(className, title){
  const viewer = document.querySelector('#commerce .info-img');
  viewer.className = 'info-img ' + className;
  viewer.setAttribute('aria-label', title);
}
  
  
</script>
<script>
/* Clear password on logout ‚Äî idempotent and defensive */
(function ensurePasswordClearedOnLogout(){
  if (window.__prestige_clear_password_installed) return;
  window.__prestige_clear_password_installed = true;

  const $id = id => document.getElementById(id);

  // Helper: clear the password input and remove any transient storage of it
  function clearPasswordField() {
    try {
      const pwd = $id('loginCode') || document.querySelector('#accessCodeWrapper input[type="password"]');
      if (pwd) {
        // clear value and blur to reduce chance of accidental reads or clipboard copy
        pwd.value = '';
        try { pwd.blur(); } catch(e){}
        // mark as non-parsable so other scripts skip it
        if (!pwd.hasAttribute('data-prestige-no-parse')) pwd.setAttribute('data-prestige-no-parse', 'true');
        // remove any session key that might store the code
        try { sessionStorage.removeItem('accessCode'); } catch(e){}
      }
    } catch (e) { /* ignore */ }
  }

  // Helper: perform the broader cleanup you already had, but targeted
  function basicLogoutCleanup({ notify = true } = {}) {
    // stop polling and abort in-flight requests if present
    try { if (typeof stopPolling === 'function') stopPolling(); } catch(e){}
    try { if (window.pollController) { window.pollController.abort(); window.pollController = null; } } catch(e){}

    // targeted session clears (avoid sessionStorage.clear())
    try { sessionStorage.removeItem('accessCode'); } catch(e){}
    try { sessionStorage.removeItem('username'); } catch(e){}

    // clear in-memory user state
    try { window.__currentUser = null; } catch(e){}

    // update UI to login state
    try {
      $id('userDirectory')?.classList.remove('active');
      $id('loginPanel')?.classList.add('active');
    } catch(e){}

    // ensure password field is cleared and neutralized
    clearPasswordField();

    // notify other modules if requested
    if (notify) {
      try { window.dispatchEvent(new CustomEvent('fakeLogout', { detail: { reason: 'cleanup' } })); } catch(e){}
    }
  }

  // Wire to page load (preserve your existing behavior)
  window.addEventListener('load', () => {
    // run the targeted cleanup on load so the page appears logged out
    basicLogoutCleanup({ notify: true });
  });

  // Wire to your logout button(s) idempotently
  function wireLogoutButtons() {
    const selectors = ['#logoutBtn', '.logout-btn', 'button.logout', 'a.logout'];
    selectors.forEach(sel => {
      document.querySelectorAll(sel).forEach(btn => {
        if (btn.__prestige_clear_pwd_wired) return;
        btn.addEventListener('click', (ev) => {
          // run cleanup first so UI and state are safe
          basicLogoutCleanup({ notify: true });
          // allow other handlers to run afterwards
        }, { capture: true });
        btn.__prestige_clear_pwd_wired = true;
      });
    });
  }
  wireLogoutButtons();

  // Also respond to programmatic fakeLogout events
  if (!document.__prestige_fake_logout_wired) {
    window.addEventListener('fakeLogout', (ev) => {
      basicLogoutCleanup({ notify: false });
    }, { capture: true });
    document.__prestige_fake_logout_wired = true;
  }

  // Re-scan periodically for dynamically inserted logout buttons (stops after 30s)
  const scanInterval = setInterval(wireLogoutButtons, 1500);
  setTimeout(() => clearInterval(scanInterval), 30_000);

  // Expose a small API for manual invocation
  window.Prestige = window.Prestige || {};
  window.Prestige.clearPasswordAndLogout = basicLogoutCleanup;

})();
</script>
<script>
// --- Shared counters ---
let cartTokenTotal = 0, cartCrystalTotal = 0, cartItems = 0;

// --- Generic sheet fetcher ---
async function fetchSheet(gid, mapper){
  const url = `https://docs.google.com/spreadsheets/d/1eskbyxg5KOvTyOb68_Zdt5W1YeyfOuvBABqnMBN79xM/gviz/tq?tqx=out:json&gid=${gid}`;
  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substring(47).slice(0, -2));
  const rows = json.table.rows || [];
  return rows.map(mapper);
}

// --- Specific sheet helpers ---
async function fetchUserDirectory(){
  return fetchSheet(0, r => ({
    user:        r.c[0]?.v ?? "",
    accessCode:  r.c[1]?.v ?? "",
    card:        r.c[2]?.v ?? "",
    purchased:   r.c[3]?.v ?? "0",
    symbolic:    r.c[4]?.v ?? "0",
    status:      r.c[5]?.v ?? "Pending"
  }));
}

async function fetchPurchaseHistory(){
  return fetchSheet(238239380, r => ({
    user:        r.c[0]?.v ?? "",   // Column A
    transaction: r.c[1]?.v ?? "",   // Column B
    status:      r.c[2]?.v ?? "Pending", // Column C
    verifiedBy:  r.c[3]?.v ?? "",   // Column D
    date:        r.c[4]?.v ?? "",   // Column E
    notes:       r.c[5]?.v ?? ""    // Column F
  }));
}

async function fetchFinalizedLedger(){
  return fetchSheet(1547074840, r => ({
    user:          r.c[0]?.v ?? "",
    transaction:   r.c[1]?.v ?? "",
    verifiedBy:    r.c[2]?.v ?? "",
    status:        r.c[3]?.v ?? "Pending",
    finalizeCode:  r.c[4]?.v ?? "",
    finalizeExpiry:r.c[5]?.v ?? "",
    purchased:     r.c[6]?.v ?? "0",
    symbolic:      r.c[7]?.v ?? "0"
  }));
}

// --- Cart functions ---
function addToCart(name, tokenCost, crystalCost, type){
  const cart = document.getElementById('cartList');
  const item = document.createElement('div');
  item.className = 'cart-item shimmer';

  // Attach lookup keys for ledger matching
  const user = sessionStorage.getItem("username") || "Guest";
  item.setAttribute('data-user', user);
  item.setAttribute('data-transaction', name);

  item.innerHTML = `
    <div class="cart-title">${name}</div>
    ${type !== 'crystal' ? `<div class="cost-row token"><span class="cost-value">${tokenCost}</span> ü™ô purchased tokens</div>` : ''}
    ${type !== 'token' ? `<div class="cost-row crystal"><span class="cost-value">${crystalCost}</span> ‚ô¶Ô∏è symbolic crystals</div>` : ''}
    <div class="cart-status">Pending ‚Ä¢ Awaiting Prestige verification</div>
  `;
  cart.appendChild(item);

  if (type !== 'crystal') cartTokenTotal += tokenCost;
  if (type !== 'token') cartCrystalTotal += crystalCost;

  cartItems += 1;
  updateCartDisplay();
}

function updateCartDisplay(){
  const badge = document.getElementById('cartCount');
  const floatBadge = document.getElementById('floatingCartCount');
  const total = document.getElementById('receiptTotal');

  if (badge) badge.textContent = cartItems;
  if (floatBadge) floatBadge.textContent = cartItems;
  if (total) total.textContent = `Total: ${cartTokenTotal} ü™ô + ${cartCrystalTotal} <üî¥>`;
}

function finalizeCart(){
  const viewer = document.getElementById('receiptViewer');
  if (viewer) {
    viewer.className = 'info-img shimmer';
    viewer.innerHTML = `<div class="receipt-confirm">üßæ Submitted ‚Ä¢ ${cartTokenTotal} ü™ô + ${cartCrystalTotal} ‚ô¶Ô∏è<br>Awaiting Prestige verification</div>`;
  }

  (document.getElementById('confirmFinalizeBtn')
   || document.querySelector('.finalize-btn')
   || document.querySelector('[data-finalize-btn]')
   || document.querySelector('button.finalize-btn'))
  ?.addEventListener('click', ()=>window.promptAndConsumeAccessCode());

  document.querySelectorAll('.cart-item').forEach(item => {
    item.classList.add('shimmer');
    item.classList.remove('finalized');
    const s = item.querySelector('.cart-status');
    if (s) s.textContent = 'Pending ~ Awaiting Prestige verification';
  });

  // Reset counters AFTER snapshot
  cartTokenTotal = 0;
  cartCrystalTotal = 0;
  cartItems = 0;
  updateCartDisplay();

  // Sync with ledger
  updateCartFromLedger();
}

function emptyCart(){
  const cart = document.getElementById('cartList');
  if (cart) cart.innerHTML = '';
  cartTokenTotal = 0;
  cartCrystalTotal = 0;
  cartItems = 0;
  updateCartDisplay();

  const viewer = document.getElementById('receiptViewer');
  if (viewer){
    viewer.className = 'info-img void';
    viewer.innerHTML = '';
  }

  const total = document.getElementById('receiptTotal');
  if (total) total.textContent = `Total: 0 ü™ô + 0 <üî¥>`;
}

// --- Shimmer sync against ledger ---
async function updateCartFromLedger(){
  const ledger = await fetchFinalizedLedger();

  document.querySelectorAll('.cart-item').forEach(item => {
    const user = item.getAttribute('data-user');
    const transaction = item.getAttribute('data-transaction');

    const match = ledger.find(l =>
      String(l.user).trim() === String(user).trim() &&
      String(l.transaction).trim() === String(transaction).trim()
    );

    if (match && String(match.status).toLowerCase() === "finalized") {
      item.classList.remove('shimmer','pending','glow-silver');
      item.classList.add('finalized','glow-gold');
      const s = item.querySelector('.cart-status');
      if (s) s.textContent = ` Finalized by ${match.verifiedBy || "Prestige Member"}`;
    } else {
      item.classList.remove('glow-gold');
      item.classList.add('shimmer','glow-silver');
      const s = item.querySelector('.cart-status');
      if (s) s.textContent = 'Pending ~ Awaiting Prestige verification';
    }
  });
}
/* ---------- Backwards compatible renderer with optional crystals ---------- */

// Config: set to true to keep crystals hidden entirely for store products with zero crystals
const HIDE_ZERO_CRYSTALS = false; // set true to hide row; false to show "zeo"

// Format helpers
function formatUSD(value) {
  const n = Number(value || 0);
  return `$${n.toFixed(2)}`;
}
function emojiFor(kind) {
  if (kind === 'token') return 'ü™ô';
  if (kind === 'usd') return 'üíµ';
  if (kind === 'crystal') return '‚ô¶Ô∏è';
  return '';
}
function escapeHtml(s) {
  return String(s || '').replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]);
}

/* Render cart item without removing existing content.
   If crystals are zero, show "zeo" (literal) unless HIDE_ZERO_CRYSTALS is true.
*/
function renderCartItem(payload) {
  if (!payload) return null;
  const cart = document.getElementById('cartList');
  if (!cart) return null;

  const serial = String(payload.serial || payload.product_id || `PRG-${(payload.denomination||0).toFixed(2)}-${Date.now()}`);
  const title = payload.title || `${Number(payload.denomination||0).toFixed(2)} PRESTIGE`;
  const tokenCount = Number(payload.tokenCount ?? payload.denomination ?? 0);
  const cashValue = Number(payload.cashValue ?? (Number(payload.denomination||0) * (window.CASH_PER_PRESTIGE || 0.25)));
  const crystalsRaw = payload.crystals ?? Math.round(tokenCount * (window.CRYSTAL_MULTIPLIER || 2.5));
  const crystals = Number(crystalsRaw || 0);
  const statusText = payload.status || 'Pending ‚Ä¢ Awaiting Prestige verification';

  // idempotent: reuse existing node if present
  let item = cart.querySelector(`.cart-item[data-serial="${serial}"]`);
  if (!item) {
    item = document.createElement('div');
    item.className = 'cart-item';
    item.setAttribute('data-serial', serial);
    item.setAttribute('data-product-id', payload.product_id || serial);
    item.setAttribute('data-transaction', title);
    item.setAttribute('data-user', sessionStorage.getItem('username') || 'Guest');
    cart.appendChild(item);
  }

  // Build crystal row according to config and value
  let crystalRowHtml = '';
  if (crystals > 0) {
    crystalRowHtml = `<div class="cost-row crystal"><span class="cost-value">${escapeHtml(String(crystals))}</span> ${emojiFor('crystal')} symbolic crystals</div>`;
  } else {
    if (!HIDE_ZERO_CRYSTALS) {
      // show "zeo" exactly as requested
      crystalRowHtml = `<div class="cost-row crystal"><span class="cost-value">0</span> ${emojiFor('crystal')} symbolic crystals</div>`;
    } else {
      crystalRowHtml = ''; // hide the row entirely
    }
  }

  // Preserve any existing extra content inside item by not clobbering attributes other than innerHTML
  item.innerHTML = `
    <div class="cart-title">${escapeHtml(title)}</div>
    <div class="cost-row token"><span class="cost-value">${escapeHtml(String(tokenCount))}</span> ${emojiFor('token')} purchased tokens</div>
    <div class="cost-row usd"><span class="cost-value">${escapeHtml(formatUSD(cashValue))}</span> ${emojiFor('usd')} value</div>
    ${crystalRowHtml}
    <div class="cart-status">${escapeHtml(statusText)}</div>
  `;

  // visual state
  item.classList.remove('finalized','glow-gold');
  item.classList.add('shimmer','glow-silver');

  return { node: item, tokenCount, crystals, cashValue, serial, title };
}

/* ---------- Non-destructive addToCart wrapper ---------- */
/* This wrapper uses renderCartItem and persists canonical payload.
   It will not remove existing cart items unless they match by serial/product_id.
*/
function addToCart(name, tokenCost, crystalCost, type){
  const denom = Number(tokenCost || 0);
  const crystals = (crystalCost !== undefined && crystalCost !== null) ? Number(crystalCost) : Math.round(denom * (window.CRYSTAL_MULTIPLIER || 2.5));
  const payload = {
    serial: `PRG-${denom.toFixed(2)}-${Date.now()}`,
    product_id: name,
    title: name,
    denomination: denom,
    tokenCount: denom,
    cashValue: Number((denom * (window.CASH_PER_PRESTIGE || 0.25)).toFixed(2)),
    crystals,
    status: 'Pending'
  };

  // Render or update cart item
  const rendered = renderCartItem(payload);
  if (rendered) {
    // update counters only once per add
    if (type !== 'crystal') cartTokenTotal += Number(rendered.tokenCount || 0);
    if (type !== 'token') cartCrystalTotal += Number(rendered.crystals || 0);
    cartItems += 1;
    updateCartDisplay();
  }

  // Persist to localStorage without overwriting unrelated entries
  try {
    const existing = JSON.parse(localStorage.getItem('prestigeCartItems') || '[]');
    // dedupe only if exact serial or product_id matches; otherwise keep existing entries
    const key = String(payload.serial || payload.product_id || '');
    const filtered = existing.filter(it => String(it.serial || it.product_id || '') !== key);
    filtered.push(payload);
    localStorage.setItem('prestigeCartItems', JSON.stringify(filtered));
    localStorage.setItem('prestigeCartUpdatedAt', String(Date.now()));
  } catch (e) { console.warn('persist to localStorage failed', e); }

  // Persist to in-memory STORE if available, but do not remove other entries unless they share the same serial/product_id
  try {
    const norm = (typeof normalize === 'function') ? normalize(payload) : payload;
    if (typeof persist === 'function') {
      const existingStore = Array.isArray(STORE) ? STORE.slice() : [];
      const deduped = existingStore.filter(it => String(it.serial || it.product_id || '') !== String(norm.serial || norm.product_id));
      deduped.unshift(norm);
      persist(deduped);
    } else {
      window.STORE = (Array.isArray(window.STORE) ? window.STORE.filter(it => String(it.serial || it.product_id || '') !== String(norm.serial || norm.product_id)) : []).concat([norm]);
      try { window.USE_MAP = (window.STORE||[]).reduce((m,p)=>{ m[String(p.product_id||p.serial)] = p; return m; }, {}); } catch(e){}
    }
    if (typeof renderFromStorage === 'function') renderFromStorage();
  } catch (e) { console.warn('persist canonical failed', e); }

  try { document.dispatchEvent(new CustomEvent('prestige:cartItemAdded', { detail: { payload } })); } catch (e) {}
}

</script>
<script>
// --- Utility: parse Google Sheets GViz JSON ---
async function loadSheet(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/1Gppnlp80FqgOzeUERsSmLp5pZ4E9tvhfbt22NKtUbk8/gviz/tq?sheet=${sheetName}&tqx=out:json`;
  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substr(47).slice(0, -2));
  return json.table.rows.map(r => r.c.map(c => c ? c.v : ""));
}

// --- COMMUNITY drip feed ---
let communityRows = [], communityIndex = 0;
async function initCommunityFeed(){
  communityRows = await loadSheet("Community");
  communityIndex = 0;
  revealNextCommunity();
  setInterval(revealNextCommunity, 60000); // one every 60s
}
function revealNextCommunity(){
  if (communityIndex >= communityRows.length) return;
  const r = communityRows[communityIndex];
  const box = document.getElementById("liveFeed");
  if (!box) return;
  const el = document.createElement("div");
  el.className = "feed-item fadeSlide"; // fade-in refinement
  el.textContent = `ü§ù ${r[0]}  ${r[1]} ${r[2] ? "(" + r[2] + ")" : ""}`;
  box.prepend(el);
  // keep last 6 visible
  while (box.children.length > 6) box.removeChild(box.lastChild);
  communityIndex++;
}

// --- ADS drip feed ---
let adsRows = [], adsIndex = 0;
async function initAdsFeed(){
  adsRows = await loadSheet("Ads");
  adsIndex = 0;
  revealNextAd();
  setInterval(revealNextAd, 45000); // one every 45s
}
function revealNextAd(){
  if (adsRows.length === 0) return;
  const r = adsRows[adsIndex % adsRows.length]; // loop refinement
  const board = document.getElementById("billboard");
  if (!board) return;
  const article = document.createElement("article");
  article.className = "billboard-article fadeSlide";
  article.innerHTML = `
    <div class="billboard-image"></div>
    <div class="billboard-title">${r[0]}</div>
    <div class="billboard-sub">${r[1]} ${r[2] ? "(" + r[2] + ")" : ""}</div>
    <span class="badge">AD</span>
  `;
  board.prepend(article);
  while (board.children.length > 4) board.removeChild(board.lastChild);
  adsIndex++;
}

// --- FAITH drip feed ---
let faithRows = [], faithIndex = 0;

async function initFaithFeed(){
  faithRows = await loadSheet("Faith");
  faithIndex = 0;
  revealNextFaith();
  setInterval(revealNextFaith, 45000); // one every 45s
}

function revealNextFaith(){
  if (faithRows.length === 0) return;
  const r = faithRows[faithIndex % faithRows.length];
  const log = document.getElementById("prayerLog");
  if (!log) return;

  const el = document.createElement("div");
  el.className = "feed-item fadeSlide";

  // richer markup with badge
  el.innerHTML = `
    <div class="faith-title">üïä ${r[0]}</div>
    <div class="faith-message">${r[1]} ${r[2] ? "(" + r[2] + ")" : ""}</div>
    <span class="badge">FAITH</span>
  `;

  log.prepend(el);

  // keep only last 6 prayers visible
  while (log.children.length > 6) {
    log.removeChild(log.lastChild);
  }

  faithIndex++;
}

  
  
  
  
  
  
  // --- Master controller ---
async function renderController(action, options = {}){
  switch(action){
    case "login":
      await renderUserCard();
      if (options.userName) {
        await renderPurchaseHistory(options.userName);
      }
      break;
    case "logout":
      await renderLedger();
      break;
    case "finalize":
      await renderLedger();
      if (options.userName) {
        await renderPurchaseHistory(options.userName);
      }
      break;
    case "viewHistory":
      if (options.userName) {
        await renderPurchaseHistory(options.userName);
      }
      break;
    case "refreshAll":
      await Promise.all([
        renderUserCard(),
        renderLedger(),
        options.userName ? renderPurchaseHistory(options.userName) : Promise.resolve()
      ]);
      break;
    default:
      console.warn("Unknown render action:", action);
  }
}

// --- Initialize all feeds ---
document.addEventListener("DOMContentLoaded", () => {
  initCommunityFeed();
  initAdsFeed();
  initFaithFeed();
});
</script>
<script>
// Attach hover preview + cart logic to all product cards
document.addEventListener("DOMContentLoaded", () => {
  const info = document.getElementById("infoImg"); // the void preview panel
  const cartCountEl = document.getElementById("cartCount");
  const cartLog = document.getElementById("cartLog");

  let cartCount = 0;

  document.querySelectorAll(".product-card").forEach(card => {
    const titleEl = card.querySelector(".product-title");
    const title = titleEl ? titleEl.textContent : "Item";

    // Hover preview
    card.addEventListener("mouseenter", () => {
      if (info){
        info.style.backgroundImage = "url('/assets/" + title.toLowerCase().replace(/\s+/g,'-') + ".png')";
        info.style.backgroundSize = "cover";
        info.style.backgroundPosition = "center";
        info.classList.add("glow");
      }
    });
    card.addEventListener("mouseleave", () => {
      if (info){
        info.style.backgroundImage = "";
        info.classList.remove("glow");
      }
    });

    
  
  // --- DO NOT TOUCH,CART & ACCESS CAUSES A RIFF ---

  </script>
<div id="floatingCart" class="floating-cart frost">
  üõí <span id="floatingCartCount">0</span> items
  <button class="ghost-btn" onclick="showChamber('checkoutPanel')">Checkout</button>
</div>
</script><script>
function getCurrentCartItems(){
  return Array.from(document.querySelectorAll('.cart-item')).map(el => {
    return {
      name: el.querySelector('.cart-name')?.textContent || "Unknown",
      tokenCost: Number(el.querySelector('.cart-tokens')?.textContent || 0),
      crystalCost: Number(el.querySelector('.cart-crystals')?.textContent || 0),
      finalized: el.classList.contains('finalized'),
      verifiedBy: el.getAttribute('data-verified-by') || null
    };
  });
}




// --- Cart sync helper ---
function syncCartFromUser(u, opts = { resetCartCountOnLogin: false }){
  if(!u) return;
  sessionStorage.setItem('activeAccountId', u.accessCode || u.card || u.user);
  window.currentUserId = sessionStorage.getItem('activeAccountId');

  
  const purchasedEl = document.getElementById('purchasedCount');
  const symbolicEl  = document.getElementById('symbolicCount');
  if(purchasedEl) purchasedEl.textContent = Number(u.purchased || 0);
  if(symbolicEl)  symbolicEl.textContent  = Number(u.symbolic || 0);

  document.querySelectorAll('.floating-cart, .checkout-cart').forEach(container => {
    let row = container.querySelector('.cart-balance-row');
    if(!row){
      row = document.createElement('div');
      row.className = 'cart-balance-row';
      row.style.marginTop = '6px';
      row.style.fontSize = '0.95rem';
      row.style.color = 'var(--muted)';
      row.style.display = 'flex';
      row.style.gap = '10px';
      container.appendChild(row);
    }
    row.innerHTML = `<div><strong>Purchased</strong>: <span class="cart-bal-tokens">${Number(u.purchased||0)}</span></div>
                     <div><strong>Symbolic</strong>: <span class="cart-bal-symbolic">${Number(u.symbolic||0)}</span></div>`;
  });

  if(opts.resetCartCountOnLogin){
    const cartCount = document.getElementById('cartCount');
    const floatBadge = document.getElementById('floatingCartCount');
    if(cartCount) cartCount.textContent = '0';
    if(floatBadge) floatBadge.textContent = '0';
  }
}

// --- Validate login ---
          
// --- Validate login ---
async function loginUser(e){
  e?.preventDefault?.();
  const username = document.getElementById("loginUser").value.trim();
  const code = document.getElementById("loginCode").value.trim();
  const statusEl = document.getElementById("loginStatus");

  statusEl.textContent = "Checking access code";
  statusEl.className = "status pending";

  const accounts = await fetchUserDirectory();   // <-- use User Directory
  const match = accounts.find(r => r.accessCode === code && r.user === username);

  if (match){
    sessionStorage.setItem("username", match.user);
    sessionStorage.setItem("accessCode", match.accessCode);

    statusEl.textContent = "Login successful";
    statusEl.className = "status finalized";

    document.getElementById("userDirectory")?.classList.add("active");
    document.getElementById("loginPanel")?.classList.remove("active");

    await renderUserCard();
    syncCartFromUser(match, { resetCartCountOnLogin: true });
  } else {
    statusEl.textContent = "INVALID USERNAME OR ACCESS CODE";
    statusEl.className = "status pending";
  }
}

// --- Lookup user by access code ---
async function getUserByAccessCode(code){
  const accounts = await fetchUserDirectory();   // <-- use User Directory
  return accounts.find(acc => String(acc.accessCode).trim() === String(code).trim()) || null;
}


// --- Render user card ---
async function renderUserCard(){
  const username = sessionStorage.getItem("username");
  const code = sessionStorage.getItem("accessCode");
  if (!username || !code) return;

  // Pull user basics from User Directory
  const accounts = await fetchUserDirectory();
  const u = accounts.find(acc => String(acc.accessCode).trim() === String(code).trim());
  if (!u) return;

  // Pull current finalized status from Finalized Ledger (truth source)
const ledger = await fetchFinalizedLedger();
const finalizedRow = ledger.find(row => String(row.user).trim() === String(u.user).trim());
const status = finalizedRow ? finalizedRow.status : "Pending";
const glowClass = String(status).toLowerCase() === "finalized" ? "glow-gold" : "glow-silver";

const grid = document.querySelector("#userDirectory .user-grid");
if (!grid) return;

grid.innerHTML = `
  <div class="user-card frost" data-user-id="${u.card || u.user}">
    <div class="crest-avatar"></div>
    <div class="user-meta">
      <div class="account-name">${u.user}</div>
      <div class="card-id">PrestigePayCard: ${u.card}</div>
      <div class="verified-by">
        Verified by: ${finalizedRow ? (finalizedRow.verifiedBy || "Prestige Member") : "‚Äî"}
      </div>
      <div class="token-balance">ü™ô ${u.purchased} | ‚ô¶Ô∏è ${u.symbolic}</div>
      <div class="status ${glowClass}"></div>
    </div>
  </div>
`;


  // Sync balances to cart UI from User Directory (not from ledger)
  syncCartFromUser(u, { resetCartCountOnLogin: false });

  // Render history from Purchase History
  renderPurchaseHistory(u.user);
}


// --- Render ledger ---
// --- Render ledger ---
async function renderLedger(){
  const ledger = await fetchFinalizedLedger();
  const grid = document.getElementById("ledgerGrid");
  if (!grid) return;

  // Detect if purchased/symbolic columns exist in the data
  const hasBalances = ledger.some(u => u.purchased !== undefined || u.symbolic !== undefined);

  grid.innerHTML = `
  <table class="prestige-sheet">
    <tr>
      <th>User</th>
      <th>Transaction</th>
      <th>Status</th>
      <th>Verified By</th>
      <th>Finalize Code</th>
      <th>Finalize Expiry</th>
      ${hasBalances ? `<th>Purchased ü™ô</th><th>Symbolic ‚ô¶Ô∏è</th>` : ""}
    </tr>
    ${ledger.map(l => {
      const ledgerStatus = String(l.status || "Pending").trim();
      const ledgerVerifiedBy = l.verifiedBy || "‚Äî";
      const glowClass = ledgerStatus.toLowerCase() === "finalized" ? "glow-gold" : "glow-silver";

      return `
        <tr>
          <td>${l.user}</td>
          <td>${l.transaction}</td>
          <td class="${glowClass}">${ledgerStatus}</td>
          <td>${ledgerVerifiedBy}</td>
          <td>${l.finalizeCode || ""}</td>
          <td>${l.finalizeExpiry || ""}</td>
          ${hasBalances ? `<td>${l.purchased || "0"}</td><td>${l.symbolic || "0"}</td>` : ""}
        </tr>`;
    }).join("")}
  </table>
`;

}




// --- Render purchase history ---
// --- Render purchase history ---
async function renderPurchaseHistory(userName){
  const history = await fetchPurchaseHistory();
  const ledger  = await fetchFinalizedLedger();

  const rows = history.filter(r => String(r.user).trim() === String(userName).trim());
  const box = document.getElementById("purchaseHistory");
  if(!box) return;

  box.innerHTML = `
    <h4>Purchase History</h4>
    <table class="prestige-sheet">
      <tr>
        <th>User</th>
        <th>Transaction</th>
        <th>Status</th>
        <th>Verified By</th>
        <th>Date</th>
        <th>Notes</th>
      </tr>
      ${rows.map(h => {
  // Scoped variables for Purchase History
  const historyStatus = String(h.status || "Pending").trim().toLowerCase();
  const historyVerifiedBy = h.verifiedBy || "‚Äî";
  const glowClass = historyStatus === "finalized" ? "history-gold" : "history-silver";

  return `
    <tr>
      <td>${h.user}</td>
      <td>${h.transaction}</td>
      <td class="${glowClass}">${historyStatus}</td>
      <td>${historyVerifiedBy}</td>
      <td>${h.date || ""}</td>
      <td>${h.notes || ""}</td>
    </tr>`;
}).join("")}

    </table>
  `;
}




// --- NEW: Finalize handler (continued) ---
async function consumeFinalizeCodeFromSheet(code){
  const ledger = await fetchFinalizedLedger();
  const history = await fetchPurchaseHistory();

  const match = ledger.find(r => String(r.finalizeCode || "").trim() === String(code).trim());
  if (!match) {
    setFinalizeStatus("X FINALIZE CODE INVALID", "glow-silver");
    return false;
  }

  if (match.finalizeExpiry){
    const expiry = new Date(match.finalizeExpiry);
    if (Date.now() > expiry.getTime()){
      setFinalizeStatus("X CODE EXPIRED", "glow-silver");
      return false;
    }
  }

  // üîé Check Purchase History tab for this user/transaction
  const historyMatch = history.find(h =>
    String(h.user).trim() === String(match.user).trim() &&
    String(h.transaction).trim() === String(match.transaction).trim()
  );

  const status = historyMatch ? historyMatch.status : "Pending";
  const normalized = String(status || "Pending").trim().toLowerCase();
  const glowClass = normalized === "finalized" ? "glow-gold" : "glow-silver";
  const verifiedBy = match.verifiedBy || "Prestige Member";

  setFinalizeStatus(` ${status} by ${verifiedBy}`, glowClass);

  // Refresh panels
  await renderUserCard();
  await renderPurchaseHistory(match.user);
  await renderLedger();

  // üîë Flip shimmer to gold only if Purchase History says Finalized
  if (normalized === "finalized") {
    document.querySelectorAll('.cart-item').forEach(el => {
      const codeAttr = el.getAttribute('data-finalize-code');
      if (String(codeAttr).trim() === String(match.finalizeCode).trim()) {
        el.classList.remove('pending','shimmer','glow-silver');
        el.classList.add('finalized','glow-gold');
        const statusEl = el.querySelector('.cart-status');
        if (statusEl) {
          statusEl.textContent = ` Finalized by ${verifiedBy}`;
        }
      }
    });
    console.info("Shimmer flipped to gold for finalized items (Purchase History confirmed).");
  }

  return true;
}


function setFinalizeStatus(text, cssClass){
  const el = document.getElementById("finalizeStatus");
  if (!el) return;
  el.textContent = text;
  el.className = `status ${cssClass}`;
}

// --- Wiring ---
document.addEventListener("DOMContentLoaded", () => {
  // Login
  ddocument.getElementById("loginBtn")?.addEventListener("click", async () => {
  const username = sessionStorage.getItem("username");
  if (username) {
    await renderController("login", { userName: username });
  }
});

  document.getElementById("loginCode")?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") loginUser(e);
  });
  // Logout
  document.getElementById("logoutBtn")?.addEventListener("click", () => {
    sessionStorage.clear();
    document.getElementById("userDirectory")?.classList.remove("active");
    document.getElementById("loginPanel")?.classList.add("active");
    renderLedger();

    // Clear header/cart balances
    const purchasedEl = document.getElementById('purchasedCount');
    const symbolicEl  = document.getElementById('symbolicCount');
    if (purchasedEl) purchasedEl.textContent = '0';
    if (symbolicEl)  symbolicEl.textContent  = '0';
    const cartCount = document.getElementById('cartCount');
    const floatBadge = document.getElementById('floatingCartCount');
    if(cartCount) cartCount.textContent = '0';
    if(floatBadge) floatBadge.textContent = '0';
    document.querySelectorAll('.cart-balance-row').forEach(r => r.remove());
  });

  // Finalize
  document.getElementById("finalizeBtn")?.addEventListener("click", async () => {
    const entered = document.getElementById("finalizeCode")?.value.trim();
    if (!entered) return;
    await consumeFinalizeCodeFromSheet(entered);
  });
});

// --- On load: show ledger only ---
window.onload = () => {
  renderLedger();
  const loginPanel = document.getElementById("loginPanel");
  if (loginPanel) loginPanel.classList.add("active", "frost");

  // If session exists, sync cart from that user on page load
  const code = sessionStorage.getItem('accessCode');
  if (code) {
    getUserByAccessCode(code).then(u => { if(u) syncCartFromUser(u, { resetCartCountOnLogin: false }); });
  }
};

// --- Polling: refresh every 15s ---
setInterval(() => {
  renderLedger();
  renderUserCard();
}, 15000);

// Safety: ensure status element updates (defensive)
try {
  const status = document.getElementById('loginStatus');
  if (status) {
    status.classList.remove('pending');
    status.classList.add('finalized');
    status.textContent = ' Finalized in Prestige Ledger';
  }
} catch(e){ /* ignore if not present */ }
</script>


          



  <script>
document.getElementById("logoutBtn")?.addEventListener("click", () => {
  sessionStorage.clear();

  // Reset token counters
  const purchasedEl = document.getElementById("purchasedCount");
  const symbolicEl  = document.getElementById("symbolicCount");
  if (purchasedEl) purchasedEl.textContent = "0";
  if (symbolicEl)  symbolicEl.textContent  = "0";

  // Update status message
  const statusEl = document.getElementById("loginStatus");
  if (statusEl){
    statusEl.textContent = "Logout successful";
    statusEl.className = "status finalized";
  }

  document.getElementById("userDirectory")?.classList.remove("active");
  document.getElementById("loginPanel")?.classList.add("active");

  renderLedger();
});
document.addEventListener("DOMContentLoaded", () => {
  // Reveal access code input field
  document.getElementById("revealCodeBtn")?.addEventListener("click", () => {
    document.getElementById("accessCodeWrapper").style.display = "block";
    document.getElementById("revealCodeBtn").style.display = "none";
  });

  // Toggle visibility of access code characters
  document.getElementById("toggleCodeBtn")?.addEventListener("click", () => {
    const codeInput = document.getElementById("loginCode");
    const isMasked = codeInput.type === "password";
    codeInput.type = isMasked ? "text" : "password";
    document.getElementById("toggleCodeBtn").textContent = isMasked ? "üôà Hide" : "üëÅ Reveal";
  });

  // Login logic
  document.getElementById("loginBtn")?.addEventListener("click", loginUser);
  document.getElementById("loginCode")?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") loginUser(e);
  });
});
// Unlock: remove frost (visual reveal), maintain pending state
function unlockFrostedObject(){
  const veil = document.querySelector('#imgVoid .frost-overlay');
  if (veil) veil.style.display = 'none';

  const status = document.querySelector('#imgVoid .object-status');
  if (status){
    status.textContent = 'Unlocked ~ Awaiting member finalization';
    status.classList.remove('finalized');
    status.classList.add('pending');
  }
}

// Apply finalized state only when sheet confirms
function applyFinalizedState(){
  const container = document.getElementById('imgVoid');
  const status = container?.querySelector('.object-status');
  if (container) container.classList.add('finalized');
  if (status){
    status.textContent = ' Finalized in Prestige Ledger';
    status.classList.remove('pending');
    status.classList.add('finalized');
  }
}

// Optional: parallax hover for live presence
(function attachParallax(){
  const container = document.getElementById('imgVoid');
  const stack = container?.querySelector('.ring-stack');
  if (!container || !stack) return;

  let hovering = false;
  const base = 'translate(-50%, -50%)';

  container.addEventListener('mousemove', (e) => {
    hovering = true;
    const r = container.getBoundingClientRect();
    const x = ((e.clientX - r.left) / r.width - 0.5) * 12;   // yaw
    const y = ((e.clientY - r.top) / r.height - 0.5) * -10;  // pitch
    stack.style.animation = 'none'; // pause float/spin on hover
    stack.style.transform = `${base} rotateX(${y}deg) rotateY(${x}deg)`;
  });

  container.addEventListener('mouseleave', () => {
    hovering = false;
    stack.style.transform = '';
    stack.style.animation = 'floatY 4.2s ease-in-out infinite, slowSpin 14s linear infinite';
  });
})();
function showPanel(panelId) {
  document.querySelectorAll('.chamber-panel').forEach(p => {
    p.classList.remove('active');
  });
  document.getElementById(panelId).classList.add('active');
}
document.querySelectorAll('.billboard').forEach((bb, i) => {
  bb.style.animationDelay = `${i * 0.2}s`; // stagger each billboard
});

</script>

<script>
/* Populate hidden username/email from directory card into #loveform fields */
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('loveform');
  if (!form) return;

  // Try common directory selectors; prefer data attributes if present
  const dirCard = document.querySelector('#userDirectory .user.active') || document.querySelector('#userDirectory .user') || document.querySelector('#userDirectory');
  let name = '', email = '';

  if (dirCard) {
    name = dirCard.getAttribute('data-username') || dirCard.querySelector('.account-name')?.textContent?.trim() || dirCard.querySelector('.user-name')?.textContent?.trim() || '';
    email = dirCard.getAttribute('data-email') || dirCard.querySelector('.account-email')?.textContent?.trim() || '';
  }

  // Fallbacks: sessionStorage or login input
  if (!name) name = sessionStorage.getItem('username') || document.getElementById('loginUser')?.value || '';
  if (!email) email = sessionStorage.getItem('userEmail') || '';

  // Write into hidden form fields
  const u = document.getElementById('loveform_username');
  const e = document.getElementById('loveform_email');
  if (u) u.value = name;
  if (e) e.value = email;
});
</script>

<script>

// Cart-scoped markItemsGold ‚Äî finalizes only items inside cart containers
(function(){
  if(window.__markItemsGoldCartScoped) return;
  window.__markItemsGoldCartScoped = true;

  // update this list to match your cart container(s)
  const CART_CONTAINERS = ['#checkoutPanel', '.checkout-cart', '.cart-list', '#cartPanel', '.floating-cart'];

  function _applyGoldToCartItem(el){
    if(!el || el.__goldAppliedCart) return;
    el.__goldAppliedCart = true;
    // only change classes/text inside the cart item
    el.classList.remove('pending','shimmer','status-pend');
    el.classList.add('finalized','gold');
    const status = el.querySelector('.status, .product-status, .badge');
    if(status) status.textContent = 'Verified';
    // counters inside card
    el.querySelectorAll('.counter, .price, .product-status').forEach(c=>{
      c.classList.remove('silver');
      c.classList.add('gold');
    });
    // visual tweak limited to this element
    try { el.style.boxShadow = el.style.boxShadow || '0 0 12px rgba(255,216,122,0.28)'; } catch(e){}
  }

  function markItemsGoldInCart(){
    const containers = CART_CONTAINERS.map(s => document.querySelector(s)).filter(Boolean);
    if(!containers.length) { console.info('markItemsGoldInCart: no cart containers found'); return false; }
    const nodes = new Set();
    containers.forEach(c => c.querySelectorAll('.cart-item, .cart-item.pending, .product-card').forEach(n => nodes.add(n)));
    if(!nodes.size) { console.info('markItemsGoldInCart: no cart items found'); return false; }
    nodes.forEach(_applyGoldToCartItem);
    console.info('markItemsGoldInCart: finalized', nodes.size, 'cart item(s).');
    return true;
  }

  // expose
  window.markItemsGoldInCart = markItemsGoldInCart;

  // auto-hook after verification (safe: only calls cart-scoped function)
  


</script><script>
/
// Cart-scoped markItemsGold ‚Äî finalizes only items inside cart containers
(function(){
  if(window.__markItemsGoldCartScoped) return;
  window.__markItemsGoldCartScoped = true;

  // update this list to match your cart container(s)
  const CART_CONTAINERS = ['#checkoutPanel', '.checkout-cart', '.cart-list', '#cartPanel', '.floating-cart'];

  function _applyGoldToCartItem(el){
    if(!el || el.__goldAppliedCart) return;
    el.__goldAppliedCart = true;
    // only change classes/text inside the cart item
    el.classList.remove('pending','shimmer','status-pend');
    el.classList.add('finalized','gold');
    const status = el.querySelector('.status, .product-status, .badge');
    if(status) status.textContent = 'Verified';
    // counters inside card
    el.querySelectorAll('.counter, .price, .product-status').forEach(c=>{
      c.classList.remove('silver');
      c.classList.add('gold');
    });
    // visual tweak limited to this element
    try { el.style.boxShadow = el.style.boxShadow || '0 0 12px rgba(255,216,122,0.28)'; } catch(e){}
  }

  function markItemsGoldInCart(){
    const containers = CART_CONTAINERS.map(s => document.querySelector(s)).filter(Boolean);
    if(!containers.length) { console.info('markItemsGoldInCart: no cart containers found'); return false; }
    const nodes = new Set();
    containers.forEach(c => c.querySelectorAll('.cart-item, .product-card').forEach(n => nodes.add(n)));
    if(!nodes.size) { console.info('markItemsGoldInCart: no cart items found'); return false; }
    nodes.forEach(_applyGoldToCartItem);
    console.info('markItemsGoldInCart: finalized', nodes.size, 'cart item(s).');
    return true;
  }

  // expose for sheet finalize handler
  window.markItemsGoldInCart = markItemsGoldInCart;

  console.info('markItemsGoldInCart installed ‚Äî call markItemsGoldInCart() after sheet verification.');
})();


</script>
<script>
(function(){
  'use strict';
  document.addEventListener('DOMContentLoaded', () => {
    // CONFIG
    const PRESTIGE_NUMBER = window.PRESTIGE_NUMBER || '+16164391862';
    const SUPPORT_EMAIL = window.SUPPORT_EMAIL || 'orginator+store@icloud.com';
    const JITSI_BASE = window.JITSI_BASE || 'https://meet.jit.si';

    // DOM helpers
    const $id = id => document.getElementById(id);
    const $q = sel => document.querySelector(sel);

    // Hooks
    const buzzer = $id('prestigeBuzzer') || $q('.prestige-buzzer') || $q('#prestigeSlotFinal .prestige-buzzer');
    const widget = $id('prestigeWidgetFinal') || $id('prestigeWidget') || $q('.prestige-widget-final') || $q('.prestige-widget');
    const nameInput = $id('pfName') || widget?.querySelector('input[placeholder*="name"]');
    const phoneInput = $id('pfPhone') || widget?.querySelector('input[placeholder*="Phone"]');
    const issueInput = $id('pfIssue') || widget?.querySelector('input[placeholder*="issue"], textarea');
    const smsBtn = $id('pfSendSms') || widget?.querySelector('#pfSendSms, .send, .prestige-send');
    const emailBtn = $id('pfSendEmail') || widget?.querySelector('#pfSendEmail, .send:nth-of-type(2), .prestige-send.ghost');

    // Unified issue textarea: stretchy auto-expand + wrap/typewriter toggle (autosize works in both modes)
(function installPrestigeIssueEnhancements_v2(){
  if (window.__prestige_issue_enhancements_v2_installed) return;
  window.__prestige_issue_enhancements_v2_installed = true;

  const MODE_KEY = 'prestigeIssueWrapMode'; // 'wrap' or 'typewriter'
  const STYLE_ID = 'prestige-issue-style-v2';
  const TOGGLE_STYLE_ID = 'prestige-issue-wrap-style-v2';

  // Base textarea styles
  if (!document.getElementById(STYLE_ID)) {
    const s = document.createElement('style');
    s.id = STYLE_ID;
    s.textContent = `
      .prestige-issue-textarea {
        min-height: 96px;
        max-height: 70vh;
        width: 100%;
        box-sizing: border-box;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid rgba(33,50,74,0.9);
        background: #071028;
        color: #e6eef8;
        resize: vertical;
        overflow: auto;
        font-size: 14px;
        line-height: 1.4;
        transition: background-color 120ms ease;
        white-space: pre-wrap; /* default */
        overflow-wrap: break-word;
      }
    `;
    document.head.appendChild(s);
  }

  // Toggle UI styles
  if (!document.getElementById(TOGGLE_STYLE_ID)) {
    const style = document.createElement('style');
    style.id = TOGGLE_STYLE_ID;
    style.textContent = `
      .prestige-issue-textarea.prestige-wrap {
        white-space: pre-wrap;
        overflow-wrap: break-word;
        overflow-x: hidden;
        font-family: inherit;
      }
      .prestige-issue-textarea.prestige-typewriter {
        white-space: pre; /* preserve spaces and line breaks, no wrapping */
        overflow-x: auto;
        overflow-y: auto;
        resize: horizontal;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
      }
      .prestige-issue-toggle {
        display:inline-flex;
        gap:8px;
        align-items:center;
        margin-top:8px;
        font-size:13px;
        color:#9fb0d6;
      }
      .prestige-issue-toggle button {
        background:transparent;
        border:1px solid rgba(255,255,255,0.06);
        color:#e6eef8;
        padding:6px 8px;
        border-radius:6px;
        cursor:pointer;
      }
      .prestige-issue-toggle button.active {
        background: rgba(255,255,255,0.06);
        border-color: rgba(255,255,255,0.12);
      }
    `;
    document.head.appendChild(style);
  }

  // Find original input/textarea
  function findOriginal() {
    return document.getElementById('pfIssue')
      || document.querySelector('.prestige-widget input[placeholder*="issue"], .prestige-widget textarea[placeholder*="issue"], input[placeholder*="issue"], textarea[placeholder*="issue"]')
      || document.querySelector('input[name="issue"], textarea[name="issue"]');
  }

  // Create or normalize textarea
  function ensureTextarea() {
    const orig = findOriginal();
    if (!orig) return null;

    if (orig.tagName === 'TEXTAREA' && orig.classList.contains('prestige-issue-textarea')) {
      return orig;
    }

    if (orig.tagName === 'TEXTAREA') {
      orig.classList.add('prestige-issue-textarea');
      attachAutosize(orig);
      return orig;
    }

    const ta = document.createElement('textarea');
    ta.className = (orig.className ? orig.className + ' ' : '') + 'prestige-issue-textarea';
    ta.id = orig.id || 'pfIssue';
    if (orig.name) ta.name = orig.name;
    if (orig.placeholder) ta.placeholder = orig.placeholder;
    if (orig.getAttribute('aria-label')) ta.setAttribute('aria-label', orig.getAttribute('aria-label'));
    if (orig.getAttribute('aria-describedby')) ta.setAttribute('aria-describedby', orig.getAttribute('aria-describedby'));
    try { Object.keys(orig.dataset || {}).forEach(k => { ta.dataset[k] = orig.dataset[k]; }); } catch(e){}
    ta.value = (orig.value || orig.textContent || '').trim();

    try { orig.parentNode && orig.parentNode.replaceChild(ta, orig); } catch(e){ console.warn('prestige: replace issue input failed', e); return null; }

    attachAutosize(ta);
    return ta;
  }

  // Autosize: works in both modes. It measures scrollHeight and sets height.
  function attachAutosize(textarea) {
    if (!textarea || textarea.__prestige_autosize) return;
    textarea.__prestige_autosize = true;

    function resizeNow() {
      try {
        // Always allow autosize: measure scrollHeight and set height.
        // For typewriter mode (white-space: pre), long single lines will increase scrollWidth,
        // but scrollHeight still grows when user inserts newlines; we still expand vertically.
        textarea.style.height = 'auto';
        const sh = textarea.scrollHeight;
        textarea.style.height = Math.max(96, sh) + 'px';
      } catch(e){}
    }

    // initial resize
    setTimeout(resizeNow, 0);

    textarea.addEventListener('input', resizeNow, { passive: true });
    textarea.addEventListener('change', resizeNow, { passive: true });
    window.addEventListener('resize', resizeNow, { passive: true });

    // expose manual trigger
    textarea.__prestige_resizeNow = resizeNow;
  }

  // Toggle UI: create and insert after textarea (idempotent)
  function ensureToggleUI() {
    const ta = ensureTextarea();
    if (!ta) return null;

    let container = ta.parentNode && ta.parentNode.querySelector('.prestige-issue-toggle');
    if (!container) {
      container = document.createElement('div');
      container.className = 'prestige-issue-toggle';
      container.innerHTML = `
        <div style="font-size:12px;color:#9fb0d6">Input mode:</div>
        <button type="button" data-mode="wrap" title="Wrap lines (recommended)">Wrap</button>
        <button type="button" data-mode="typewriter" title="Typewriter: horizontal scroll">Typewriter</button>
      `;
      try { ta.parentNode.insertBefore(container, ta.nextSibling); } catch(e){ ta.parentNode.appendChild(container); }
    }

    const wrapBtn = container.querySelector('button[data-mode="wrap"]');
    const typeBtn = container.querySelector('button[data-mode="typewriter"]');

    // Apply saved mode
    const saved = localStorage.getItem(MODE_KEY) || 'wrap';
    applyMode(ta, saved, { skipSave:true });

    // Attach handlers idempotently
    if (!wrapBtn.__prestige_bound) {
      wrapBtn.addEventListener('click', () => applyMode(ensureTextarea(), 'wrap'), true);
      wrapBtn.__prestige_bound = true;
    }
    if (!typeBtn.__prestige_bound) {
      typeBtn.addEventListener('click', () => applyMode(ensureTextarea(), 'typewriter'), true);
      typeBtn.__prestige_bound = true;
    }

    return { container, wrapBtn, typeBtn };
  }

  // Apply mode to textarea; autosize remains active in both modes
  function applyMode(textarea, mode, opts = {}) {
    if (!textarea) return;
    mode = (mode === 'typewriter') ? 'typewriter' : 'wrap';
    const wrapBtn = textarea.parentNode && textarea.parentNode.querySelector('.prestige-issue-toggle button[data-mode="wrap"]');
    const typeBtn = textarea.parentNode && textarea.parentNode.querySelector('.prestige-issue-toggle button[data-mode="typewriter"]');

    textarea.classList.remove('prestige-wrap', 'prestige-typewriter');

    if (mode === 'wrap') {
      textarea.classList.add('prestige-wrap');
      // keep autosize active
      textarea.style.resize = 'vertical';
      // ensure wrapping behavior
      textarea.style.whiteSpace = '';
      textarea.style.overflowX = 'hidden';
      // trigger autosize
      if (typeof textarea.__prestige_resizeNow === 'function') textarea.__prestige_resizeNow();
    } else {
      textarea.classList.add('prestige-typewriter');
      // typewriter: preserve spaces/newlines, allow horizontal scroll, but still autosize vertically
      textarea.style.whiteSpace = 'pre';
      textarea.style.overflowX = 'auto';
      textarea.style.resize = 'horizontal';
      // autosize still runs to expand vertically when user adds newlines
      if (typeof textarea.__prestige_resizeNow === 'function') textarea.__prestige_resizeNow();
    }

    if (wrapBtn) wrapBtn.classList.toggle('active', mode === 'wrap');
    if (typeBtn) typeBtn.classList.toggle('active', mode === 'typewriter');

    if (!opts.skipSave) {
      try { localStorage.setItem(MODE_KEY, mode); } catch(e){}
    }
  }

  // Initialization
  function initOnce() {
    const ta = ensureTextarea();
    if (!ta) {
      setTimeout(initOnce, 200);
      return;
    }
    ensureToggleUI();
    // apply saved mode
    const saved = localStorage.getItem(MODE_KEY) || 'wrap';
    applyMode(ta, saved, { skipSave:true });
  }
  initOnce();

  // Observe DOM for dynamic replacements
  const mo = new MutationObserver((mutations) => {
    let needs = false;
    for (const m of mutations) {
      if (m.addedNodes && m.addedNodes.length) {
        for (const n of m.addedNodes) {
          if (n instanceof Element) {
            if (n.matches && (n.matches('#pfIssue') || n.matches('input[placeholder*="issue"], textarea') || n.matches('.prestige-issue-textarea'))) { needs = true; break; }
            if (n.querySelector && (n.querySelector('#pfIssue') || n.querySelector('input[placeholder*="issue"], textarea, .prestige-issue-textarea'))) { needs = true; break; }
          }
        }
      }
      if (needs) break;
    }
    if (needs) setTimeout(() => { initOnce(); }, 80);
  });
  mo.observe(document.body, { childList: true, subtree: true });

  // Public API
  window.Prestige = window.Prestige || {};
  window.Prestige.ensureIssueTextarea = ensureTextarea;
  window.Prestige.setIssueInputMode = function(mode){ const ta = ensureTextarea(); if (ta) applyMode(ta, mode); };
  window.Prestige.getIssueInputMode = function(){ return localStorage.getItem(MODE_KEY) || 'wrap'; };

})();

    // Toggle: wrap vs typewriter mode for pfIssue textarea (idempotent)
(function addIssueWrapToggle(){
  if (window.__prestige_issue_wrap_toggle_installed) return;
  window.__prestige_issue_wrap_toggle_installed = true;

  const KEY = 'prestigeIssueWrapMode'; // 'wrap' or 'typewriter'

  // Ensure the stylesheet for modes exists
  if (!document.getElementById('prestige-issue-wrap-style')) {
    const style = document.createElement('style');
    style.id = 'prestige-issue-wrap-style';
    style.textContent = `
      /* Wrap mode (default) */
      .prestige-issue-textarea.prestige-wrap {
        white-space: pre-wrap;
        overflow-wrap: break-word;
        overflow-x: hidden;
        font-family: inherit;
      }
      /* Typewriter mode: single-line flow with horizontal scroll */
      .prestige-issue-textarea.prestige-typewriter {
        white-space: pre;
        overflow-x: auto;
        overflow-y: auto;
        resize: horizontal;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
      }
      /* Small toggle UI */
      .prestige-issue-toggle {
        display:inline-flex;
        gap:8px;
        align-items:center;
        margin-top:8px;
        font-size:13px;
        color:#9fb0d6;
      }
      .prestige-issue-toggle button {
        background:transparent;
        border:1px solid rgba(255,255,255,0.06);
        color:#e6eef8;
        padding:6px 8px;
        border-radius:6px;
        cursor:pointer;
      }
      .prestige-issue-toggle button.active {
        background: rgba(255,255,255,0.06);
        border-color: rgba(255,255,255,0.12);
      }
    `;
    document.head.appendChild(style);
  }

  // Helper: find the textarea (uses the same selector as your code)
  function findTextarea() {
    return document.querySelector('.prestige-issue-textarea') ||
           document.getElementById('pfIssue') ||
           document.querySelector('.prestige-widget textarea[placeholder*="issue"], textarea[placeholder*="issue"]');
  }

  // Create toggle UI and insert after textarea (idempotent)
  function ensureToggle() {
    const ta = findTextarea();
    if (!ta) return null;

    // wrap class default if missing
    if (!ta.classList.contains('prestige-wrap') && !ta.classList.contains('prestige-typewriter')) {
      ta.classList.add('prestige-wrap');
    }

    // don't duplicate toggle
    let container = ta.parentNode && ta.parentNode.querySelector('.prestige-issue-toggle');
    if (!container) {
      container = document.createElement('div');
      container.className = 'prestige-issue-toggle';
      container.innerHTML = `
        <div style="font-size:12px;color:#9fb0d6">Input mode:</div>
        <button type="button" data-mode="wrap" title="Wrap lines (recommended)">Wrap</button>
        <button type="button" data-mode="typewriter" title="Typewriter: horizontal scroll">Typewriter</button>
      `;
      // insert after textarea
      try { ta.parentNode.insertBefore(container, ta.nextSibling); } catch(e){ ta.parentNode.appendChild(container); }
    }

    const wrapBtn = container.querySelector('button[data-mode="wrap"]');
    const typeBtn = container.querySelector('button[data-mode="typewriter"]');

    // Apply saved mode
    const saved = localStorage.getItem(KEY) || 'wrap';
    applyMode(ta, saved, { skipSave:true });

    // click handlers
    wrapBtn.addEventListener('click', () => applyMode(findTextarea(), 'wrap'), true);
    typeBtn.addEventListener('click', () => applyMode(findTextarea(), 'typewriter'), true);

    // expose for manual use
    return { container, wrapBtn, typeBtn };
  }

  // Apply mode to textarea
  function applyMode(textarea, mode, opts = {}) {
    if (!textarea) return;
    const wrapBtn = textarea.parentNode && textarea.parentNode.querySelector('.prestige-issue-toggle button[data-mode="wrap"]');
    const typeBtn = textarea.parentNode && textarea.parentNode.querySelector('.prestige-issue-toggle button[data-mode="typewriter"]');

    // normalize
    mode = (mode === 'typewriter') ? 'typewriter' : 'wrap';

    // remove both classes then add the chosen one
    textarea.classList.remove('prestige-wrap', 'prestige-typewriter');
    if (mode === 'wrap') {
      textarea.classList.add('prestige-wrap');
      // enable autosize behavior if present
      if (typeof textarea.__prestige_autosize !== 'undefined') {
        // trigger autosize: set height auto then call input event
        textarea.style.height = 'auto';
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
      }
      // allow vertical resize (keeps previous behavior)
      textarea.style.resize = 'vertical';
    } else {
      textarea.classList.add('prestige-typewriter');
      // in typewriter mode, keep a reasonable height and allow horizontal scroll
      textarea.style.height = Math.max(96, textarea.scrollHeight || 96) + 'px';
      // disable autosize if it was attached (so height doesn't jump)
      // we don't remove listeners, but we prevent autosize by setting a flag
      textarea.__prestige_autosize_block = true;
      // allow horizontal resize
      textarea.style.resize = 'horizontal';
    }

    // update toggle UI active state
    if (wrapBtn) wrapBtn.classList.toggle('active', mode === 'wrap');
    if (typeBtn) typeBtn.classList.toggle('active', mode === 'typewriter');

    // persist unless explicitly skipped
    if (!opts.skipSave) {
      try { localStorage.setItem(KEY, mode); } catch(e){}
    }

    // cleanup: if switching back to wrap, remove the autosize block after a tick
    if (mode === 'wrap') {
      setTimeout(() => { if (textarea) textarea.__prestige_autosize_block = false; }, 200);
    }
  }

  // Patch autosize attach to respect __prestige_autosize_block if present
  // (If your existing attachAutosize sets textarea.__prestige_autosize, we just wrap input handler)
  function patchAutosizeBehavior() {
    const ta = findTextarea();
    if (!ta) return;
    // if autosize already attached and we haven't wrapped it, wrap input handler
    if (ta.__prestige_autosize && !ta.__prestige_autosize_wrapped) {
      const origHandler = function resizeNow() {
        try {
          if (ta.__prestige_autosize_block) return; // do nothing in typewriter mode
          ta.style.height = 'auto';
          const sh = ta.scrollHeight;
          ta.style.height = Math.max(96, sh) + 'px';
        } catch(e){}
      };
      // remove existing input listeners by re-adding a safe one (best-effort)
      ta.addEventListener('input', origHandler, { passive: true });
      ta.addEventListener('change', origHandler, { passive: true });
      ta.__prestige_autosize_wrapped = true;
      // initial call
      setTimeout(origHandler, 0);
    }
  }

  // Initial ensure and attach observer for dynamic changes
  function init() {
    const ta = findTextarea();
    if (!ta) {
      // try again later if textarea not present yet
      setTimeout(init, 200);
      return;
    }
    ensureToggle();
    patchAutosizeBehavior();
    // apply saved mode (ensures UI matches)
    const saved = localStorage.getItem(KEY) || 'wrap';
    applyMode(ta, saved, { skipSave:true });
  }

  init();

  // Observe DOM for replacements of the textarea (re-run ensureToggle when it appears)
  const mo = new MutationObserver((mutations) => {
    let needs = false;
    for (const m of mutations) {
      if (m.addedNodes && m.addedNodes.length) {
        for (const n of m.addedNodes) {
          if (n instanceof Element && (n.matches && (n.matches('#pfIssue') || n.matches('textarea') || n.querySelector && n.querySelector('.prestige-issue-textarea')))) {
            needs = true; break;
          }
        }
      }
      if (needs) break;
    }
    if (needs) setTimeout(() => { init(); }, 80);
  });
  mo.observe(document.body, { childList: true, subtree: true });

  // expose API
  window.Prestige = window.Prestige || {};
  window.Prestige.setIssueInputMode = function(mode){ const ta = findTextarea(); if (ta) applyMode(ta, mode); };
  window.Prestige.getIssueInputMode = function(){ return localStorage.getItem(KEY) || 'wrap'; };

})();

    // Modal and hidden staff reply
    let hiddenStaff = $id('prestigeHiddenStaffReply');
    if(!hiddenStaff){
      hiddenStaff = document.createElement('textarea');
      hiddenStaff.id = 'prestigeHiddenStaffReply';
      hiddenStaff.style.display = 'none';
      document.body.appendChild(hiddenStaff);
    }
    const modalEl = $id('prestigeModal') || $q('.prestige-modal');
    const smsTextarea = $id('prestigeSmsText') || (modalEl && modalEl.querySelector('textarea'));
    const copySmsBtn = $id('copySms') || (modalEl && modalEl.querySelector('#copySms'));
    const modalSendEmailBtn = $id('modalSendEmail') || (modalEl && modalEl.querySelector('#modalSendEmail'));
    const closeModalBtn = $id('closeModal') || (modalEl && modalEl.querySelector('#closeModal'));

    // Confirm UI fallback
    const confirmEl = $id('prestigeConfirm') || $q('.prestige-confirm');
    const confirmProceed = $id('confirmProceed') || (confirmEl && confirmEl.querySelector('#confirmProceed'));
    const confirmCancel = $id('confirmCancel') || (confirmEl && confirmEl.querySelector('#confirmCancel'));

    // Basic warnings
    if(!smsBtn) console.warn('Prestige: SMS button not found (pfSendSms).');
    if(!widget) console.warn('Prestige: widget not found (prestigeWidgetFinal).');

    // Utility: generate room id
    function genRoom(prefix='prestige', len=8){
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let s = prefix + '-';
      for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }

    // CART READERS
    function collectCartSummaryLinesDirect(){
      const container = document.querySelector('#cartList') || document.querySelector('.cart, .cart-list');
      const VISUAL = ['.skeleton','.visual-only','[data-shimmer]','[data-visual]'];

      const lines = [];
      if(!container) return lines;
      const items = container.querySelectorAll('.cart-item, .product-card, .cart-row, .cart-entry, .store-item, .item');
      items.forEach(node => {
        try {
          const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null, false);
          let text = '', n;
          while(n = walker.nextNode()){
            let p = n.parentNode, skip = false;
            while(p && p !== document){
              for(const sel of VISUAL){ try{ if(p.matches && p.matches(sel)){ skip = true; break; } }catch(e){} }
              if(skip) break;
              p = p.parentNode;
            }
            if(skip) continue;
            const t = n.nodeValue.replace(/\s+/g,' ').trim();
            if(t) text += (text ? ' ' : '') + t;
          }
          const title = (node.querySelector('.product-title, .title, .name, h4, h3')?.textContent || text || node.getAttribute('data-title') || '').trim();
          const price = (node.querySelector('.price, .product-cost, .item-price')?.textContent || node.getAttribute('data-price') || '').trim();
          const qtyEl = node.querySelector('.qty, .quantity') || node.querySelector('input.qty');
          const qty = qtyEl ? ((qtyEl.value||qtyEl.textContent||'').trim()) : '';
          if(title){
            const parts = [ title.replace(/\b(shimmer|pending|awaiting)\b/ig,'').trim(), qty ? 'x'+qty : '', price ].filter(Boolean);
            lines.push(parts.join(' ‚Ä¢ '));
          }
        } catch(e){
          console.warn('collectCartSummaryLinesDirect parse error', e);
        }
      });
      return lines;
    }

    function buildOneLineCartSummary(maxItems = 3){
      try {
        const lines = collectCartSummaryLinesDirect() || [];
        if(!lines.length) return '';
        const sample = lines.slice(0, maxItems).join('; ');
        return sample.length > 200 ? sample.slice(0,197) + '...' : sample;
      } catch(e){
        return '';
      }
    }
// Replace existing buildSmsPreview with this
function buildSmsPreview(){
 // prefer the enhanced textarea if present
const enhanced = document.querySelector('.prestige-issue-textarea');
const rawIssue = (enhanced ? enhanced.value : (issueInput?.value || '')) || '';
const issue = String(rawIssue).trim();

const name = (nameInput?.value || '').trim();
const phone = (phoneInput?.value || '').trim();

// parse paste area for JSON and identifiers
const pasteArea = document.getElementById('prestigePasteArea') || document.querySelector('textarea#prestigePasteArea');
const pasteText = (pasteArea?.value || '').trim();

// try to parse JSON safely
let parsedJson = null;
try {
  if (pasteText) {
    parsedJson = JSON.parse(pasteText);
  }
} catch (e) {
  parsedJson = null;
}

// identifier extraction: PRG- style and generic token-like strings
const ids = [];
if (pasteText) {
  // PRG- style identifiers
  const prgRe = /\bPRG[-_][A-Z0-9-]+\b/gi;
  let m;
  while ((m = prgRe.exec(pasteText)) !== null) ids.push(m[0]);

  // fallback: token-like uppercase alphanum sequences (6+ chars)
  const tokenRe = /\b[A-Z0-9]{6,}\b/g;
  while ((m = tokenRe.exec(pasteText)) !== null) {
    // avoid duplicating PRG matches
    if (!ids.includes(m[0])) ids.push(m[0]);
  }
}

// generate room link
const room = genRoom('prestige', 8);
const roomLink = `${JITSI_BASE}/${room}`;

// build header lines (preserve internal newlines for issue)
const header = [];
if (name) header.push(`Name: ${name}`);
if (phone) header.push(`Phone: ${phone}`);
if (issue) header.push(`Issue: ${issue}`);

// include parsed JSON when present (pretty-printed, single-line safe fallback)
if (parsedJson) {
  try {
    header.push(`JSON: ${JSON.stringify(parsedJson)}`);
  } catch (e) {
    header.push(`JSON: (parsed)`);
  }
}

// include identifiers if any
if (ids.length) header.push(`Identifiers: ${ids.join(', ')}`);

// always include join link last
header.push(`Join: ${roomLink}`);

// final header string (you can join with '\n\n' or another separator where you use it)
const headerText = header.join('\n\n');

  // join header with single newlines; issue already contains internal newlines
  let body = header.join('\n');

  // cart summary (keeps each line on its own line)
  const cartLines = collectCartSummaryLinesDirect();
  if (cartLines && cartLines.length) {
    body += '\n\nCart:\n' + cartLines.join('\n');
  }

  // friendly footer
  const friendly = `\n\nPrestige Care, we can help verify your purchase and join a secure chatroom (see Join link above).\n\nIf you prefer, our team can also assist by email or call. Prestige members may take 15~30 minutes to respond.`;
  body += friendly;

  // staff reply (short)
  const staffReply = `Hi ${name || '[name]'}, join here: ${roomLink} ‚Äî I‚Äôll join now.`;

  // Safety: if the issue text already contains the room link, avoid adding it twice
  // (we already added roomLink in header; this is just a guard if users pasted it)
  if (issue && issue.includes(roomLink)) {
    // nothing extra to do; header already contains the link
  }

  return { body, staffReply, roomLink };
}

    // Client cart token helpers
    function ensureCartToken(){
      try {
        const KEY = 'prestigeCartToken';
        let token = localStorage.getItem(KEY);
        if(token && typeof token === 'string' && token.length >= 8) return token;
        token = 'cart_' + Math.random().toString(36).slice(2,10);
        localStorage.setItem(KEY, token);
        return token;
      } catch(e){
        console.warn('ensureCartToken failed', e);
        return 'cart_' + Math.random().toString(36).slice(2,10);
      }
    }

    // Snapshot POST
    async function createSnapshotAndGetUrl(){
      try {
        const cartLines = collectCartSummaryLinesDirect();
        const payload = {
          token: ensureCartToken(),
          name: (nameInput?.value || '').trim(),
          phone: (phoneInput?.value || '').trim(),
          issue: (issueInput?.value || '').trim(),
          cartLines,
          pageUrl: window.location.href,
          ts: Date.now()
        };
        const res = await fetch('/api/prestige/snapshot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok){ console.warn('snapshot POST failed', res.status); return null; }
        const json = await res.json();
        if(json.url) return json.url;
        if(json.token) return `${window.location.origin}/p/s/${json.token}`;
        return null;
      } catch(e){
        console.warn('createSnapshotAndGetUrl error', e);
        return null;
      }
    }

    // openPrestigeSms must NOT touch modal UI
    // --- REPLACE openPrestigeSms WITH THIS ---
async function openPrestigeSms(prestigeNumber, messageText){
  const body = String(messageText || '').trim();
  const encoded = encodeURIComponent(body);
  const ua = navigator.userAgent || '';
  const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
  const isAndroid = /Android/.test(ua);

  const candidates = [];
  if(isIOS){
    candidates.push(`sms:${prestigeNumber}&body=${encoded}`);
    candidates.push(`sms:${prestigeNumber}?body=${encoded}`);
  } else {
    candidates.push(`sms:${prestigeNumber}?body=${encoded}`);
    candidates.push(`sms:${prestigeNumber}&body=${encoded}`);
  }

  function tryAnchor(uri){
    return new Promise((resolve) => {
      try {
        const a = document.createElement('a');
        a.href = uri;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=> { try{ a.remove(); }catch(e){}; resolve(true); }, 300);
      } catch(e){ resolve(false); }
    });
  }

  // prefer native share on mobile
  if(navigator.share && (isIOS || isAndroid)){
    try { await navigator.share({ title:'Prestige Care', text: body }); return { status:'shared' }; } catch(e){ /* ignore */ }
  }

  for(const uri of candidates){
    try {
      const ok = await tryAnchor(uri);
      if(ok) return { status:'opened', uri };
    } catch(e){
      console.warn('openPrestigeSms tryAnchor error', e);
    }
  }

  // fallback: copy to clipboard (do not touch modal here)
  try { await navigator.clipboard.writeText(`${body}\n\nPrestige Care: ${prestigeNumber}`); } catch(e){ console.warn('clipboard fallback failed', e); }
  return { status:'fallback' };
}

// --- REPLACE handleSms WITH THIS ---
async function handleSms(){
  try {
    console.debug('Prestige: handleSms start');

 // Build preview and token block
const preview = (typeof buildSmsPreview === 'function')
  ? buildSmsPreview()
  : { body: 'Prestige Care', staffReply: '' };

const token = (typeof ensureCartToken === 'function')
  ? ensureCartToken()
  : ('cart_' + Math.random().toString(36).slice(2,10));

// Only include CartID here, not cart lines (to avoid duplication)
const tokenBlock = `CartID: ${token}\n\n`;

// Populate textarea if present
if (smsTextarea) {
  smsTextarea.value = tokenBlock + (preview.body || '');
} else {
  console.warn('Prestige: smsTextarea not found; modal textarea missing');
}

// Ensure modal exists
if (!modalEl) {
  console.warn('Prestige: modal element not found; falling back to immediate send');
  // fallback: create message and send immediately
  const fallbackMsg = tokenBlock + (preview.body || '');
  await openPrestigeSms(PRESTIGE_NUMBER, fallbackMsg);
  return;
}


    // Ensure a visible CartID badge (click to copy)
    try {
      let tokenBadge = modalEl.querySelector('.prestige-cartid-badge');
      if(!tokenBadge){
        tokenBadge = document.createElement('div');
        tokenBadge.className = 'prestige-cartid-badge';
        tokenBadge.style.cssText = 'font-weight:600;margin-bottom:8px;cursor:pointer;padding:6px 8px;border-radius:4px;background:#f3f4f6;border:1px solid #e5e7eb;';
        modalEl.insertBefore(tokenBadge, modalEl.firstChild);
      }
      tokenBadge.textContent = `CartID: ${token}`;
      tokenBadge.onclick = async () => {
        try { await navigator.clipboard.writeText(token); tokenBadge.textContent = `CartID: ${token} (copied)`; setTimeout(()=> tokenBadge.textContent = `CartID: ${token}`, 1200); } catch(e){ console.warn('copy token failed', e); }
      };
    } catch(e){ console.warn('Prestige: token badge creation failed', e); }

    // Show modal
    modalEl.classList.add('show');
    modalEl.style.display = 'block';
    console.debug('Prestige: modal shown');

    // Find or create Proceed/Cancel buttons inside modal
   // --- Find an existing form proceed/cancel first, otherwise inject modal controls (idempotent) ---
let proceedBtn = null;
let cancelBtn = null;

// 1) Try to find a form-based proceed button (common selectors)
try {
  // common form containers and submit buttons used by many themes
  const formSelectors = [
    'form#prestigeForm', 'form.prestige-form', 'form.checkout', 'form.cart-form',
    '.prestige-form', '.checkout-form', '.cart-form'
  ];
  for(const sel of formSelectors){
    const f = document.querySelector(sel);
    if(!f) continue;
    // prefer explicit submit button
    const submit = f.querySelector('button[type="submit"], input[type="submit"], .form-proceed, .proceed, .submit');
    if(submit){
      proceedBtn = submit;
      // try to find a cancel/reset in the same form
      cancelBtn = f.querySelector('button[type="reset"], .form-cancel, .cancel') || null;
      break;
    }
    // fallback: any button that looks like proceed inside the form
    const anyBtn = f.querySelector('button, input[type="button"], input[type="submit"]');
    if(anyBtn){
      proceedBtn = anyBtn;
      cancelBtn = f.querySelector('button[type="reset"], .form-cancel, .cancel') || null;
      break;
    }
  }
} catch(e){
  console.warn('Prestige: form lookup failed', e);
}

// 2) If no form proceed found, reuse previously injected modal controls if present
if(!proceedBtn){
  // avoid injecting multiple times: mark modalEl._prestigeInjected
  try {
    if(modalEl){
      // if we already injected controls earlier, reuse them
      if(modalEl._prestigeInjected){
        proceedBtn = modalEl.querySelector('.prestige-proceed') || modalEl.querySelector('#confirmProceed, .modal-proceed');
        cancelBtn = modalEl.querySelector('.prestige-cancel') || modalEl.querySelector('#confirmCancel, .modal-cancel');
      } else {
        // inject controls once
        const footer = modalEl.querySelector('.modal-footer') || modalEl;
        const wrapper = document.createElement('div');
        wrapper.className = 'prestige-injected-controls';
        wrapper.style.cssText = 'margin-top:12px;display:flex;gap:8px;justify-content:flex-end;';
        const cancel = document.createElement('button');
        cancel.type = 'button';
        cancel.className = 'prestige-cancel';
        cancel.textContent = 'Cancel';
        const proceed = document.createElement('button');
        proceed.type = 'button';
        proceed.className = 'prestige-proceed';
        proceed.textContent = 'Proceed';
        proceed.style.cssText = 'font-weight:600;';
        wrapper.appendChild(cancel);
        wrapper.appendChild(proceed);
        footer.appendChild(wrapper);
        proceedBtn = proceed;
        cancelBtn = cancel;
        modalEl._prestigeInjected = true;
      }
    }
  } catch(e){
    console.warn('Prestige: modal injection failed', e);
  }
}

// 3) Final safety: if still no proceedBtn, fallback to a global confirm UI
if(!proceedBtn){
  proceedBtn = confirmProceed || null;
  cancelBtn = confirmCancel || null;
}


    // One-time attach helper
    function once(el, ev, fn){
      if(!el) return;
      const wrapper = function(e){ try { fn(e); } finally { el.removeEventListener(ev, wrapper); } };
      el.addEventListener(ev, wrapper);
    }

    // Cancel handler
    once(cancelBtn, 'click', () => {
      try { modalEl.classList.remove('show'); modalEl.style.display = 'none'; } catch(e){}
      console.debug('Prestige: modal cancelled by user');
    });

    // Proceed handler
 // Proceed handler (idempotent; creates snapshot after user confirms)
if(proceedBtn){
  // avoid double-attaching
  if(!proceedBtn._prestigeAttached){
    proceedBtn._prestigeAttached = true;

    const enclosingForm = proceedBtn.closest ? proceedBtn.closest('form') : null;

    const handler = async function onProceed(e){
      // prevent multiple clicks
      try {
        // If this is a real submit button, prevent immediate submit so we can snapshot first
        const isSubmit = (proceedBtn.tagName === 'BUTTON' && (proceedBtn.type === 'submit' || proceedBtn.getAttribute('type') === 'submit')) ||
                         (proceedBtn.tagName === 'INPUT' && proceedBtn.type === 'submit');
        if(isSubmit && e && typeof e.preventDefault === 'function') e.preventDefault();

        console.debug('Prestige: Proceed clicked (handler)');

        // Read edited body (user may have changed it)
        const editedBody = (smsTextarea?.value || preview.body || '').trim();

        // show creating state and prevent double clicks
        const originalText = proceedBtn.textContent;
        try { proceedBtn.textContent = 'Creating'; } catch(e){}
        try { proceedBtn.disabled = true; } catch(e){}

        // Create snapshot AFTER user confirms (with a short timeout)
        let snapshotUrl = null;
        try {
          if(typeof createSnapshotAndGetUrl === 'function'){
            snapshotUrl = await Promise.race([
              createSnapshotAndGetUrl(),
              new Promise((resolve) => setTimeout(()=> resolve(null), 6000))
            ]);
          }
        } catch(err){
          console.warn('snapshot error', err);
          snapshotUrl = null;
        } finally {
          // always restore button state
          try { proceedBtn.textContent = originalText; } catch(e){}
          try { proceedBtn.disabled = false; } catch(e){}
        }

        // Compose final message: prefer snapshot URL, otherwise include token
        let messageToSend = editedBody;
        if(snapshotUrl){
          messageToSend += `\n\nDetails: ${snapshotUrl}`;
          try { hiddenStaff.value = `Snapshot: ${snapshotUrl}`; } catch(e){}
        } else {
          const t = (typeof ensureCartToken === 'function') ? ensureCartToken() : token;
          const one = (typeof buildOneLineCartSummary === 'function') ? buildOneLineCartSummary(3) : oneLine;
          if(one) messageToSend += `\n\nItems: ${one}`;
          messageToSend += `\n\nCartID: ${t}`;
          try { hiddenStaff.value = `CartID: ${t}`; } catch(e){}
        }

        // Hand off to opener (share / sms / clipboard)
        const res = await openPrestigeSms(PRESTIGE_NUMBER, messageToSend);
        console.debug('Prestige: openPrestigeSms result', res);

        // If this was a real form submit button, continue the form submit now
        if(isSubmit && enclosingForm){
          setTimeout(()=> {
            try { enclosingForm.submit(); } catch(e){ console.warn('form.submit failed', e); }
          }, 250);
        }

      } catch(err){
        console.error('Prestige: error in Proceed handler', err);
        alert('An error occurred while sending. Check console for details.');
      } finally {
        try { modalEl.classList.remove('show'); modalEl.style.display = 'none'; } catch(e){}
      }
    };

    proceedBtn.addEventListener('click', handler);
  }
}


  } catch(err){
    console.error('Prestige: handleSms top-level error', err);
    alert('An error occurred preparing the SMS preview. Check console for details.');
  }
}


    // Email handler unchanged
    function handleEmail(){
      const name = (nameInput?.value || '').trim();
      const phone = (phoneInput?.value || '').trim();
      const issue = (issueInput?.value || '').trim();
      const room = genRoom('prestige',8);
      const t = (typeof buildTemplates === 'function') ? buildTemplates(name, phone, issue, room) : {
        subjectStaff: `Prestige Help Request ‚Äî ${name || '[username]'}`,
        bodyStaff: `User: ${name}\nPhone: ${phone}\nIssue: ${issue}`
      };
      hiddenStaff.value = t.staffReply || `Hi ${name||'[name]'}, join here: ${JITSI_BASE}/${room} ‚Äî I‚Äôll join now.`;
      if(typeof openMailto === 'function') openMailto(t.subjectStaff, t.bodyStaff);
      else window.location.href = `mailto:${encodeURIComponent(SUPPORT_EMAIL)}?subject=${encodeURIComponent(t.subjectStaff)}&body=${encodeURIComponent(t.bodyStaff)}`;
    }

    // Safe attach helper
    function safeAttach(btn, handler, name){
      if(!btn || !handler) return;
      if(btn._prestigeAttached) return;
      try { btn.type = btn.type || 'button'; } catch(e){}
      btn.addEventListener('click', function(e){
        if(e && typeof e.preventDefault === 'function') e.preventDefault();
        try {
          const res = handler();
          if(res && typeof res.then === 'function') res.catch(err => console.error(`${name} handler error`, err));
        } catch(err){ console.error(`${name} wrapper error`, err); }
      }, { passive:false });
      btn._prestigeAttached = true;
    }

    // Attach handlers
    safeAttach(smsBtn, handleSms, 'SMS');
    safeAttach(emailBtn, handleEmail, 'Email');
    if(buzzer && !buzzer._prestigeToggleInstalled){
      buzzer.addEventListener('click', () => { widget?.classList.toggle('prestige-hidden'); (nameInput || widget?.querySelector('input'))?.focus(); buzzer.classList.remove('pulse'); });
      buzzer._prestigeToggleInstalled = true;
    }

    // Modal actions
    if(copySmsBtn && smsTextarea && !copySmsBtn._prestigeAttached){
      copySmsBtn.addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(smsTextarea.value || ''); copySmsBtn.textContent = 'Copied'; setTimeout(()=> copySmsBtn.textContent = 'Copy SMS',1200); } catch(e){ copySmsBtn.textContent = 'Copy failed'; setTimeout(()=> copySmsBtn.textContent = 'Copy SMS',1200); }
      });
      copySmsBtn._prestigeAttached = true;
    }
    if(modalSendEmailBtn && !modalSendEmailBtn._prestigeAttached){
      modalSendEmailBtn.addEventListener('click', () => {
        const name = (nameInput?.value || '').trim();
        const phone = (phoneInput?.value || '').trim();
        const issue = (issueInput?.value || '').trim();
        const subject = `Prestige Help Request ‚Äî ${name || '[username]'}`;
        const body = `User: ${name || '[name]'}\nPhone: ${phone || '[number]'}\nIssue: ${issue || '[short description]'}\n\nPlease respond with Jitsi link via SMS.`;
        if(typeof openMailto === 'function') openMailto(subject, body);
        else window.location.href = `mailto:${encodeURIComponent(SUPPORT_EMAIL)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      });
      modalSendEmailBtn._prestigeAttached = true;
    }
    if(closeModalBtn && !closeModalBtn._prestigeAttached){
      closeModalBtn.addEventListener('click', () => { if(modalEl) modalEl.style.display = 'none'; });
      closeModalBtn._prestigeAttached = true;
    }

    // Expose debug helpers
    window.prestige = window.prestige || {};
    window.prestige.collectCartSummaryLinesDirect = collectCartSummaryLinesDirect;
    window.prestige.buildSmsPreview = buildSmsPreview;
    window.prestige.createSnapshotAndGetUrl = createSnapshotAndGetUrl;
    window.prestige.openPrestigeSms = openPrestigeSms;
    window.prestige.ensureCartToken = ensureCartToken;
    window.prestige.buildOneLineCartSummary = buildOneLineCartSummary;

    console.log('Prestige: modal-first SMS handler attached.');
  });
})();
  
  // injection: create controls but copy classes from existing modal buttons if present
(function injectPrestigeControls(modalEl){
  if(!modalEl) return null;
  if(modalEl._prestigeInjected) {
    return {
      proceed: modalEl.querySelector('.prestige-proceed'),
      cancel: modalEl.querySelector('.prestige-cancel')
    };
  }

  // try to find existing modal buttons to copy classes from
  const sampleProceed = modalEl.querySelector('button.btn-primary, button.primary, .modal-footer .btn, .modal-footer .primary') ||
                        document.querySelector('button.btn-primary, button.primary, .modal-footer .btn, .modal-footer .primary');
  const sampleCancel  = modalEl.querySelector('button.btn-secondary, button.secondary, .modal-footer .btn-secondary, .modal-footer .cancel') ||
                        document.querySelector('button.btn-secondary, button.secondary, .modal-footer .btn-secondary, .modal-footer .cancel');

  const footer = modalEl.querySelector('.modal-footer') || modalEl;
  const wrapper = document.createElement('div');
  wrapper.className = 'prestige-injected-controls';
  wrapper.style.cssText = 'margin-top:12px;display:flex;gap:8px;justify-content:flex-end;align-items:center;';

  const cancel = document.createElement('button');
  cancel.type = 'button';
  cancel.className = 'prestige-cancel';
  cancel.textContent = 'Cancel';

  const proceed = document.createElement('button');
  proceed.type = 'button';
  proceed.className = 'prestige-proceed';
  proceed.textContent = 'Proceed';

  // copy class lists from sample buttons if found (preserve site styling)
  try {
    if(sampleProceed && sampleProceed.classList && sampleProceed.classList.length){
      proceed.className = Array.from(sampleProceed.classList).join(' ') + ' prestige-proceed';
    }
    if(sampleCancel && sampleCancel.classList && sampleCancel.classList.length){
      cancel.className = Array.from(sampleCancel.classList).join(' ') + ' prestige-cancel';
    }
  } catch(e){ /* ignore copy errors */ }

  wrapper.appendChild(cancel);
  wrapper.appendChild(proceed);
  footer.appendChild(wrapper);

  modalEl._prestigeInjected = true;
  return { proceed, cancel };
})(modalEl);

 
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const sms = document.getElementById('pfSendSms') || document.getElementById('smsBtn');
  const modal = document.getElementById('prestigeModal') || document.querySelector('.prestige-modal');
  if (!sms || !modal) return;
  if (sms.tagName === 'BUTTON') sms.type = 'button';
  sms.addEventListener('click', e => {
    e.preventDefault();
    e.stopPropagation();
    modal.classList.toggle('open');
    modal.setAttribute('aria-hidden', modal.classList.contains('open') ? 'false' : 'true');
  });
  // close button inside modal (if present)
  const close = modal.querySelector('#closeModal') || modal.querySelector('.close-btn');
  close?.addEventListener('click', e => { e.preventDefault(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); });
});
</script>
          
          
<script>
/* Single drop-in: Prestige cart integrator (paste after page load) */
(function PrestigeDropIn() {
  const STORAGE_KEY = 'prestigeCartItems';
  const UPDATED_AT = 'prestigeCartUpdatedAt';
  const USE_MAP_KEY = 'prestige_use_map';
  const CASH_PER_PRESTIGE = 0.25; // $ per 1 PRESTIGE (adjust if needed)
// add this after your consts
let STORE = [];

  const SELECTORS = {
    shimmerCandidates: ['#cartList', '.cart-list', '#cart-panel', '#cart'],
    tableBody: ['#cartItems', '#cartTable tbody'],
    receiptCandidates: ['#receiptTotal', '.receipt-total'],
    badgeSelectors: ['#floatingCartBadge', '.floating-cart-badge'],
    mainCountSelectors: ['#mainCartCount', '.main-cart-count']
  };

  function safeParse(v, fallback) { try { return JSON.parse(v || 'null'); } catch (e) { return fallback; } }
  function nowIso() { return new Date().toISOString(); }
  function nowId() { return String(Date.now()); }
  function pickFirst(selectors) { for (const s of selectors) { const el = document.querySelector(s); if (el) return s; } return selectors[0]; }

  // Ensure primitive, consistent shape
  function normalize(item) {
    const denomRaw = String(item.denomination ?? item.amount ?? item.tokenCount ?? "0");
    const denom = parseFloat(denomRaw.replace(/[^\d.-]/g, '')) || 0;
    const rawCash = (item.cashValue !== undefined && item.cashValue !== null) ? item.cashValue : (denom * CASH_PER_PRESTIGE);
    const cash = parseFloat(String(rawCash).replace(/[^\d.-]/g, '')) || 0;
    let serial = String(item.serial ?? item.product_id ?? item.id ?? '').trim();
    if (!serial) serial = `PRG-${denom.toFixed(2)}-${nowId()}`;
    const status = (String(item.status || item.finalized || '').toLowerCase() === 'finalized' || item.finalized === true) ? 'finalized' : 'pending';
    return {
      denomination: denom.toFixed(2),
      tokenCount: String(Math.round(denom)),
      product_id: serial,
      serial,
      currency: String(item.currency ?? 'Prestige'),
      issued: String(item.issued ?? item.date ?? nowIso()),
      redeem_url: String(item.redeem_url ?? item.url ?? ''),
      cashValue: cash.toFixed(2),
      status,
      title: String(item.title ?? `${denom.toFixed(2)} PRESTIGE`),
      subtitle: String(item.subtitle ?? `$${cash.toFixed(2)} USD`)
    };
  }

  // Collect items: hidden nodes -> select -> URL -> fallback seed
  function collectItems() {
    const out = [];

    // hidden nodes
    document.querySelectorAll('#prestigeHiddenProducts .prestige-hidden').forEach(n => {
      try {
        const viewRaw = safeParse(n.dataset.view, {});
        const useRaw = safeParse(n.dataset.use, {});
        const tokens = Number(viewRaw.tokenCount ?? viewRaw.denomination ?? 0) || 0;
        const denom = Number(viewRaw.denomination ?? tokens).toFixed(2);
        const cash = (Number(viewRaw.cashValue) || (tokens * CASH_PER_PRESTIGE)).toFixed(2);
        const serial = String(viewRaw.product_id || viewRaw.serial || n.dataset.serial || `PRG-${nowId()}`).trim();
        const view = { product_id: serial, serial, denomination: denom, tokenCount: String(tokens), cashValue: cash, status: String(viewRaw.status || 'pending'), title: String(viewRaw.title || `${denom} PRESTIGE`), redeem_url: String(viewRaw.redeem_url || '') };
        const normalized = normalize(view);
        normalized.__prestige_use_raw = Object.assign({}, normalized, useRaw || {}, { __prestige_use: true });
        out.push(normalized);
      } catch (e) { console.error('hidden parse error', e); }
    });

    // denomination select fallback
    if (!out.length) {
      const sel = document.querySelector('#denominationSelect');
      if (sel) {
        Array.from(sel.options).forEach((opt, i) => {
          if (!opt.value) return;
          const denom = Number(opt.value).toFixed(2);
          const serial = `PRG-${denom}-${nowId()}-${i}`;
          const view = { product_id: serial, serial, denomination: denom, tokenCount: String(Math.round(Number(denom))), cashValue: (Number(denom) * CASH_PER_PRESTIGE).toFixed(2), status: 'pending', title: `${denom} PRESTIGE`, redeem_url: `https://prestige.exchange/redeem/${serial}` };
          const n = normalize(view);
          n.__prestige_use_raw = Object.assign({}, n, { __prestige_use: true });
          out.push(n);
        });
      }
    }

    // URL items param fallback (ephemeral)
    if (!out.length) {
      try {
        const params = new URLSearchParams(window.location.search);
        if (params.has('items')) {
          const parsed = safeParse(params.get('items'), []);
          if (Array.isArray(parsed)) {
            parsed.forEach(p => {
              const n = normalize(p);
              n.__prestige_use_raw = Object.assign({}, n, p.__prestige_use ? p : { __prestige_use: true });
              out.push(n);
            });
          }
        }
      } catch (e) {}
    }

  
    return out;
  }

  // Persist primitives and use map
 // replace persist(...) with this
function persist(items) {
  const normalized = items.map(normalize);
  STORE = normalized; // keep in-memory only
  // do not write to localStorage/sessionStorage
  return normalized;
}


  // Compute dual totals and token equivalent from cash
  function computeTotals(items) {
    const tokenTotal = items.reduce((s, it) => s + (parseFloat(it.denomination) || 0), 0);
    const cashTotal = items.reduce((s, it) => s + (parseFloat(it.cashValue) || 0), 0);
    const tokenEquivalentFromCash = (CASH_PER_PRESTIGE > 0) ? (cashTotal / CASH_PER_PRESTIGE) : 0;
    return { tokenTotal: tokenTotal.toFixed(2), cashTotal: cashTotal.toFixed(2), tokenEquivalentFromCash: tokenEquivalentFromCash.toFixed(2) };
  }

  // Render shimmer, cards, totals, badges
  
 // replace renderFromStorage() with this
function renderFromStorage() {
  const items = Array.isArray(STORE) ? STORE.map(normalize) : [];
  const totals = computeTotals(items);
  const count = items.length;

  const cardsHtml = items.map(it => {
    const stateClass = it.status === 'finalized' ? 'card-finalized' : 'card-pending';
    const badgeText = it.status === 'finalized' ? 'FINALIZED' : 'PENDING';
    return `
      <div class="prestige-card ${stateClass}" data-serial="${it.serial}" data-product_id="${it.product_id}">
        <div class="prestige-card-left">
          <div class="prestige-amount">${it.denomination} <span class="prestige-token">PRESTIGE</span></div>
          <div class="prestige-serial">${it.serial}</div>
          <div class="prestige-state">${badgeText}</div>
        </div>
        <div class="prestige-card-right">
          <div class="prestige-cash">$${it.cashValue}</div>
          ${it.redeem_url ? `<a class="prestige-redeem" href="${it.redeem_url}" target="_blank">Redeem</a>` : ''}
        </div>
      </div>
    `;
  }).join('');

  const headerHtml = `
    <div class="shimmer-header" style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
      <div class="shimmer-left">
        <div style="font-size:12px;color:#aaa">Tokens total</div>
        <div style="font-weight:700">${totals.tokenTotal} PRESTIGE</div>
        <div style="font-size:11px;color:#888">(${totals.tokenEquivalentFromCash} PRESTIGE from $${totals.cashTotal} USD)</div>
      </div>
      <div class="shimmer-right" style="text-align:right">
        <div style="font-size:12px;color:#aaa">Use total</div>
        <div style="font-weight:700">$${totals.cashTotal} USD</div>
        <div style="font-size:11px;color:#888">($${totals.cashTotal} ‚âà ${totals.tokenEquivalentFromCash} PRESTIGE)</div>
      </div>
      <div style="margin-left:12px;font-size:12px;color:#aaa">(${count} item${count !== 1 ? 's' : ''})</div>
    </div>
  `;

  // same DOM insertion logic as before, but using items from STORE
  let shimmerEl = null;
  for (const s of SELECTORS.shimmerCandidates) { const el = document.querySelector(s); if (el) { shimmerEl = el; break; } }

  if (shimmerEl) {
    shimmerEl.innerHTML = headerHtml + `<div class="shimmer-cards">${cardsHtml}</div>`;
    const hasPending = items.some(i => i.status === 'pending');
    shimmerEl.classList.remove('shimmer-pulse', 'finalized-glow');
    if (hasPending) shimmerEl.classList.add('shimmer-pulse'); else shimmerEl.classList.add('finalized-glow');
  } else {
    let fb = document.querySelector('.prestige-fallback-cards');
    if (!fb) { fb = document.createElement('div'); fb.className = 'prestige-fallback-cards'; fb.style.padding = '8px'; fb.style.background = '#0b0b0b'; fb.style.color = '#fff'; document.body.insertBefore(fb, document.body.firstChild); }
    fb.innerHTML = headerHtml + `<div class="shimmer-cards">${cardsHtml}</div>`;
  }

  // table fallback and receipt/badge updates (same as before) but using items from STORE
  for (const sel of SELECTORS.tableBody) {
    const tbody = document.querySelector(sel);
    if (tbody) {
      tbody.innerHTML = '';
      items.forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.denomination} ${it.currency}</td><td>${it.serial}</td><td>${it.issued}</td><td>${it.cashValue ? '$' + it.cashValue : ''}</td><td>${it.redeem_url ? `<a href="${it.redeem_url}" target="_blank">Redeem</a>` : ''}</td>`;
        tbody.appendChild(tr);
      });
    }
  }

  for (const sel of SELECTORS.receiptCandidates) {
    const r = document.querySelector(sel);
    if (r) r.textContent = `Tokens: ${totals.tokenTotal} PRESTIGE ‚Ä¢ Use: $${totals.cashTotal} USD (${count} item${count !== 1 ? 's' : ''})`;
  }

  try { SELECTORS.badgeSelectors.forEach(s => document.querySelectorAll(s).forEach(el => el.textContent = String(count))); } catch (e) {}
  try { SELECTORS.mainCountSelectors.forEach(s => document.querySelectorAll(s).forEach(el => el.textContent = String(count))); } catch (e) {}

  return { items, totals };
}

  // Interceptor: redeem click -> apply use payload or navigate
  function installInterceptor() {
    if (window.__prestige_interceptor_installed) return;
    window.__prestige_interceptor_installed = true;

    function readUseMap() { try { return safeParse(sessionStorage.getItem(USE_MAP_KEY), {}); } catch (e) { return {}; } }
    function applyUsePayload(usePayload) {
      if (!usePayload) return false;
      try { if (typeof window.cartUseItem === 'function') { window.cartUseItem(usePayload); console.log('applied via cartUseItem', usePayload.serial); return true; } } catch (e) {}
      try { if (typeof window.redeemItem === 'function') { window.redeemItem(usePayload); console.log('applied via redeemItem', usePayload.serial); return true; } } catch (e) {}
      try { document.dispatchEvent(new CustomEvent('cart:itemUse', { detail: usePayload })); console.log('dispatched cart:itemUse', usePayload.serial); return true; } catch (e) {}
      return false;
    }

    document.addEventListener('click', function (ev) {
      const a = ev.target.closest && ev.target.closest('.prestige-redeem, .redeem, a.redeem, button.prestige-redeem');
      if (!a) return;
      const card = a.closest && a.closest('.prestige-card');
      if (!card) return;
      const serial = card.dataset && (card.dataset.serial || card.dataset.productId || card.dataset.product_id);
      if (!serial) return;
      const useMap = readUseMap();
      const usePayload = useMap[serial];
      if (!usePayload) return;
      ev.preventDefault(); ev.stopPropagation();
      console.log('redeem click intercepted for', serial);
      const applied = applyUsePayload(usePayload);
      if (!applied && usePayload.redeem_url) window.location.href = usePayload.redeem_url;
    }, true);

    document.addEventListener('cart:itemUse', function (ev) {
      if (!ev || !ev.detail) return;
      const serial = ev.detail.serial || ev.detail.product_id || ev.detail.id;
      if (!serial) return;
      const useMap = readUseMap();
      const usePayload = useMap[serial];
      if (!usePayload) return;
      ev.stopImmediatePropagation && ev.stopImmediatePropagation();
      try { console.log('cart:itemUse intercepted for', serial); applyUsePayload(usePayload); } catch (e) {}
    }, true);
  }

  
  
  
/* Patch: per-card "Add to Archive" button that captures parsed URL/PRG ‚Äî idempotent */
(function prestige_card_add_button_patch(){
  if (window.__prestige_card_add_button_patch_installed) return;
  window.__prestige_card_add_button_patch_installed = true;

  const ARCHIVE_KEY = 'prestige_archive_session_v1';
  const $id = id => document.getElementById(id);

  function safeParseJson(s, fallback = null){ try { return JSON.parse(s); } catch(e){ return fallback; } }
  function loadArchive(){ try { return JSON.parse(sessionStorage.getItem(ARCHIVE_KEY) || '[]'); } catch(e){ return []; } }
  function saveArchive(arr){ try { sessionStorage.setItem(ARCHIVE_KEY, JSON.stringify(Array.isArray(arr)?arr:[])); } catch(e){} }

  function nowIso(){ return new Date().toISOString(); }
  function makeId(){ return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,9); }

  // parse query string into object
  function parseQuery(url){
    try {
      const u = new URL(url, window.location.origin);
      const obj = {};
      for (const [k,v] of u.searchParams.entries()) {
        if (obj[k] === undefined) obj[k] = v;
        else if (Array.isArray(obj[k])) obj[k].push(v);
        else obj[k] = [obj[k], v];
      }
      return { href: u.href, pathname: u.pathname, host: u.host, params: obj };
    } catch(e){
      // fallback: try simple split
      const q = (String(url||'').split('?')[1] || '');
      const params = {};
      q.split('&').filter(Boolean).forEach(pair => {
        const [k,v] = pair.split('=').map(decodeURIComponent);
        if (!k) return;
        if (params[k] === undefined) params[k] = v;
        else if (Array.isArray(params[k])) params[k].push(v);
        else params[k] = [params[k], v];
      });
      return { href: String(url||''), pathname: '', host: '', params };
    }
  }

  // normalize item to archive shape
  function buildItemFromCard(card){
    const title = card.dataset?.title || (card.querySelector && (card.querySelector('.title')?.textContent || card.querySelector('h3')?.textContent)) || card.textContent?.slice(0,60) || 'archive-item';
    // find a URL: prefer data-url, then anchor href inside card, then dataset.redeemUrl
    const url = card.dataset?.url || (card.querySelector && (card.querySelector('a[href]')?.getAttribute('href'))) || card.dataset?.redeemUrl || card.dataset?.redeem_url || null;
    const parsed = url ? parseQuery(url) : null;
    const serial = card.dataset?.serial || card.dataset?.productId || card.dataset?.product_id || (parsed && parsed.params && (parsed.params.serial || parsed.params.id)) || null;
    const item = {
      id: makeId(),
      createdAt: nowIso(),
      title: String(title).trim().slice(0,120),
      url: url || '',
      parsed: parsed || {},
      serial: serial || '',
      rawCardHtml: card.innerHTML?.slice(0,200) || ''
    };
    return item;
  }

  // add item to archive using existing API if present, else fallback
  async function addItemToArchive(item){
    try {
      // prefer existing robust API
      if (window.Prestige?.archive?.addRobust) {
        // addRobust expects raw input or array; pass array of normalized items
        const res = window.Prestige.archive.addRobust([item]);
        // if returns promise, await
        if (res && typeof res.then === 'function') await res;
        // dispatch event
        try { window.dispatchEvent(new CustomEvent('prestige:archiveAdded', { detail: { items: [item] } })); } catch(e){}
        return true;
      }
    } catch(e){ /* fallthrough to fallback */ }

    // fallback: direct sessionStorage merge
    try {
      const arr = loadArchive();
      arr.unshift(item);
      saveArchive(arr);
      try { window.dispatchEvent(new CustomEvent('prestige:archiveAdded', { detail: { items: [item] } })); } catch(e){}
      // try to call render if available
      if (typeof window.renderArchiveList === 'function') try { window.renderArchiveList(); } catch(e){}
      return true;
    } catch(e){
      console.warn('[prestige] addItemToArchive fallback failed', e);
      return false;
    }
  }

  // create Add button and append to card (idempotent)
 // create Add button and append to card (idempotent, style-matching)
function injectAddButtonsIntoCards(){
  const selectors = ['.prestige-card', '.card.prestige', '.card', '.product-card', '.prestige-item'];
  const nodes = [];
  selectors.forEach(sel => Array.from(document.querySelectorAll(sel)).forEach(n => nodes.push(n)));
  const unique = Array.from(new Set(nodes));
  unique.forEach(card => {
    if (!card || card.__prestige_add_button_wired) return;

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'prestige-card-add-btn';
    btn.textContent = 'Add to Archive';
    btn.title = 'Add this item (parsed URL/PRG) to the archive';

    // Try to find a Redeem-like button in the same card to copy visual style
    (function applyMatchingStyle() {
      try {
        // prefer common redeem selectors inside the card
        const redeem = card.querySelector('.redeem, .prestige-redeem, button.redeem, a.redeem, button.prestige-redeem');
        if (redeem) {
          const cs = window.getComputedStyle(redeem);
          // copy only visual properties that affect font/spacing/colors
          const props = [
            'fontFamily','fontSize','fontWeight','lineHeight','color',
            'backgroundColor','border','borderRadius','paddingTop','paddingRight','paddingBottom','paddingLeft',
            'marginTop','marginRight','marginBottom','marginLeft','textTransform','letterSpacing','boxShadow'
          ];
          props.forEach(p => {
            try { btn.style[p] = cs[p]; } catch(e){}
          });
          // ensure pointer cursor and small adjustments
          btn.style.cursor = cs.cursor || 'pointer';
          btn.style.display = 'inline-block';
          btn.style.verticalAlign = 'middle';
          return;
        }
      } catch(e){ /* ignore and fall back */ }

      // Fallback compact style (minimal layout impact)
      btn.style.cssText = [
        'padding:4px 8px',
        'font-size:13px',
        'line-height:1.2',
        'font-family:inherit',
        'background:transparent',
        'color:inherit',
        'border:1px solid rgba(0,0,0,0.08)',
        'border-radius:4px',
        'margin-left:6px',
        'cursor:pointer'
      ].join(';');
    })();

    btn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      try {
        const item = buildItemFromCard(card);
        const ok = await addItemToArchive(item);
        const original = btn.textContent;
        btn.textContent = ok ? 'Added' : 'Add';
        setTimeout(()=>{ try { btn.textContent = original; } catch(e){} }, 1200);
      } catch(err){
        console.warn('[prestige] add button click failed', err);
      }
    }, { capture: true });

    const actions = card.querySelector && (card.querySelector('.card-actions') || card.querySelector('.actions') || card.querySelector('.prestige-actions'));
    try {
      if (actions) actions.appendChild(btn);
      else card.appendChild(btn);
    } catch(e){
      try { card.appendChild(btn); } catch(e){}
    }

    card.__prestige_add_button_wired = true;
  });
}


  // run injection now and watch for dynamic cards
  injectAddButtonsIntoCards();
  const scan = setInterval(injectAddButtonsIntoCards, 900);
  setTimeout(()=>clearInterval(scan), 30000);

  // expose helper to add current pfIssue text as an archive item (useful for UI "Add" elsewhere)
  window.Prestige = window.Prestige || {};
  window.Prestige.archive = window.Prestige.archive || {};
  window.Prestige.archive.addPfIssueAsItem = async function(){
    const pf = $id('pfIssue') || $id('prestigeShortNote');
    if (!pf) return false;
    const text = String(pf.value || '').trim();
    if (!text) return false;
    const item = {
      id: makeId(),
      createdAt: nowIso(),
      title: text.slice(0,120),
      url: '',
      parsed: {},
      serial: '',
      rawCardHtml: ''
    };
    return await addItemToArchive(item);
  };

})();


  // Modal snapshot: notify site listeners without persisting
  
  function addCopyButtons() {
  document.querySelectorAll('.prestige-card').forEach(card => {
    if (card.querySelector('.prestige-copy')) return; // already added

    // create button
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'prestige-copy';
    btn.textContent = 'Copy';
    btn.style.marginLeft = '8px';
    btn.style.padding = '4px 8px';
    btn.style.fontSize = '12px';
    btn.setAttribute('aria-label', 'Copy item info');

    // attach next to redeem link if present, otherwise append to right column
    const right = card.querySelector('.prestige-card-right') || card;
    const redeem = right.querySelector('.prestige-redeem');
    if (redeem && redeem.parentNode) redeem.parentNode.insertBefore(btn, redeem.nextSibling);
    else right.appendChild(btn);

    // click handler: build minimal payload and copy
    btn.addEventListener('click', (ev) => {
      ev.preventDefault();
      ev.stopPropagation();

      const payload = {
        serial: card.getAttribute('data-serial') || card.dataset.serial || (card.querySelector('.prestige-serial')?.textContent || '').trim(),
        product_id: card.getAttribute('data-product_id') || card.dataset.productId || card.getAttribute('data-product-id') || '',
        denomination: Number((card.querySelector('.prestige-amount')?.textContent || '').trim().split(/\s+/)[0]) || 0,
        cashValue: Number((card.querySelector('.prestige-cash')?.textContent || '').replace(/[^0-9.-]+/g,'') || 0),
        status: (card.querySelector('.prestige-state')?.textContent || '').trim() || (card.classList.contains('card-finalized') ? 'finalized' : 'pending'),
        redeem_url: card.querySelector('.prestige-redeem')?.href || ''
      };

      const text = JSON.stringify(payload, null, 2);

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          const prev = btn.textContent;
          btn.textContent = 'Copied';
          setTimeout(() => btn.textContent = prev, 1200);
        }).catch(() => window.prompt('Copy item info (Ctrl+C / Cmd+C):', text));
      } else {
        window.prompt('Copy item info (Ctrl+C / Cmd+C):', text);
      }
    }, true);
  });
}

// call this after renderFromStorage runs
addCopyButtons();

  // replace snapshotToModal with this
function snapshotToModal() {
  const items = Array.isArray(STORE) ? STORE.slice() : [];
  try {
    items.forEach(p => {
      const detail = Object.assign({}, p, { __prestige_internal: true });
      document.dispatchEvent(new CustomEvent('cart:itemAdded', { detail }));
    });
    console.log('snapshotToModal dispatched', items.length, 'items (in-memory only)');
  } catch (e) { console.error('snapshotToModal', e); }
}

// replace finalizeSerial with this
function finalizeSerial(serial) {
  try {
    let changed = false;
    STORE = (Array.isArray(STORE) ? STORE : []).map(it => {
      if ((it.serial === serial || it.product_id === serial) && it.status !== 'finalized') {
        it.status = 'finalized';
        changed = true;
      }
      return it;
    });
    if (changed) {
      renderFromStorage();
      console.log('finalizeSerial applied to', serial);
      return true;
    }
  } catch (e) { console.error('finalizeSerial', e); }
  return false;
}

  // Public API
  window.Prestige = window.Prestige || {};
  window.Prestige.importAndRender = function () { const items = collectItems(); const persisted = persist(items); renderFromStorage(); installInterceptor(); return persisted; };
  window.Prestige.snapshotToModal = snapshotToModal;
  window.Prestige.finalizeSerial = finalizeSerial;
  window.Prestige.render = renderFromStorage;

  // Auto-run
  try {
    const items = collectItems();
    persist(items);
    renderFromStorage();
    installInterceptor();
    console.log('PrestigeDropIn initialized. Use window.Prestige for API.');
    console.log('Diagnostics: view array:', safeParse(localStorage.getItem(STORAGE_KEY), []), 'use map:', safeParse(sessionStorage.getItem(USE_MAP_KEY), {}));
  } catch (e) { console.error('PrestigeDropIn init error', e); }
})();

// Robust auto-inject + styling (idempotent)
(function installPrestigeCopyAuto() {
  if (window.__prestige_copy_auto_installed) return;
  window.__prestige_copy_auto_installed = true;

  // Ensure addCopyButtons exists (use your implementation if present)
  function addCopyButtonsOnce() {
    document.querySelectorAll('.prestige-card').forEach(card => {
      if (card.querySelector('.prestige-copy')) return;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'prestige-copy';
      btn.textContent = 'Copy';
      btn.style.marginLeft = '8px';
      btn.style.padding = '4px 8px';
      btn.style.fontSize = '12px';
      btn.style.cursor = 'pointer';
      btn.setAttribute('aria-label', 'Copy item info');

      const right = card.querySelector('.prestige-card-right') || card;
      const redeem = right.querySelector('.prestige-redeem');
      if (redeem && redeem.parentNode) redeem.parentNode.insertBefore(btn, redeem.nextSibling);
      else right.appendChild(btn);

      btn.addEventListener('click', (ev) => {
        ev.preventDefault(); ev.stopPropagation();
        const payload = {
          serial: card.getAttribute('data-serial') || card.dataset.serial || (card.querySelector('.prestige-serial')?.textContent || '').trim(),
          product_id: card.getAttribute('data-product_id') || card.dataset.productId || card.getAttribute('data-product-id') || '',
          denomination: Number((card.querySelector('.prestige-amount')?.textContent || '').trim().split(/\s+/)[0]) || 0,
          cashValue: Number((card.querySelector('.prestige-cash')?.textContent || '').replace(/[^0-9.-]+/g,'') || 0),
          status: (card.querySelector('.prestige-state')?.textContent || '').trim() || (card.classList.contains('card-finalized') ? 'finalized' : 'pending'),
          redeem_url: card.querySelector('.prestige-redeem')?.href || ''
        };
        const text = JSON.stringify(payload, null, 2);
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(() => {
            const prev = btn.textContent;
            btn.textContent = 'Copied';
            setTimeout(() => btn.textContent = prev, 1200);
          }).catch(() => window.prompt('Copy item info (Ctrl+C / Cmd+C):', text));
        } else {
          window.prompt('Copy item info (Ctrl+C / Cmd+C):', text);
        }
      }, true);
    });
  }

  // initial pass
  addCopyButtonsOnce();

  // observe for new cards or re-renders
  const root = document.body;
  const mo = new MutationObserver((mutations) => {
    let added = false;
    for (const m of mutations) {
      if (m.addedNodes && m.addedNodes.length) {
        for (const n of m.addedNodes) {
          if (n instanceof Element && (n.matches('.prestige-card') || n.querySelector && n.querySelector('.prestige-card'))) {
            added = true; break;
          }
        }
      }
      if (added) break;
    }
    if (added) addCopyButtonsOnce();
  });
  mo.observe(root, { childList: true, subtree: true });

  // small CSS to ensure visibility
  const styleId = 'prestige-copy-style';
  if (!document.getElementById(styleId)) {
    const s = document.createElement('style');
    s.id = styleId;
    s.textContent = `
      .prestige-copy { background:#1f6feb; color:#fff; border:none; border-radius:4px; }
      .prestige-copy:active { transform:translateY(1px); }
      .prestige-copy[disabled] { opacity:0.6; cursor:not-allowed; }
    `;
    document.head.appendChild(s);
  }

  // expose manual trigger
  window.addCopyButtons = addCopyButtonsOnce;
})();

  
  
  
  
  
  
  
  
  
  
  // ---------- Edit/Add modal and helpers (idempotent) ----------
(function installPrestigeEditor() {
  if (window.__prestige_editor_installed) return;
  window.__prestige_editor_installed = true;

  // Create modal DOM once
  function createModal() {
    if (document.getElementById('prestige-editor-modal')) return;

    const modal = document.createElement('div');
    modal.id = 'prestige-editor-modal';
    modal.style.position = 'fixed';
    modal.style.inset = '0';
    modal.style.display = 'none';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.background = 'rgba(0,0,0,0.5)';
    modal.style.zIndex = 99999;
    modal.innerHTML = `
      <div class="prestige-editor-panel" role="dialog" aria-modal="true" aria-labelledby="prestige-editor-title" style="width:520px;max-width:94%;background:#0f1724;color:#e6eef8;border-radius:10px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,0.6);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div>
            <div id="prestige-editor-title" style="font-weight:700;font-size:16px">Edit Prestige Item</div>
            <div id="prestige-editor-sub" style="font-size:12px;color:#9fb0d6">Modify fields and click Save</div>
          </div>
          <button id="prestige-editor-close" aria-label="Close" style="background:transparent;border:none;color:#9fb0d6;font-size:18px;cursor:pointer">‚úï</button>
        </div>

        <form id="prestige-editor-form" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <label style="grid-column:1/3;font-size:12px;color:#9fb0d6">Serial (id)</label>
          <input name="serial" required style="grid-column:1/3;padding:8px;border-radius:6px;border:1px solid #21324a;background:#071028;color:#fff" />

          <label style="font-size:12px;color:#9fb0d6">Product id</label>
          <input name="product_id" style="padding:8px;border-radius:6px;border:1px solid #21324a;background:#071028;color:#fff" />

          <label style="font-size:12px;color:#9fb0d6">Denomination (PRESTIGE)</label>
          <input name="denomination" type="number" step="0.01" style="padding:8px;border-radius:6px;border:1px solid #21324a;background:#071028;color:#fff" />

          <label style="font-size:12px;color:#9fb0d6">Cash value (USD)</label>
          <input name="cashValue" type="number" step="0.01" style="padding:8px;border-radius:6px;border:1px solid #21324a;background:#071028;color:#fff" />

          <label style="font-size:12px;color:#9fb0d6">Status</label>
          <select name="status" style="padding:8px;border-radius:6px;border:1px solid #21324a;background:#071028;color:#fff">
            <option value="pending">pending</option>
            <option value="finalized">finalized</option>
          </select>

          <label style="grid-column:1/3;font-size:12px;color:#9fb0d6">Redeem URL (optional)</label>
          <input name="redeem_url" style="grid-column:1/3;padding:8px;border-radius:6px;border:1px solid #21324a;background:#071028;color:#fff" />

          <div style="grid-column:1/3;display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
            <button type="button" id="prestige-editor-delete" style="background:#7f1d1d;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer">Delete</button>
            <button type="button" id="prestige-editor-save" style="background:#059669;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer">Save</button>
            <button type="button" id="prestige-editor-addnew" style="background:#2563eb;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer">Add New</button>
          </div>
        </form>
      </div>
    `;
    document.body.appendChild(modal);

    // handlers
    const closeBtn = modal.querySelector('#prestige-editor-close');
    const saveBtn = modal.querySelector('#prestige-editor-save');
    const deleteBtn = modal.querySelector('#prestige-editor-delete');
    const addNewBtn = modal.querySelector('#prestige-editor-addnew');
    const form = modal.querySelector('#prestige-editor-form');

    function getFormData() {
      const fd = new FormData(form);
      return {
        serial: String(fd.get('serial') || '').trim(),
        product_id: String(fd.get('product_id') || '').trim(),
        denomination: Number(fd.get('denomination') || 0),
        cashValue: Number(fd.get('cashValue') || 0),
        status: String(fd.get('status') || 'pending'),
        redeem_url: String(fd.get('redeem_url') || '').trim()
      };
    }

    function setFormData(obj) {
      form.serial.value = obj.serial || '';
      form.product_id.value = obj.product_id || '';
      form.denomination.value = obj.denomination ?? '';
      form.cashValue.value = obj.cashValue ?? '';
      form.status.value = obj.status || 'pending';
      form.redeem_url.value = obj.redeem_url || '';
    }

    function showModal(initial = null) {
      // initial: payload to populate, or null for blank (add)
      if (initial) setFormData(initial);
      else setFormData({ serial:'', product_id:'', denomination:0, cashValue:0, status:'pending', redeem_url:'' });
      modal.style.display = 'flex';
      // focus serial
      setTimeout(()=> form.serial.focus(), 50);
    }

    function hideModal() {
      modal.style.display = 'none';
    }

    closeBtn.addEventListener('click', hideModal, true);
    modal.addEventListener('click', (ev) => { if (ev.target === modal) hideModal(); }, true);

    // Save handler: update or insert into STORE and localStorage, then re-render
    saveBtn.addEventListener('click', () => {
      const data = getFormData();
      if (!data.serial) { alert('Serial is required'); return; }
      try {
        window.STORE = Array.isArray(window.STORE) ? window.STORE : [];
        // find existing by serial or product_id
        const idx = window.STORE.findIndex(it => (it.serial === data.serial || it.product_id === data.serial || it.product_id === data.product_id));
        const normalized = Object.assign({}, data);
        normalized.issued = normalized.issued || (new Date()).toISOString();
        if (idx >= 0) {
          window.STORE[idx] = Object.assign({}, window.STORE[idx], normalized);
        } else {
          window.STORE.push(normalized);
        }
        // persist to localStorage canonical key if used
        try {
          localStorage.setItem('prestigeCartItems', JSON.stringify(window.STORE));
        } catch(e){}
        // re-render and close
        if (typeof renderFromStorage === 'function') renderFromStorage();
        hideModal();
      } catch (e) { console.error('save failed', e); alert('Save failed'); }
    }, true);

    // Delete handler
    deleteBtn.addEventListener('click', () => {
      const data = getFormData();
      if (!data.serial) { alert('Serial required to delete'); return; }
      if (!confirm(`Delete item ${data.serial}?`)) return;
      try {
        window.STORE = Array.isArray(window.STORE) ? window.STORE.filter(it => (it.serial !== data.serial && it.product_id !== data.serial)) : [];
        try { localStorage.setItem('prestigeCartItems', JSON.stringify(window.STORE)); } catch(e){}
        if (typeof renderFromStorage === 'function') renderFromStorage();
        hideModal();
      } catch (e) { console.error('delete failed', e); alert('Delete failed'); }
    }, true);

    // Add New: clears form and focuses
    addNewBtn.addEventListener('click', () => {
      setFormData({ serial:'', product_id:'', denomination:0, cashValue:0, status:'pending', redeem_url:'' });
      form.serial.focus();
    }, true);

    // Expose show/hide on window for programmatic use
    window.Prestige = window.Prestige || {};
    window.Prestige.showEditor = showModal;
    window.Prestige.hideEditor = hideModal;
    window.Prestige.getEditorFormData = getFormData;
    window.Prestige.setEditorFormData = setFormData;
  }

  // Add Edit button to each card (idempotent)
  function addEditButtons() {
    document.querySelectorAll('.prestige-card').forEach(card => {
      if (card.querySelector('.prestige-edit')) return;
      const right = card.querySelector('.prestige-card-right') || card;
      const edit = document.createElement('button');
      edit.type = 'button';
      edit.className = 'prestige-edit';
      edit.textContent = 'Edit';
      edit.style.marginLeft = '8px';
      edit.style.padding = '6px 10px';
      edit.style.borderRadius = '6px';
      edit.style.border = 'none';
      edit.style.cursor = 'pointer';
      edit.style.background = '#f59e0b';
      edit.style.color = '#071028';
      // place next to redeem/copy if present
      const redeem = right.querySelector('.prestige-redeem');
      if (redeem && redeem.parentNode) redeem.parentNode.insertBefore(edit, redeem.nextSibling);
      else right.appendChild(edit);

      edit.addEventListener('click', (ev) => {
        ev.preventDefault(); ev.stopPropagation();
        const serial = card.getAttribute('data-serial') || card.querySelector('.prestige-serial')?.textContent?.trim() || '';
        // find item in STORE or build from DOM
        let item = null;
        if (Array.isArray(window.STORE)) item = window.STORE.find(it => it.serial === serial || it.product_id === serial);
        if (!item) {
          item = {
            serial: serial || '',
            product_id: card.getAttribute('data-product_id') || card.dataset.productId || '',
            denomination: Number((card.querySelector('.prestige-amount')?.textContent||'').trim().split(/\s+/)[0]) || 0,
            cashValue: Number((card.querySelector('.prestige-cash')?.textContent||'').replace(/[^0-9.-]+/g,'') || 0),
            status: (card.querySelector('.prestige-state')?.textContent||'').trim() || 'pending',
            redeem_url: card.querySelector('.prestige-redeem')?.href || ''
          };
        }
        // show modal with item
        window.Prestige.showEditor(item);
      }, true);
    });
  }

  // Ensure modal exists and buttons are added now
  createModal();
  addEditButtons();

  // Observe DOM so new cards get Edit buttons automatically
  const mo = new MutationObserver((mutations) => {
    let added = false;
    for (const m of mutations) {
      if (m.addedNodes && m.addedNodes.length) {
        for (const n of m.addedNodes) {
          if (n instanceof Element && (n.matches('.prestige-card') || n.querySelector && n.querySelector('.prestige-card'))) { added = true; break; }
        }
      }
      if (added) break;
    }
    if (added) addEditButtons();
  });
  mo.observe(document.body, { childList: true, subtree: true });

  // expose manual trigger
  window.Prestige = window.Prestige || {};
  window.Prestige.addEditButtons = addEditButtons;
})();

</script><script>

(function unifyPrestigeButtons() {
  if (window.__prestige_unify_buttons_installed) return;
  window.__prestige_unify_buttons_installed = true;

  // Which computed style properties to copy (keeps it focused and safe)
  const STYLE_PROPS = [
    'background-color','background-image','background-size','background-position',
    'color','border','border-radius','padding','font-size','font-weight',
    'box-shadow','text-decoration','display','align-items','gap','cursor'
  ];

  // Create copy button if missing and ensure redeem has class .prestige-redeem
  function ensureButtonsAndSync() {
    document.querySelectorAll('.prestige-card').forEach(card => {
      const right = card.querySelector('.prestige-card-right') || card;
      // find redeem element (link or button)
      let redeem = right.querySelector('.prestige-redeem') 
                   || right.querySelector('a[href*="redeem"], a.redeem, button.redeem, .redeem');
      // normalize redeem: if found but missing class, add it
      if (redeem && !redeem.classList.contains('prestige-redeem')) redeem.classList.add('prestige-redeem');

      // ensure copy button exists
      let copyBtn = right.querySelector('.prestige-copy');
      if (!copyBtn) {
        copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'prestige-copy';
        copyBtn.textContent = 'Copy';
        copyBtn.setAttribute('aria-label','Copy item info');
        // place next to redeem if present
        if (redeem && redeem.parentNode) redeem.parentNode.insertBefore(copyBtn, redeem.nextSibling);
        else right.appendChild(copyBtn);

        // minimal copy behavior (serial JSON) if no other handler exists
        copyBtn.addEventListener('click', (ev) => {
          ev.preventDefault(); ev.stopPropagation();
          const cardEl = copyBtn.closest('.prestige-card');
          const serial = cardEl?.getAttribute('data-serial') || cardEl?.querySelector('.prestige-serial')?.textContent?.trim() || '';
          const payload = JSON.stringify({ serial }, null, 2);
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(payload).then(()=> {
              const prev = copyBtn.textContent; copyBtn.textContent = 'Copied'; setTimeout(()=>copyBtn.textContent = prev, 1200);
            }).catch(()=> window.prompt('Copy:', payload));
          } else {
            window.prompt('Copy:', payload);
          }
        }, true);
      }

      // If redeem exists, copy its classes and computed styles to copyBtn
      if (redeem) {
        // copy class list (preserve prestige-copy)
        Array.from(redeem.classList).forEach(c => {
          if (c && c !== 'prestige-redeem') copyBtn.classList.add(c);
        });

        // copy focused computed styles
        try {
          const cs = window.getComputedStyle(redeem);
          STYLE_PROPS.forEach(prop => {
            const val = cs.getPropertyValue(prop);
            if (val) copyBtn.style.setProperty(prop, val);
          });
          // ensure display/align for inline layout
          if (!copyBtn.style.display) copyBtn.style.display = cs.getPropertyValue('display') || 'inline-flex';
          copyBtn.style.alignItems = cs.getPropertyValue('align-items') || 'center';
        } catch (e) {
          // ignore style copy errors
        }

        // copy role/aria if redeem uses them
        if (redeem.getAttribute('role') && !copyBtn.getAttribute('role')) copyBtn.setAttribute('role', redeem.getAttribute('role'));
      } else {
        // fallback visible style if no redeem found
        copyBtn.style.background = '#2563eb';
        copyBtn.style.color = '#fff';
        copyBtn.style.border = 'none';
        copyBtn.style.borderRadius = '6px';
        copyBtn.style.padding = '6px 10px';
        copyBtn.style.cursor = 'pointer';
      }
    });
  }

  // initial run
  ensureButtonsAndSync();

  // observe DOM changes so new cards get synced
  const mo = new MutationObserver((mutations) => {
    let needs = false;
    for (const m of mutations) {
      if (m.addedNodes && m.addedNodes.length) {
        for (const n of m.addedNodes) {
          if (n instanceof Element && (n.matches('.prestige-card') || n.querySelector && n.querySelector('.prestige-card'))) { needs = true; break; }
        }
      }
      if (m.type === 'attributes' && (m.attributeName === 'class' || m.attributeName?.startsWith('data-'))) needs = true;
      if (needs) break;
    }
    if (needs) ensureButtonsAndSync();
  });
  mo.observe(document.body, { childList: true, subtree: true, attributes: true, attributeFilter: ['class','data-serial','data-product_id','data-product-id'] });

  // expose manual trigger
  window.Prestige = window.Prestige || {};
  window.Prestige.syncButtonStyles = ensureButtonsAndSync;
})();
          </script>


<script>
/* Auto-match URL items to visible product-cards and add them to cart */
(function autoPickUrlItemsToCards() {
  const DELAY_MS = 350; // delay between each add
  const MAX_TO_ADD = 20;

  function safeParse(s) {
    try { return JSON.parse(s); } catch (e) { return null; }
  }

  function parseUrlItems() {
    try {
      const params = new URLSearchParams(window.location.search);
      if (!params.has('items')) return [];
      const raw = params.get('items');
      const parsed = safeParse(decodeURIComponent(raw));
      if (!Array.isArray(parsed)) return [];
      return parsed.slice(0, MAX_TO_ADD);
    } catch (e) { return []; }
  }

  function normalizeItem(raw) {
    return {
      serial: String(raw.serial || raw.product_id || '').trim(),
      denomination: Number(raw.denomination || raw.tokenCount || 0),
      title: String(raw.title || '').trim(),
      raw
    };
  }

  function findCards() {
    return Array.from(document.querySelectorAll('.product-card'));
  }

  function cardDenomination(card) {
    const d = card.dataset && (card.dataset.denomination || card.dataset.tokencount || card.getAttribute('data-denomination'));
    return d ? Number(d) : NaN;
  }

  function cardSerial(card) {
    return String(card.dataset && (card.dataset.serial || card.getAttribute('data-serial') || '')).trim();
  }

  function bestMatchCardFor(item, cards) {
    // 1) exact serial match
    if (item.serial) {
      const bySerial = cards.find(c => cardSerial(c) && cardSerial(c) === item.serial);
      if (bySerial) return bySerial;
    }

    // 2) exact denomination match
    const exact = cards.find(c => !Number.isNaN(cardDenomination(c)) && Number(cardDenomination(c)) === Number(item.denomination));
    if (exact) return exact;

    // 3) closest denomination (smallest absolute difference)
    let best = null;
    let bestDiff = Infinity;
    cards.forEach(c => {
      const cd = cardDenomination(c);
      if (Number.isNaN(cd)) return;
      const diff = Math.abs(cd - item.denomination);
      if (diff < bestDiff) { bestDiff = diff; best = c; }
    });
    return best;
  }

  function callCardAdd(card, item) {
    try {
      // If card has inline add args in data-addargs, prefer that
      const addargsRaw = card.getAttribute && card.getAttribute('data-addargs');
      if (addargsRaw) {
        try {
          const args = JSON.parse(addargsRaw);
          if (typeof window.addToCart === 'function') {
            window.addToCart.apply(null, args);
            return true;
          }
        } catch (e) {}
      }

      // If card has an onclick handler (inline or assigned), call it
      if (typeof card.onclick === 'function') {
        card.onclick();
        return true;
      }

      // If addToCart exists, call with best-effort mapping:
      // addToCart(title, denom, crystalsOrCount, type)
      if (typeof window.addToCart === 'function') {
        const title = card.querySelector('.product-title')?.textContent?.trim() || item.title || `PRESTIGE ${item.denomination}`;
        const denom = Number(card.dataset.denomination || item.denomination || 0);
        // try to infer crystals/count from data attributes or use denom*some factor
        const crystals = Number(card.dataset.crystals || card.dataset.crystalCount || card.dataset.tokencount || Math.round(denom * 2.5));
        window.addToCart(title, denom, crystals, 'parsed');
        return true;
      }

      // fallback: dispatch a click event on the card
      const ev = new MouseEvent('click', { bubbles: true, cancelable: true });
      card.dispatchEvent(ev);
      return true;
    } catch (err) {
      console.warn('callCardAdd failed', err);
      return false;
    }
  }

  function persistToLocalStorage(item) {
    try {
      const existing = JSON.parse(localStorage.getItem('prestigeCartItems') || '[]');
      // dedupe by serial
      const key = String(item.serial || item.raw?.serial || item.raw?.product_id || '');
      const filtered = existing.filter(it => String(it.serial || it.product_id || '') !== key);
      filtered.push(item.raw || item);
      localStorage.setItem('prestigeCartItems', JSON.stringify(filtered));
      localStorage.setItem('prestigeCartUpdatedAt', String(Date.now()));
    } catch (e) { /* ignore */ }
  }

  function alreadyAdded(serial, addedSet) {
    if (!serial) return false;
    return addedSet.has(serial);
  }

  // main runner
  function runAutoPick(options = {}) {
    const itemsRaw = parseUrlItems();
    if (!itemsRaw.length) return { picked: 0, reason: 'no-items-in-url' };

    const items = itemsRaw.map(normalizeItem);
    const cards = findCards();
    if (!cards.length) return { picked: 0, reason: 'no-product-cards-found' };

    const addedSerials = new Set();
    const scheduled = [];

    items.forEach((it, idx) => {
      // skip duplicates in URL or already in STORE/localStorage
      const key = it.serial || `${it.denomination}-${idx}`;
      if (alreadyAdded(it.serial, addedSerials)) return;
      // schedule
      scheduled.push({ it, idx });
      addedSerials.add(it.serial || key);
    });

    scheduled.slice(0, options.limit || 10).forEach((job, i) => {
      setTimeout(() => {
        const { it } = job;
        const match = bestMatchCardFor(it, cards);
        if (match) {
          const ok = callCardAdd(match, it);
          // persist for cross-page pickup and for cart page listeners
          persistToLocalStorage(it);
          // if you have a central handler, call it too
          try {
            const handler = window.Prestige?.handleSelectPayload || window.handleSelectPayload;
            if (typeof handler === 'function') handler(it);
          } catch (e) {}
          // emit event
          try { document.dispatchEvent(new CustomEvent('prestige:autoPicked', { detail: { item: it, matchedCard: match } })); } catch (e) {}
        } else {
          // no match found: persist raw so store can import it
          persistToLocalStorage(it);
        }
      }, i * (options.delayMs || DELAY_MS));
    });

    return { scheduled: scheduled.length, limit: options.limit || 10 };
  }

  // run after DOM ready
  function onReady(fn) {
    if (document.readyState === 'complete' || document.readyState === 'interactive') return fn();
    document.addEventListener('DOMContentLoaded', fn);
  }

  // Expose API and auto-run once (only if items present)
  window.Prestige = window.Prestige || {};
  window.Prestige.autoPickUrlToCards = runAutoPick;

  onReady(() => {
    const params = new URLSearchParams(window.location.search);
    if (params.has('items')) {
      // run with defaults; limit 10 adds
      runAutoPick({ delayMs: 350, limit: 10 });
    }
  });
})();
</script>

<script>
(function ensureRailsInCheckout(){
  if (window.__ensureRailsInCheckout) return;
  window.__ensureRailsInCheckout = true;

  const RAILS_ID = 'checkoutRails';
  const CHECKOUT_SELECTOR = '#checkoutPanel';
  const VISIBLE = 'visible';
  const HIDDEN = 'hidden';
  const rails = document.getElementById(RAILS_ID);
  if (!rails) return;

  function checkoutVisible() {
    const el = document.querySelector(CHECKOUT_SELECTOR);
    if (!el) return false;
    const style = getComputedStyle(el);
    return style.display !== 'none' && style.visibility !== 'hidden' && el.getAttribute('aria-hidden') !== 'true' && el.offsetParent !== null;
  }

  function ensureInside() {
    const checkout = document.querySelector(CHECKOUT_SELECTOR);
    if (!checkout) return false;
    const target = checkout.querySelector('.chamber-grid, .checkout-dock-panel, #checkoutPanelInner') || checkout;
    if (rails.parentElement !== target) {
      target.appendChild(rails);
      const pos = getComputedStyle(target).position;
      if (!pos || pos === 'static') target.style.position = target.style.position || 'relative';
    }
    return true;
  }

  function apply() {
    const attached = ensureInside();
    const show = attached && checkoutVisible();
    rails.classList.toggle(VISIBLE, show);
    rails.classList.toggle(HIDDEN, !show);
    rails.setAttribute('aria-hidden', show ? 'false' : 'true');
  }

  // Observe checkout for visibility changes
  const el = document.querySelector(CHECKOUT_SELECTOR);
  if (el) {
    const mo = new MutationObserver(apply);
    mo.observe(el, { attributes: true, attributeFilter: ['class','style','aria-hidden'] });
  }
  // body observer to catch late insertion
  const bodyMo = new MutationObserver(() => { apply(); });
  bodyMo.observe(document.body, { childList: true, subtree: true });

  apply();
})();

  
  (function placeRailsRight(){
  if (window.__placeRailsRight) return;
  window.__placeRailsRight = true;
  const rails = document.getElementById('checkoutRails') || document.querySelector('.checkout-rails-grid');
  const checkout = document.getElementById('checkoutPanel');
  if (!rails || !checkout) return;
  // target the right column of the chamber-grid (second column)
  const rightCol = checkout.querySelector('.chamber-grid > :nth-child(2)') || checkout.querySelector('.store-panel') || checkout;
  if (rightCol && rails.parentElement !== rightCol) {
    rightCol.appendChild(rails);
    // ensure rightCol is positioned for absolute children if needed
    const pos = getComputedStyle(rightCol).position;
    if (!pos || pos === 'static') rightCol.style.position = rightCol.style.position || 'relative';
  }
  // ensure grid aligns to the far right
  rails.style.justifySelf = 'end';
})();

})();

</script>
    
<script>
/* Combined bundle: robust add, search dropdown, pfIssue update ‚Äî idempotent */
(function prestige_combined_bundle(){
  if (window.__prestige_combined_bundle_installed) return;
  window.__prestige_combined_bundle_installed = true;

  const ARCHIVE_KEY = 'prestige_archive_session_v1';
  const HOSE_PREFIX = 'prestige_archive_';
  const $id = id => document.getElementById(id);

  /* ---------- storage helpers ---------- */
  function loadArchive(hoseName = null){
    const key = hoseName ? (HOSE_PREFIX + hoseName) : ARCHIVE_KEY;
    try { return JSON.parse(sessionStorage.getItem(key) || '[]'); } catch(e){ return []; }
  }
  function saveArchive(arr, hoseName = null){
    const key = hoseName ? (HOSE_PREFIX + hoseName) : ARCHIVE_KEY;
    try { sessionStorage.setItem(key, JSON.stringify(Array.isArray(arr)?arr:[])); } catch(e){}
  }

  /* ---------- robust add to archive ---------- */
  (function replaceAddToArchive(){
    if (window.__prestige_add_fix_installed) return;
    window.__prestige_add_fix_installed = true;

    // helpers (reuse existing parser if available)
    const parseInput = (raw) => {
      if (window.Prestige?.archive?.parseInputToItems) return window.Prestige.archive.parseInputToItems(raw);
      try {
        const p = JSON.parse(raw);
        if (Array.isArray(p)) return p;
        if (p && typeof p === 'object') return [p];
      } catch(e){}
      return String(raw || '').split(/\r?\n{1,}|\|\|/).map(s=>s.trim()).filter(Boolean).map(s=>{
        try { return JSON.parse(s); } catch(e){ return { raw: s }; }
      });
    };

    function nowIso(){ return new Date().toISOString(); }
    function makeId(){ return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,9); }

    function normalize(it, snapshotFlag, noteText){
      const obj = Object.assign({}, it || {});
      if (!obj.id) obj.id = makeId();
      if (!obj.createdAt) obj.createdAt = nowIso();
      if (snapshotFlag) obj.snapshot = true;
      if (noteText && !obj.note) obj.note = noteText;
      if (!obj.title) obj.title = (obj.title || obj.SERIAL || obj.PRODUCT_ID || obj.name || obj.raw || obj.id).toString().slice(0,60);
      return obj;
    }

    function robustAddFromPaste(rawInput){
      const pasteArea = $id('prestigePasteArea');
      const snapshotToggle = $id('prestigeSnapshotToggle');
      const shortNoteEl = $id('prestigeShortNote');

      const raw = rawInput == null ? (pasteArea?.value || '') : rawInput;
      const parsed = Array.isArray(raw) ? raw : parseInput(String(raw || '').trim());
      if (!parsed || !parsed.length) return [];

      const snapshotFlag = !!(snapshotToggle?.checked);
      const noteText = String(shortNoteEl?.value || '').trim();

      const items = parsed.map(p => normalize(p, snapshotFlag, noteText));

      // prepend new items so newest appear first
      const existing = loadArchive();
      const merged = items.concat(existing);
      saveArchive(merged);

      // clear paste area and optional note/toggle
      try { if (pasteArea) pasteArea.value = ''; } catch(e){}
      try { if (shortNoteEl) shortNoteEl.value = ''; } catch(e){}
      try { if (snapshotToggle) snapshotToggle.checked = false; } catch(e){}

      // re-render if available
      if (typeof window.renderArchiveList === 'function') {
        try { window.renderArchiveList(); } catch(e){}
      } else {
        const countEl = $id('prestigeArchiveCount');
        if (countEl) countEl.textContent = String(merged.length);
      }

      // emit events
      try { window.dispatchEvent(new CustomEvent('prestige:archivePrepared', { detail: { items } })); } catch(e){}
      try { window.dispatchEvent(new CustomEvent('prestige:archiveUpdated', { detail: { count: merged.length } })); } catch(e){}

      return items;
    }

    // wire Add button idempotently
    const addBtn = $id('prestigeAddArchive');
    if (addBtn && !addBtn.__prestige_robust_add_wired) {
      addBtn.addEventListener('click', () => robustAddFromPaste(), { capture: true });
      addBtn.__prestige_robust_add_wired = true;
    }

    // expose API
    window.Prestige = window.Prestige || {};
    window.Prestige.archive = window.Prestige.archive || {};
    window.Prestige.archive.addRobust = robustAddFromPaste;

  })();

  /* ---------- search dropdown + fill short note (and pfIssue) ---------- */
  (function prestige_search_to_shortnote(){
    if (window.__prestige_search_to_shortnote_installed) return;
    window.__prestige_search_to_shortnote_installed = true;

    function findSearchInput(){
      return $id('prestigeArchiveSearch') || document.querySelector('input[placeholder*="Search archive"]') || document.querySelector('input[aria-label*="archive"]') || document.querySelector('input[type="search"]');
    }

    function ensureDropdown(root){
      let dd = root._prestige_search_dropdown;
      if (dd && document.body.contains(dd)) return dd;
      dd = document.createElement('div');
      dd.className = 'prestige-archive-search-dropdown';
      dd.style.position = 'absolute';
      dd.style.zIndex = 99999;
      dd.style.background = '#071028';
      dd.style.color = '#cfe6ff';
      dd.style.border = '1px solid rgba(255,255,255,0.04)';
      dd.style.borderRadius = '6px';
      dd.style.boxShadow = '0 6px 18px rgba(0,0,0,0.6)';
      dd.style.maxHeight = '260px';
      dd.style.overflow = 'auto';
      dd.style.minWidth = '320px';
      dd.style.padding = '6px';
      dd.style.fontSize = '13px';
      dd.style.display = 'none';
      document.body.appendChild(dd);
      root._prestige_search_dropdown = dd;
      return dd;
    }

    function positionDropdown(input, dd){
      const r = input.getBoundingClientRect();
      dd.style.left = (window.scrollX + r.left) + 'px';
      dd.style.top = (window.scrollY + r.bottom + 6) + 'px';
      dd.style.width = Math.max(320, r.width) + 'px';
    }

    function matchArchive(query){
      if (!query) return [];
      const q = String(query).trim().toLowerCase();
      const arr = loadArchive();
      if (!arr.length) return [];
      const results = arr.filter(it => {
        const fields = [it.title, it.serial, it.id, it.raw, it.SERIAL, it.PRODUCT_ID].filter(Boolean).map(s => String(s).toLowerCase());
        return fields.some(f => f.includes(q));
      });
      return results.slice(0, 200);
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }

    function buildRowHtml(it){
      const title = (it.title || it.SERIAL || it.id || '').toString();
      const serial = it.serial ? ` ‚Ä¢ ${it.serial}` : '';
      const snap = it.snapshot ? ' <span style="background:#ffd24d;color:#071018;padding:2px 6px;border-radius:6px;font-weight:700;margin-left:8px">SNAP</span>' : '';
      return `<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
        <div style="min-width:0;overflow:hidden">
          <div style="font-weight:700;color:#e6eef8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(title)}</div>
          <div style="font-size:12px;color:#9fb0d6;margin-top:4px">${escapeHtml(String(it.id||''))}${escapeHtml(serial)}</div>
        </div>
        <div style="flex:0 0 auto">${snap}<button class="prestige-search-fill-btn" data-id="${escapeAttr(it.id)}" style="margin-left:8px;padding:6px 8px;border-radius:6px;background:#2b6cff;color:#fff;border:0;cursor:pointer">Fill</button></div>
      </div>`;
    }

    // short-field getter: prefer pfIssue, fallback to prestigeShortNote
    function getShortField() {
      return $id('pfIssue') || $id('prestigeShortNote') || null;
    }

    function fillShortNoteFromItems(items){
      if (!items || !items.length) return false;
      const shortNoteEl = getShortField();
      if (!shortNoteEl) return false;
      const parts = items.map(it => {
        const qty = (it.qty && Number(it.qty) > 1) ? `${it.qty}x ` : '';
        const title = String(it.title || it.SERIAL || it.id).slice(0,40);
        const serial = it.serial ? ` (S:${String(it.serial).slice(0,12)})` : '';
        return `${qty}${title}${serial}`;
      });
      let text = parts.join('; ');
      if (text.length > 240) text = text.slice(0,237) + '...';
      shortNoteEl.value = text;
      try { shortNoteEl.focus(); } catch(e){}
      try { window.dispatchEvent(new CustomEvent('prestige:archiveSearchFilled', { detail: { count: items.length } })); } catch(e){}
      return true;
    }

    function wireSearch() {
      const input = findSearchInput();
      if (!input) return;
      if (input.__prestige_search_wired) return;
      const dd = ensureDropdown(input);

      let lastQuery = '';
      let lastResults = [];

      function renderResults(results, query){
        dd.innerHTML = '';
        if (!results.length) {
          dd.innerHTML = `<div style="padding:8px;color:#9fb0d6">No matches for "${escapeHtml(query)}"</div>`;
          dd.style.display = 'block';
          positionDropdown(input, dd);
          return;
        }
        // header with actions (includes Update button appended later by integrated patch)
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'center';
        header.style.marginBottom = '6px';
        header.innerHTML = `<div style="color:#9fb0d6;font-size:12px">${results.length} match${results.length>1?'es':''}</div>
          <div style="display:flex;gap:6px">
            <button id="prestigeSearchSelectAll" style="padding:6px 8px;border-radius:6px;background:#2b6cff;color:#fff;border:0;cursor:pointer">Select all</button>
            <button id="prestigeSearchFillMatches" style="padding:6px 8px;border-radius:6px;background:#ffd24d;color:#071018;border:0;cursor:pointer">Fill Short Description</button>
          </div>`;
        dd.appendChild(header);

        // list
        const list = document.createElement('div');
        list.style.display = 'grid';
        list.style.gap = '6px';
        results.forEach(it => {
          const row = document.createElement('div');
          row.className = 'prestige-search-row';
          row.style.padding = '8px';
          row.style.borderRadius = '6px';
          row.style.cursor = 'pointer';
          row.style.background = 'transparent';
          row.innerHTML = buildRowHtml(it);
          row.dataset.id = it.id;
          // click row fills short note for that single item
          row.addEventListener('click', (ev) => {
            ev.stopPropagation();
            fillShortNoteFromItems([it]);
            dd.style.display = 'none';
          });
          list.appendChild(row);
        });
        dd.appendChild(list);
        dd.style.display = 'block';
        positionDropdown(input, dd);

        // wire header buttons
        dd.querySelector('#prestigeSearchSelectAll')?.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const ids = results.map(r => r.id);
          dd._selectedIds = ids;
          Array.from(dd.querySelectorAll('.prestige-search-row')).forEach(r => r.style.background = 'rgba(255,255,255,0.02)');
        });
        dd.querySelector('#prestigeSearchFillMatches')?.addEventListener('click', (ev) => {
          ev.stopPropagation();
          const ids = dd._selectedIds && dd._selectedIds.length ? dd._selectedIds : results.map(r => r.id);
          const archive = loadArchive();
          const items = archive.filter(i => ids.includes(i.id));
          if (items.length) fillShortNoteFromItems(items);
          dd.style.display = 'none';
        });
      }

      // keyboard navigation and escape
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { dd.style.display = 'none'; input.blur(); }
      });

      // input handler with debounce
      let timer = null;
      input.addEventListener('input', (e) => {
        const q = String(input.value || '').trim();
        if (q === lastQuery) return;
        lastQuery = q;
        clearTimeout(timer);
        timer = setTimeout(() => {
          if (!q) { dd.style.display = 'none'; return; }
          const results = matchArchive(q);
          lastResults = results;
          renderResults(results, q);
          try { window.dispatchEvent(new CustomEvent('prestige:archiveSearchMatched', { detail: { query: q, count: results.length } })); } catch(e){}
        }, 180);
      });

      // click outside closes dropdown
      document.addEventListener('click', (ev) => {
        if (!dd.contains(ev.target) && ev.target !== input) dd.style.display = 'none';
      });

      // reposition on resize/scroll
      window.addEventListener('resize', () => { if (dd.style.display === 'block') positionDropdown(input, dd); });
      window.addEventListener('scroll', () => { if (dd.style.display === 'block') positionDropdown(input, dd); }, true);

      input.__prestige_search_wired = true;
    }

    wireSearch();
    const scan = setInterval(wireSearch, 1000);
    setTimeout(() => clearInterval(scan), 30_000);

    // expose helper
    window.Prestige = window.Prestige || {};
    window.Prestige.archive = window.Prestige.archive || {};
    window.Prestige.archive.searchAndFillShortNote = function(query){
      const results = matchArchive(query);
      if (!results.length) return false;
      const archive = loadArchive();
      const ids = results.map(r => r.id);
      const items = archive.filter(i => ids.includes(i.id));
      return fillShortNoteFromItems(items);
    };

  })();

  /* ---------- pfIssue patch + Update button integration ---------- */
  (function prestige_integrated_pfIssue_patch(){
    if (window.__prestige_integrated_pfIssue_patch_installed) return;
    window.__prestige_integrated_pfIssue_patch_installed = true;

    function buildCompactText(items, maxChars = 240) {
      if (!items || !items.length) return '';
      const parts = items.map(it => {
        const qty = (it.qty && Number(it.qty) > 1) ? `${it.qty}x ` : '';
        const title = String(it.title || it.SERIAL || it.id).slice(0,40);
        const serial = it.serial ? ` (S:${String(it.serial).slice(0,12)})` : '';
        return `${qty}${title}${serial}`;
      });
      let text = parts.join('; ');
      if (text.length > maxChars) text = text.slice(0, maxChars - 3) + '...';
      return text;
    }

    function getShortField() {
      return $id('pfIssue') || $id('prestigeShortNote') || null;
    }

    function fillPfIssueFromItems(items){
      if (!items || !items.length) return false;
      const field = getShortField();
      if (!field) return false;
      field.value = buildCompactText(items);
      try { field.focus(); } catch(e){}
      try { window.dispatchEvent(new CustomEvent('prestige:archiveSearchFilled', { detail: { count: items.length } })); } catch(e){}
      return true;
    }

    // enhance dropdowns: add Update button and ensure Fill buttons target pfIssue
    function enhanceDropdowns() {
      const dropdowns = Array.from(document.querySelectorAll('.prestige-archive-search-dropdown'));
      dropdowns.forEach(dd => {
        if (dd.__prestige_pf_update_added) return;
        const header = dd.querySelector('div');
        if (header) {
          const updateBtn = document.createElement('button');
          updateBtn.type = 'button';
          updateBtn.textContent = 'Update';
          updateBtn.style.cssText = 'padding:6px 8px;border-radius:6px;background:#20c997;color:#071018;border:0;cursor:pointer;margin-left:6px';
          updateBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            const rows = Array.from(dd.querySelectorAll('.prestige-search-row'));
            const ids = rows.map(r => r.dataset.id).filter(Boolean);
            const archive = loadArchive();
            const items = ids.length ? archive.filter(i => ids.includes(i.id)) : archive.slice(0,10);
            if (items.length) fillPfIssueFromItems(items);
            dd.style.display = 'none';
          }, { capture: true });
          const actions = header.querySelector('div') || header;
          actions.appendChild(updateBtn);
        }
        Array.from(dd.querySelectorAll('.prestige-search-fill-btn')).forEach(btn => {
          if (btn.__prestige_pf_fill_wired) return;
          btn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            const id = btn.getAttribute('data-id');
            if (!id) return;
            const archive = loadArchive();
            const item = archive.find(i => String(i.id) === String(id));
            if (item) fillPfIssueFromItems([item]);
            try { dd.style.display = 'none'; } catch(e){}
          }, { capture: true });
          btn.__prestige_pf_fill_wired = true;
        });
        dd.__prestige_pf_update_added = true;
      });
    }

    enhanceDropdowns();
    const ddScan = setInterval(enhanceDropdowns, 700);
    setTimeout(() => clearInterval(ddScan), 30000);

    // prepared event fills pfIssue
    if (!window.__prestige_prepared_pfIssue_wired) {
      window.addEventListener('prestige:archivePrepared', (e) => {
        try {
          const items = e?.detail?.items || null;
          if (items && items.length) fillPfIssueFromItems(items);
        } catch(err){ console.warn('[prestige] prepared->pfIssue fill failed', err); }
      });
      window.__prestige_prepared_pfIssue_wired = true;
    }

    // expose API
    window.Prestige = window.Prestige || {};
    window.Prestige.archive = window.Prestige.archive || {};
    Object.assign(window.Prestige.archive, {
      searchAndFillPfIssue: function(query){
        if (!query) return false;
        const q = String(query).trim().toLowerCase();
        const arr = loadArchive();
        if (!arr.length) return false;
        const results = arr.filter(it => {
          const fields = [it.title, it.serial, it.id, it.raw, it.SERIAL, it.PRODUCT_ID].filter(Boolean).map(s => String(s).toLowerCase());
          return fields.some(f => f.includes(q));
        });
        if (!results.length) return false;
        return fillPfIssueFromItems(results);
      },
      fillPfIssueFromItems,
      buildCompactText
    });

  })();

  /* ---------- final: ensure Add/Clear/Copy wiring exists (defensive) ---------- */
  (function ensure_basic_buttons(){
    // Clear button
    function doClearArchive({ confirmBefore = true } = {}) {
      if (confirmBefore && !confirm('Clear all saved archive items? This will remove them from this session.')) return false;
      try {
        saveArchive([]);
        if (typeof window.renderArchiveList === 'function') try { window.renderArchiveList(); } catch(e){}
        const sn = $id('prestigeShortNote'); if (sn) sn.value = '';
        const pf = $id('pfIssue'); if (pf) pf.value = '';
        try { window.dispatchEvent(new CustomEvent('prestige:archiveUpdated', { detail: { cleared: true } })); } catch(e){}
        return true;
      } catch(e){ console.warn('[prestige] doClearArchive failed', e); return false; }
    }

    async function doCopyArchive({ onlyIds = false } = {}) {
      try {
        const arr = loadArchive();
        const payload = onlyIds ? arr.map(i => i.id) : arr;
        const text = JSON.stringify(payload, null, 2);
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
        }
        try { window.dispatchEvent(new CustomEvent('prestige:archiveCopied', { detail: { count: arr.length } })); } catch(e){}
        if (arr && arr.length) {
          const pf = $id('pfIssue') || $id('prestigeShortNote');
          if (pf) pf.value = (typeof window.Prestige?.archive?.buildCompactText === 'function') ? window.Prestige.archive.buildCompactText(arr.slice(0,10)) : arr.slice(0,10).map(i=>i.title||i.id).join('; ');
        }
        return true;
      } catch(e){ console.warn('[prestige] doCopyArchive failed', e); return false; }
    }

    // wire buttons defensively
    function wireButtons() {
      const clearCandidates = [$id('prestigeClearArchive'), $id('prestigeClear'), ...Array.from(document.querySelectorAll('button, a')).filter(el => el.textContent && el.textContent.trim().toLowerCase() === 'clear')].filter(Boolean);
      clearCandidates.forEach(btn => {
        if (btn.__prestige_clear_wired) return;
        btn.addEventListener('click', (ev) => { ev.preventDefault(); doClearArchive({ confirmBefore: true }); }, { capture: true });
        btn.__prestige_clear_wired = true;
      });

     // Updated, non-destructive copy wiring (idempotent)
(function prestige_copy_wiring_update(){
  // guard
  if (window.__prestige_copy_wiring_update_installed) return;
  window.__prestige_copy_wiring_update_installed = true;

  const $id = id => document.getElementById(id);

  // helper: copy text to clipboard
  async function _copyText(text){
    try {
      if (!text) return false;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
      }
      return true;
    } catch(e){ console.warn('[prestige] _copyText failed', e); return false; }
  }

  // built-in behaviors (use existing programmatic helpers if present)
  async function copyPfIssue(){
    const pf = $id('pfIssue') || $id('prestigeShortNote');
    const text = pf ? String(pf.value || '') : '';
    const ok = await _copyText(text);
    try { window.dispatchEvent(new CustomEvent('prestige:pfIssueCopied', { detail: { ok: !!ok, length: text.length || 0 } })); } catch(e){}
    return ok;
  }

  async function copyArchive(onlyIds = false){
    // prefer existing programmatic helper if available
    if (window.Prestige?.archive?.doCopyArchive) {
      try { return await window.Prestige.archive.doCopyArchive({ onlyIds }); } catch(e){ /* fallthrough */ }
    }
    // fallback: read sessionStorage directly
    try {
      const arr = JSON.parse(sessionStorage.getItem('prestige_archive_session_v1') || '[]');
      const payload = onlyIds ? arr.map(i => i.id) : arr;
      return await _copyText(JSON.stringify(payload, null, 2));
    } catch(e){ console.warn('[prestige] copyArchive fallback failed', e); return false; }
  }

  // determine mode and run
  async function runMode(mode, el){
    if (!mode || mode === 'pf') return await copyPfIssue();
    if (mode === 'archive') return await copyArchive(false);
    if (mode === 'ids') return await copyArchive(true);
    // custom function reference like "window.myFn"
    if (typeof mode === 'string' && mode.startsWith('window.')) {
      try {
        const fn = mode.split('.').slice(1).reduce((o,k)=>o && o[k], window);
        if (typeof fn === 'function') return await Promise.resolve(fn(el));
      } catch(e){ console.warn('[prestige] custom copy fn failed', e); }
    }
    return false;
  }

  // Build candidate list conservatively: explicit ids and opt-in attributes only
  function gatherCopyCandidates(){
    const set = new Set();
    const explicit = [$id('prestigeCopyArchive'), $id('prestigeCopy')];
    explicit.forEach(e => { if (e) set.add(e); });
    // any element that explicitly opts in with data-copy-type or data-copy-fn
    document.querySelectorAll('[data-copy-type], [data-copy-fn]').forEach(e => set.add(e));
    return Array.from(set);
  }

  // Wire candidates idempotently
  function wireCopyCandidates(){
    const candidates = gatherCopyCandidates();
    candidates.forEach(btn => {
      if (!btn || btn.__prestige_copy_wired) return;
      // determine mode: attribute preferred; fall back to sensible defaults
      let mode = btn.getAttribute && btn.getAttribute('data-copy-type');
      const custom = btn.getAttribute && btn.getAttribute('data-copy-fn');
      if (custom) mode = custom;
      if (!mode) {
        // default mapping: #prestigeCopyArchive -> archive, #prestigeCopy -> pf, otherwise pf
        if (btn.id === 'prestigeCopyArchive') mode = 'archive';
        else if (btn.id === 'prestigeCopy') mode = 'pf';
        else mode = 'pf';
      }

      // attach handler (non-destructive: does not clone or remove other handlers)
      btn.addEventListener('click', async (ev) => {
        // allow opt-out
        if (btn.getAttribute && btn.getAttribute('data-copy-skip') === 'true') return;
        ev.preventDefault();
        ev.stopPropagation();
        const ok = await runMode(mode, btn);
        // brief visual feedback
        try {
          const original = btn.textContent;
          btn.textContent = ok ? 'Copied' : (original || 'Copy');
          setTimeout(()=>{ try { btn.textContent = original; } catch(e){} }, 1200);
        } catch(e){}
      }, { capture: false });

      btn.__prestige_copy_wired = true;
    });
  }

  // initial wiring and short re-scan for dynamic DOM
  wireCopyCandidates();
  const _scan = setInterval(wireCopyCandidates, 900);
  setTimeout(()=>clearInterval(_scan), 30000);

  // expose helpers
  window.Prestige = window.Prestige || {};
  window.Prestige.archive = window.Prestige.archive || {};
  Object.assign(window.Prestige.archive, {
    copyPfIssue,
    doCopyArchive: copyArchive,
    _copyModeStatus: function(){
      return gatherCopyCandidates().map(el => ({ id: el.id || null, text: (el.textContent||'').trim().slice(0,40), dataCopyType: el.getAttribute && el.getAttribute('data-copy-type'), dataCopyFn: el.getAttribute && el.getAttribute('data-copy-fn'), wired: !!el.__prestige_copy_wired }));
    }
  });

})();

      // ensure Add button wired to addRobust if present
      const addBtn = $id('prestigeAddArchive');
      if (addBtn && !addBtn.__prestige_add_wired_safe) {
        addBtn.addEventListener('click', async (ev) => {
          ev.preventDefault();
          const pasteArea = $id('prestigePasteArea');
          const raw = pasteArea?.value || null;
          let items = [];
          try {
            if (window.Prestige?.archive?.addRobust) {
              const res = window.Prestige.archive.addRobust(raw);
              items = (res && typeof res.then === 'function') ? await res : res || [];
            } else {
              // fallback: simple save
              const now = new Date().toISOString();
              const parsed = raw ? [ { raw } ] : [];
              items = parsed.map(p => Object.assign({ id: Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,9), createdAt: now, title: p.title || p.SERIAL || p.raw || p.id }, p));
              const existing = loadArchive();
              saveArchive(items.concat(existing));
            }
          } catch(e){ console.warn('[prestige] add fallback failed', e); }
          // update UI and pfIssue
          if (items && items.length) {
            if (typeof window.Prestige?.archive?.fillPfIssueFromItems === 'function') window.Prestige.archive.fillPfIssueFromItems(items);
            else {
              const pf = $id('pfIssue') || $id('prestigeShortNote');
              if (pf) pf.value = items.map(i=>i.title||i.id).slice(0,10).join('; ');
            }
          }
          try { if (pasteArea) pasteArea.value = ''; } catch(e){}
          if (typeof window.renderArchiveList === 'function') try { window.renderArchiveList(); } catch(e){}
          try { window.dispatchEvent(new CustomEvent('prestige:archiveAdded', { detail: { items } })); } catch(e){}
        }, { capture: true });
        addBtn.__prestige_add_wired_safe = true;
      }
    }

    wireButtons();
    const scan = setInterval(wireButtons, 1000);
    setTimeout(() => clearInterval(scan), 30000);

    // expose helpers
    window.Prestige = window.Prestige || {};
    window.Prestige.archive = window.Prestige.archive || {};
    Object.assign(window.Prestige.archive, {
      doClearArchive,
      doCopyArchive
    });

  })();

})();
  
  
  
  
  
  
  /* Patch: Clear only archive and add per-item delete controls ‚Äî idempotent */
(function prestige_clear_and_delete_patch(){
  if (window.__prestige_clear_and_delete_patch_installed) return;
  window.__prestige_clear_and_delete_patch_installed = true;

  const ARCHIVE_KEY = 'prestige_archive_session_v1';
  const $id = id => document.getElementById(id);

  function loadArchive(){ try { return JSON.parse(sessionStorage.getItem(ARCHIVE_KEY) || '[]'); } catch(e){ return []; } }
  function saveArchive(arr){ try { sessionStorage.setItem(ARCHIVE_KEY, JSON.stringify(Array.isArray(arr)?arr:[])); } catch(e){} }

  // Replace existing clear so it does NOT clear pfIssue or prestigeShortNote
  function doClearArchiveOnly({ confirmBefore = true } = {}) {
    if (confirmBefore && !confirm('Clear all saved archive items? This will remove them from this session.')) return false;
    try {
      saveArchive([]);
      // refresh UI if available
      if (typeof window.renderArchiveList === 'function') try { window.renderArchiveList(); } catch(e){}
      // emit events but do NOT touch pfIssue or prestigeShortNote
      try { window.dispatchEvent(new CustomEvent('prestige:archiveUpdated', { detail: { cleared: true } })); } catch(e){}
      try { window.dispatchEvent(new CustomEvent('prestige:archiveCleared', { detail: {} })); } catch(e){}
      // re-render delete controls if present
      try { window.Prestige.archive.renderDeleteControls(); } catch(e){}
      return true;
    } catch(err){ console.warn('[prestige] doClearArchiveOnly failed', err); return false; }
  }

  // Delete a single item by id
  function deleteArchiveItem(id){
    if (!id) return false;
    try {
      const arr = loadArchive();
      const idx = arr.findIndex(i => String(i.id) === String(id));
      if (idx === -1) return false;
      arr.splice(idx, 1);
      saveArchive(arr);
      // refresh UI
      if (typeof window.renderArchiveList === 'function') try { window.renderArchiveList(); } catch(e){}
      // remove any DOM row with matching data-id and class
      try {
        const row = document.querySelector(`.prestige-archive-row[data-id="${CSS.escape(String(id))}"]`) || document.querySelector(`[data-id="${CSS.escape(String(id))}"]`);
        if (row) row.remove();
      } catch(e){}
      // re-render delete controls
      try { window.Prestige.archive.renderDeleteControls(); } catch(e){}
      try { window.dispatchEvent(new CustomEvent('prestige:archiveDeleted', { detail: { id } })); } catch(e){}
      try { window.dispatchEvent(new CustomEvent('prestige:archiveUpdated', { detail: { count: loadArchive().length } })); } catch(e){}
      return true;
    } catch(err){ console.warn('[prestige] deleteArchiveItem failed', err); return false; }
  }

  // Create or update per-item delete buttons inside existing archive list rows
  function injectDeleteButtonsIntoRows(){
    try {
      const list = $id('prestigeArchiveList') || document.querySelector('.archive-list') || null;
      if (!list) return false;
      // For each child row that has data-id or data-id attribute, add a delete button
      Array.from(list.children).forEach(row => {
        // determine id
        const id = row.dataset?.id || row.getAttribute('data-id') || null;
        if (!id) return;
        // mark row for styling and future selection
        row.classList.add('prestige-archive-row');
        row.setAttribute('data-id', id);
        // skip if already has delete button
        if (row.querySelector('.prestige-archive-delete')) return;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'prestige-archive-delete';
        btn.textContent = 'Delete';
        btn.style.cssText = 'margin-left:8px;padding:4px 8px;border-radius:6px;background:#ff6b6b;color:#fff;border:0;cursor:pointer';
        btn.addEventListener('click', (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          if (!confirm('Delete this archive item?')) return;
          deleteArchiveItem(id);
        }, { capture: true });
        // append to row (try to place at end)
        try { row.appendChild(btn); } catch(e){}
      });
      return true;
    } catch(e){ console.warn('[prestige] injectDeleteButtonsIntoRows failed', e); return false; }
  }

  // Fallback management panel if archive list DOM is not present or rows lack data-id
  function renderArchiveManagementPanel(){
    try {
      let panel = $id('prestigeArchiveManagePanel');
      if (!panel) {
        panel = document.createElement('div');
        panel.id = 'prestigeArchiveManagePanel';
        panel.style.cssText = 'margin-top:8px;padding:8px;border:1px solid rgba(255,255,255,0.04);border-radius:6px;background:rgba(7,16,40,0.6);color:#cfe6ff';
        const paste = $id('prestigePasteArea');
        if (paste && paste.parentNode) paste.parentNode.insertBefore(panel, paste.nextSibling);
        else document.body.appendChild(panel);
      }
      const arr = loadArchive();
      if (!arr.length) {
        panel.innerHTML = '<div style="color:#9fb0d6">No saved archive items</div>';
        return panel;
      }
      // build list
      const rows = arr.map(it => {
        const title = escapeHtml(String(it.title || it.SERIAL || it.id).slice(0,60));
        const id = escapeHtml(String(it.id));
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.02)">
          <div style="min-width:0;overflow:hidden"><div style="font-weight:700">${title}</div><div style="font-size:12px;color:#9fb0d6">${id}</div></div>
          <div style="flex:0 0 auto"><button class="prestige-manage-delete" data-id="${id}" style="padding:6px 8px;border-radius:6px;background:#ff6b6b;color:#fff;border:0;cursor:pointer">Delete</button></div>
        </div>`;
      }).join('');
      panel.innerHTML = `<div style="font-weight:700;margin-bottom:6px">Archive Manager</div>${rows}`;
      // wire delete buttons
      Array.from(panel.querySelectorAll('.prestige-manage-delete')).forEach(btn => {
        if (btn.__wired) return;
        btn.addEventListener('click', (ev) => {
          ev.preventDefault();
          const id = btn.getAttribute('data-id');
          if (!id) return;
          if (!confirm('Delete this archive item?')) return;
          deleteArchiveItem(id);
        }, { capture: true });
        btn.__wired = true;
      });
      return panel;
    } catch(e){ console.warn('[prestige] renderArchiveManagementPanel failed', e); return null; }
  }

  // Public API to render delete controls (tries row injection first, then management panel)
  function renderDeleteControls(){
    const ok = injectDeleteButtonsIntoRows();
    if (!ok) renderArchiveManagementPanel();
  }

  // Wire the existing Clear button(s) to the new clear function (idempotent)
  function wireClearButtonsToArchiveOnly(){
    const candidates = [$id('prestigeClearArchive'), $id('prestigeClear'), ...Array.from(document.querySelectorAll('button, a')).filter(el => el.textContent && el.textContent.trim().toLowerCase() === 'clear')].filter(Boolean);
    candidates.forEach(btn => {
      if (btn.__prestige_clear_rewired) return;
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        doClearArchiveOnly({ confirmBefore: true });
      }, { capture: true });
      btn.__prestige_clear_rewired = true;
    });
  }

  // run wiring now and re-run briefly to catch dynamic DOM
  renderDeleteControls();
  wireClearButtonsToArchiveOnly();
  const scanInterval = setInterval(() => { renderDeleteControls(); wireClearButtonsToArchiveOnly(); }, 1000);
  setTimeout(() => clearInterval(scanInterval), 30000);

  // expose API
  window.Prestige = window.Prestige || {};
  window.Prestige.archive = window.Prestige.archive || {};
  Object.assign(window.Prestige.archive, {
    deleteItem: deleteArchiveItem,
    renderDeleteControls: renderDeleteControls,
    clearArchiveOnly: doClearArchiveOnly
  });

})();
  
  
  
</script>


    
    
  

</body>
</html>
